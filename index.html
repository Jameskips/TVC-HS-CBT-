<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (Complete Edition)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { 
      font-family: Arial, sans-serif; margin: 0; color:#222; background: #c3e0ff;
      background: linear-gradient(135deg, #c3e0ff 0%, #d8f0ff 100%);
      background-attachment: fixed; min-height: 100vh; display: flex; flex-direction: column;
    }
    .wrap { max-width:1100px; margin: 18px auto; flex-grow: 1; padding: 0 10px; }
    header h1 { margin: 4px 0 18px; font-size:24px; color:#1a237e; font-weight: bold; }
    .card { 
      background:#fff; border:1px solid #e6e9ee; border-radius:16px; padding:20px; 
      margin-bottom:20px; box-shadow:0 6px 20px rgba(0,0,0,0.08); 
    }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    input, select, textarea, button { font-family: inherit; font-size:15px; padding:12px; border-radius:10px; border:1px solid #dfe6ef; }
    button { cursor:pointer; border:0; font-weight: 600; transition: 0.2s; }
    button.primary { background:#246bff; color:#fff; }
    button.danger { background:#e53935; color:#fff; }
    button.muted { background:#f0f3f8; color:#222; }
    button.success { background:#2e7d32; color:#fff; }
    .hidden { display:none; }
    .timer { font-weight:700; color:#e53935; }
    .exam-option { padding:16px; border:1px solid #d9e2ef; border-radius:10px; cursor:pointer; margin-bottom:8px; }
    .exam-option.selected { background:#e8f0ff; border-color: #246bff; }
    .exam-option.correct-ans { background: #e8f5e9; border-color: #4caf50; border-width: 2px; }
    .exam-option.wrong-ans { background: #ffebee; border-color: #ef5350; border-width: 2px; }
    .qkeys { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .qkey { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border:1px solid #d9e3f5; border-radius:8px; cursor:pointer; }
    .qkey.active { background:#246bff; color:#fff; }
    .qkey.answered { background:#eaf3ff; border-color:#cfe3ff; }
    .qkey.correct { background:#4caf50; color:#fff; border:none; }
    .qkey.wrong { background:#ef5350; color:#fff; border:none; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px; border:1px solid #eef2f6; text-align:left; }
    .violation-tag { color: #e53935; font-weight: bold; }
    @media print { .no-print { display:none !important; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="no-print"><h1>TVC High School — CBT</h1></header>

    <div id="loginCard" class="card no-print">
      <div id="loginView">
        <h2>Student Login</h2>
        <div class="row">
          <input id="loginUser" placeholder="Username" />
          <input id="loginClass" placeholder="Class (e.g. JSS1)" />
          <input id="loginPass" type="password" placeholder="Password" />
          <button id="btnLogin" class="primary">Login</button>
        </div>
        <p class="muted">New student? <a href="#" id="linkToReg">Register here</a></p>
      </div>

      <div id="registerView" class="hidden">
        <h2>Register Account</h2>
        <div class="row">
          <input id="regFullName" placeholder="Full Name" />
          <input id="regUser" placeholder="Username" />
          <input id="regClass" placeholder="Class" />
          <input id="regPass" type="password" placeholder="Password" />
          <input id="regCode" type="password" placeholder="School Access Code" />
          <button id="btnDoRegister" class="primary">Register</button>
        </div>
        <a href="#" id="linkToLog">Back to Login</a>
      </div>
    </div>

    <div id="adminCard" class="card hidden no-print">
      <h2>Admin Dashboard <button id="btnLogoutAdmin" class="muted" style="float:right">Logout</button></h2>
      <table>
        <thead>
          <tr><th>Student</th><th>Class</th><th>Subject</th><th>Score</th><th>Violations</th><th>Action</th></tr>
        </thead>
        <tbody id="resultsTbody"></tbody>
      </table>
    </div>

    <div id="studentCard" class="card hidden no-print">
      <h2 id="studentHeader"></h2>
      <div class="row">
        <select id="studentSubjectDropdown"></select>
        <button id="btnStartExam" class="primary">Start Exam</button>
        <button id="btnReviewLast" class="success hidden">Review Last Result</button>
        <button id="btnLogoutStudent" class="muted">Logout</button>
      </div>

      <div id="examCard" class="card hidden">
        <div class="row" style="justify-content:space-between">
          <h3 id="examSubjectTitle"></h3>
          <div id="timerContainer" class="timer">Time: <span id="examTimer">--:--</span></div>
          <div id="reviewTitle" class="hidden" style="color:#2e7d32; font-weight:bold;">REVIEW MODE</div>
        </div>
        <div id="examQuestionBox"></div>
        <div class="row">
          <button id="btnPrevQ">Previous</button>
          <button id="btnNextQ" class="primary">Next</button>
          <button id="btnExitReview" class="muted hidden">Close Review</button>
          <button id="btnSubmitExam" class="danger hidden">Submit</button>
        </div>
        <div id="questionKeys" class="qkeys"></div>
      </div>
    </div>
  </div>

<script>
const JSONBIN_MASTER_KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const JSONBIN_BIN_ID = "68bc605c43b1c97be9391c1d";
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
const REG_CODE = "TVC2026";

let db = { subjects: [], questions: [], students: [], scores: [] };
let currentUser = null, examState = null, examInterval = null, violationCount = 0;
let isReviewMode = false;

async function loadDB(){
  const resp = await fetch(`${JSONBIN_URL}/latest`, { headers: { "X-Master-Key": JSONBIN_MASTER_KEY } });
  const data = await resp.json();
  if (data.record) db = data.record;
}
async function saveDB(){
  await fetch(JSONBIN_URL, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "X-Master-Key": JSONBIN_MASTER_KEY },
    body: JSON.stringify(db)
  });
}

/* Anti-Cheat */
document.addEventListener("visibilitychange", () => { if (examState && !isReviewMode && document.visibilityState === 'hidden') handleViolation("Tab Switched"); });
window.onblur = () => { if (examState && !isReviewMode) handleViolation("Lost Focus"); };
function handleViolation(reason) {
    violationCount++; examState.violations = violationCount;
    alert(`SECURITY ALERT #${violationCount}\nIncident logged.`);
    if (violationCount >= 3) finalizeExam();
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* Auth */
document.getElementById("linkToReg").onclick = () => { document.getElementById("loginView").classList.add("hidden"); document.getElementById("registerView").classList.remove("hidden"); };
document.getElementById("linkToLog").onclick = () => { document.getElementById("registerView").classList.add("hidden"); document.getElementById("loginView").classList.remove("hidden"); };
document.getElementById("btnDoRegister").onclick = async () => {
    const user = document.getElementById("regUser").value.trim();
    if(document.getElementById("regCode").value.trim() !== REG_CODE) return alert("Wrong school code.");
    await loadDB();
    db.students.push({ id: Date.now().toString(36), username: user, name: document.getElementById("regFullName").value, class: document.getElementById("regClass").value.toUpperCase(), password: document.getElementById("regPass").value });
    await saveDB(); alert("Success!"); document.getElementById("linkToLog").click();
};

document.getElementById("btnLogin").onclick = async () => {
  const user = document.getElementById("loginUser").value.trim(), pass = document.getElementById("loginPass").value.trim();
  await loadDB();
  if(user === "admin" && pass === "admin") {
    currentUser = { role: "admin" }; document.getElementById("loginCard").classList.add("hidden"); document.getElementById("adminCard").classList.remove("hidden"); renderResults(); return;
  }
  const s = db.students.find(x => x.username === user && x.password === pass);
  if (s) {
    currentUser = s; document.getElementById("loginCard").classList.add("hidden"); document.getElementById("studentCard").classList.remove("hidden");
    document.getElementById("studentHeader").textContent = `Student: ${s.name}`;
    refreshStudentSubs();
  } else alert("Invalid Login.");
};

/* Exam & Review */
function refreshStudentSubs() {
  const sel = document.getElementById("studentSubjectDropdown"); sel.innerHTML = "";
  db.subjects.filter(x => x.class === currentUser.class).forEach(sub => {
    const score = db.scores.find(sc => sc.studentId === currentUser.id && sc.subjectId === sub.id);
    sel.innerHTML += `<option value="${sub.id}" ${score?'disabled':''}>${sub.name} ${score?'(Done)':''}</option>`;
    if(score) document.getElementById("btnReviewLast").classList.remove("hidden");
  });
}

document.getElementById("btnReviewLast").onclick = () => {
  const subId = document.getElementById("studentSubjectDropdown").value;
  const scoreData = db.scores.find(sc => sc.studentId === currentUser.id && sc.subjectId === subId);
  if(!scoreData) return alert("Please select a completed subject from the dropdown to review.");
  
  isReviewMode = true;
  examState = { sub: {name: scoreData.subject}, qs: scoreData.shuffledQs, answers: scoreData.answers, index: 0 };
  document.getElementById("examCard").classList.remove("hidden");
  document.getElementById("timerContainer").classList.add("hidden");
  document.getElementById("reviewTitle").classList.remove("hidden");
  document.getElementById("btnExitReview").classList.remove("hidden");
  document.getElementById("btnNextQ").classList.remove("hidden");
  renderQ();
};

document.getElementById("btnExitReview").onclick = () => location.reload();

document.getElementById("btnStartExam").onclick = () => {
  const subId = document.getElementById("studentSubjectDropdown").value;
  const sub = db.subjects.find(x => x.id === subId);
  const rawQs = db.questions.filter(x => x.subjectId === subId);
  if(!rawQs.length) return alert("No questions.");
  
  isReviewMode = false;
  const shuffledQs = shuffleArray([...rawQs]);
  violationCount = 0;
  examState = { sub, qs: shuffledQs, answers: Array(shuffledQs.length).fill(null), index: 0, timeLeft: sub.duration * 60, violations: 0 };
  document.getElementById("examCard").classList.remove("hidden");
  startTimer(); renderQ();
};

function renderQ() {
  const q = examState.qs[examState.index];
  const userAns = examState.answers[examState.index];
  
  let html = `<h3>${q.question}</h3>`;
  ['A', 'B', 'C'].forEach(opt => {
    let cls = "exam-option";
    if (!isReviewMode) {
        if(userAns === opt) cls += " selected";
    } else {
        if(opt === q.correct) cls += " correct-ans";
        else if(userAns === opt && userAns !== q.correct) cls += " wrong-ans";
    }
    html += `<div class="${cls}" onclick="${isReviewMode?'':'setA(\''+opt+'\')'}">${opt}. ${q[opt]}</div>`;
  });
  
  document.getElementById("examQuestionBox").innerHTML = html;
  document.getElementById("btnSubmitExam").classList.toggle("hidden", isReviewMode || examState.index !== examState.qs.length - 1);
  renderKeys();
}

window.setA = (a) => { examState.answers[examState.index] = a; renderQ(); };

function renderKeys() {
  const k = document.getElementById("questionKeys"); k.innerHTML = "";
  examState.qs.forEach((q, i) => {
    let c = examState.index === i ? 'active' : '';
    if(isReviewMode) {
        c += (examState.answers[i] === q.correct) ? ' correct' : ' wrong';
    } else if (examState.answers[i]) {
        c += ' answered';
    }
    k.innerHTML += `<div class="qkey ${c}" onclick="examState.index=${i};renderQ()">${i+1}</div>`;
  });
}

function startTimer() {
  examInterval = setInterval(() => {
    examState.timeLeft--;
    const m = Math.floor(examState.timeLeft/60), s = examState.timeLeft%60;
    document.getElementById("examTimer").textContent = `${m}:${s<10?'0':''}${s}`;
    if(examState.timeLeft <= 0) finalizeExam();
  }, 1000);
}

async function finalizeExam() {
  clearInterval(examInterval);
  let score = 0;
  examState.qs.forEach((q, i) => { if(examState.answers[i] === q.correct) score += Number(examState.sub.marksPerQuestion); });
  db.scores.push({ 
    studentId: currentUser.id, subjectId: examState.sub.id, subject: examState.sub.name, 
    score, totalMarks: examState.qs.length * examState.sub.marksPerQuestion, 
    violations: examState.violations || 0,
    answers: examState.answers,
    shuffledQs: examState.qs // Save order for review
  });
  await saveDB(); alert("Submitted!"); location.reload();
}

function renderResults() {
  const tbody = document.getElementById("resultsTbody"); tbody.innerHTML = "";
  db.scores.forEach(s => {
    const st = db.students.find(x => x.id === s.studentId);
    if(!st) return;
    tbody.innerHTML += `<tr><td>${st.name}</td><td>${st.class}</td><td>${s.subject}</td><td>${s.score}/${s.totalMarks}</td><td>${s.violations||0}</td><td><button onclick="alert('Viewed by Admin')">View</button></td></tr>`;
  });
}
loadDB();
</script>
</body>
</html>
