<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (JSONBin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f4f6fb;margin:0;padding:0}
    header{background:#0d6efd;color:#fff;padding:14px;text-align:center}
    .wrap{max-width:1000px;margin:18px auto;padding:12px}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(13,18,30,0.06);margin-bottom:14px}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{width:100%;padding:8px;border:1px solid #d6d9e6;border-radius:6px;margin:6px 0}
    button{padding:8px 12px;border-radius:6px;border:0;background:#0d6efd;color:#fff;cursor:pointer}
    button.danger{background:#dc3545}
    button.muted{background:#e9ecef;color:#111}
    .row{display:flex;gap:10px;align-items:center}
    .row.col{flex-direction:column}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eef2f6;padding:8px;text-align:left}
    th{background:#f1f5ff}
    .muted{color:#666;font-size:13px}
    @media(max-width:800px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header><h1>The Valued Child (TVC) High School — CBT</h1></header>
  <div class="wrap">

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row" style="gap:8px">
        <input id="loginUser" placeholder="Username (admin or student username)" />
        <input id="loginPass" placeholder="Password" type="password" />
        <button id="btnLogin">Login</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- ADMIN UI -->
    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Admin Dashboard</h2>
        <div class="row">
          <button id="btnSaveBin" class="muted">Save to JSONBin</button>
          <button id="btnReloadBin" class="muted">Reload from JSONBin</button>
          <button id="btnLogoutAdmin" class="muted">Logout</button>
        </div>
      </div>

      <div class="row" style="gap:16px;margin-top:12px">
        <!-- Subjects -->
        <div style="flex:1">
          <div class="card">
            <h3>Subjects</h3>
            <div class="row">
              <input id="newSubjectInput" placeholder="New subject name" />
              <button id="btnAddSubject">Add</button>
            </div>
            <table><thead><tr><th>Subject</th><th style="width:160px">Actions</th></tr></thead>
              <tbody id="subjectsTbody"></tbody></table>
          </div>
        </div>

        <!-- Questions -->
        <div style="flex:2">
          <div class="card">
            <h3>Questions (selected subject)</h3>
            <div class="row">
              <select id="subjectSelectForQuestions"></select>
              <button id="btnLoadQuestions" class="muted">Load</button>
            </div>

            <div style="margin-top:10px">
              <h4 id="qFormTitle">Add New Question</h4>
              <textarea id="qText" placeholder="Question text"></textarea>
              <div class="row">
                <input id="qA" placeholder="Option A" />
                <input id="qB" placeholder="Option B" />
              </div>
              <div class="row">
                <input id="qC" placeholder="Option C" />
                <input id="qD" placeholder="Option D" />
              </div>
              <div class="row">
                <select id="qAnswer"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                <button id="btnAddQuestion">Add Question</button>
                <button id="btnCancelEdit" class="muted" style="display:none">Cancel Edit</button>
              </div>
            </div>

            <h4 style="margin-top:12px">Existing Questions</h4>
            <table><thead><tr><th>#</th><th>Question</th><th>Answer</th><th style="width:200px">Actions</th></tr></thead>
              <tbody id="questionsTbody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- Students & Scores -->
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <h3>Students</h3>
          <div class="row">
            <button id="btnExportStudents" class="muted">Export CSV</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4>Add student (full version)</h4>
            <input id="stuUsername" placeholder="Username (unique)" />
            <input id="stuFullName" placeholder="Full name" />
            <input id="stuClass" placeholder="Class (e.g. JSS1)" />
            <input id="stuPassword" placeholder="Password" />
            <div class="row">
              <button id="btnAddStudent">Add Student</button>
              <button id="btnCancelStudentEdit" class="muted" style="display:none">Cancel Edit</button>
            </div>
          </div>

          <div>
            <h4>Registered students</h4>
            <table>
              <thead><tr><th>Username</th><th>Full Name</th><th>Class</th><th style="width:180px">Actions</th></tr></thead>
              <tbody id="studentsTbody"></tbody>
            </table>
          </div>
        </div>

        <h3 style="margin-top:12px">Results</h3>
        <table>
          <thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead>
          <tbody id="resultsTbody"></tbody>
        </table>

      </div>
    </div>

    <!-- STUDENT UI -->
    <div id="studentCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Student Panel — <span id="studentNameDisplay"></span></h2>
        <div class="row"><button id="btnLogoutStudent" class="muted">Logout</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Available Subjects</h3>
        <select id="studentSubjectSelect"></select>
        <div class="row" style="margin-top:8px">
          <div class="muted">Exam duration (seconds)</div>
          <input id="examDurationInput" type="number" value="60" style="width:120px" />
          <button id="btnStartExam">Start Exam</button>
        </div>
      </div>

      <div id="examCard" class="card hidden">
        <h3 id="examTitle">Exam</h3>
        <div class="row"><div class="muted">Time left:</div><div id="examTimer" class="muted"></div></div>
        <form id="examForm"></form>
        <div class="row" style="margin-top:10px">
          <button id="btnSubmitExam">Submit</button>
          <button id="btnCancelExam" class="muted">Cancel</button>
        </div>
      </div>
    </div>

    <div id="status" class="muted" style="margin-top:8px"></div>
  </div>

<script>
/* ============================
   CONFIG: JSONBin credentials
   REPLACE THESE with your bin ID and API key
   ============================ */
const BIN_ID = "68b390e2d0ea881f406c6e1b";      // ← paste your JSONBin bin id here
const API_KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";    // ← paste your JSONBin X-Master-Key here

/* ============================
   Local fallback state (used if bin not available)
   ============================ */
let db = {
  subjects: [{id:1,name:"Mathematics"},{id:2,name:"English"}],
  questions: [
    {id:101, subjectId:1, question:"What is 2 + 2?", options:["1","2","3","4"], answer:3}
  ],
  students: [
    {id:201, username:"student01", name:"John Doe", class:"SS1", password:"pass123"}
  ],
  scores: []
};

/* ============================
   App state
   ============================ */
let currentUser = null; // {role:'admin'} or {role:'student', id, username, name}
let editQuestionIndex = null; // track editing question index/id
let editStudentId = null; // track editing student id

/* ============================
   DOM refs
   ============================ */
const loginUserEl = document.getElementById('loginUser');
const loginPassEl = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const loginMsg = document.getElementById('loginMsg');

const loginCard = document.getElementById('loginCard');
const adminCard = document.getElementById('adminCard');
const studentCard = document.getElementById('studentCard');

const newSubjectInput = document.getElementById('newSubjectInput');
const btnAddSubject = document.getElementById('btnAddSubject');
const subjectsTbody = document.getElementById('subjectsTbody');
const subjectSelectForQuestions = document.getElementById('subjectSelectForQuestions');

const qText = document.getElementById('qText'), qA = document.getElementById('qA'), qB = document.getElementById('qB'), qC = document.getElementById('qC'), qD = document.getElementById('qD'), qAnswer = document.getElementById('qAnswer');
const btnAddQuestion = document.getElementById('btnAddQuestion'), btnCancelEdit = document.getElementById('btnCancelEdit');
const questionsTbody = document.getElementById('questionsTbody');

const stuUsername = document.getElementById('stuUsername'), stuFullName = document.getElementById('stuFullName'), stuClass = document.getElementById('stuClass'), stuPassword = document.getElementById('stuPassword');
const btnAddStudent = document.getElementById('btnAddStudent'), btnCancelStudentEdit = document.getElementById('btnCancelStudentEdit');
const studentsTbody = document.getElementById('studentsTbody');

const resultsTbody = document.getElementById('resultsTbody');

const studentNameDisplay = document.getElementById('studentNameDisplay');
const studentSubjectSelect = document.getElementById('studentSubjectSelect'), btnStartExam = document.getElementById('btnStartExam'), examDurationInput = document.getElementById('examDurationInput');
const examCard = document.getElementById('examCard'), examForm = document.getElementById('examForm'), examTitle = document.getElementById('examTitle'), examTimer = document.getElementById('examTimer');
const btnSubmitExam = document.getElementById('btnSubmitExam'), btnCancelExam = document.getElementById('btnCancelExam');

const btnSaveBin = document.getElementById('btnSaveBin'), btnReloadBin = document.getElementById('btnReloadBin'), btnLogoutAdmin = document.getElementById('btnLogoutAdmin'), btnLogoutStudent = document.getElementById('btnLogoutStudent');
const statusEl = document.getElementById('status');

/* ============================
   JSONBin helpers
   ============================ */
async function loadFromBin(){
  if(!BIN_ID || !API_KEY){ statusEl.textContent = "No BIN_ID/API_KEY — running local-only."; return; }
  statusEl.textContent = "Loading data from JSONBin...";
  try{
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY }});
    if(!res.ok){ statusEl.textContent = `Load failed (${res.status}) — using local fallback.`; return; }
    const j = await res.json();
    if(j && j.record){ db = j.record; statusEl.textContent = "Loaded data from JSONBin."; }
    else{ statusEl.textContent = "JSONBin empty — using local fallback."; }
  }catch(err){
    console.error(err);
    statusEl.textContent = "Error loading bin — running local fallback.";
  }
}

async function saveToBin(){
  if(!BIN_ID || !API_KEY){ statusEl.textContent = "Not saving to JSONBin (missing credentials)."; return; }
  statusEl.textContent = "Saving to JSONBin...";
  try{
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(db)
    });
    if(!res.ok){ statusEl.textContent = `Save failed (${res.status})`; return; }
    statusEl.textContent = "Saved to JSONBin.";
  }catch(err){
    console.error(err);
    statusEl.textContent = "Error saving to JSONBin.";
  }
}

/* ============================
   Initialization
   ============================ */
async function init(){
  // try load bin, otherwise use embedded db fallback
  await loadFromBin();
  renderAllAdminLists();
  bindEvents();
  loginCard.classList.remove('hidden');
  statusEl.textContent = "Ready";
}
init();

/* ============================
   Event bindings
   ============================ */
function bindEvents(){
  btnLogin.addEventListener('click', handleLogin);
  btnAddSubject.addEventListener('click', handleAddSubject);
  document.getElementById('btnLoadQuestions').addEventListener('click', ()=>{ renderQuestionsFor(subjectSelectForQuestions.value); });
  btnAddQuestion.addEventListener('click', handleAddQuestion);
  btnCancelEdit.addEventListener('click', cancelQuestionEdit);
  btnAddStudent.addEventListener('click', handleAddStudent);
  btnCancelStudentEdit.addEventListener('click', cancelStudentEdit);
  btnStartExam.addEventListener('click', ()=>{ startExam(studentSubjectSelect.value, parseInt(examDurationInput.value)||60); });
  btnSubmitExam.addEventListener('click', ()=>{ if(confirm('Submit exam now?')) finalizeExam(); });
  btnCancelExam.addEventListener('click', ()=>{ if(confirm('Cancel exam?')){ clearInterval(window._examTimer); examCard.classList.add('hidden'); } });
  btnSaveBin.addEventListener('click', saveToBin);
  btnReloadBin.addEventListener('click', async()=>{ await loadFromBin(); renderAllAdminLists(); });
  btnLogoutAdmin.addEventListener('click', ()=>{ currentUser=null; adminCard.classList.add('hidden'); loginCard.classList.remove('hidden'); });
  btnLogoutStudent.addEventListener('click', ()=>{ currentUser=null; studentCard.classList.add('hidden'); loginCard.classList.remove('hidden'); });
  document.getElementById('btnExportStudents').addEventListener('click', exportStudentsCSV);
}

/* ============================
   Login handler
   ============================ */
function handleLogin(){
  const u = loginUserEl.value.trim();
  const p = loginPassEl.value;
  if(!u || !p){ loginMsg.textContent = 'Enter username & password'; return; }

  // Admin: fixed credentials
  if(u.toLowerCase() === 'admin' && p === '1234'){
    currentUser = { role:'admin', id:'admin', name:'Administrator' };
    showAdmin();
    return;
  }

  // Student: find registered
  const stu = db.students.find(s => (s.username === u || s.name === u) && s.password === p);
  if(stu){
    currentUser = { role:'student', id: stu.id, username: stu.username, name: stu.name, class: stu.class };
    showStudent();
    return;
  }

  loginMsg.textContent = "Invalid login credentials.";
}

/* ============================
   Admin: Subjects CRUD
   ============================ */
function handleAddSubject(){
  const name = newSubjectInput.value.trim();
  if(!name) return alert('Enter subject name');
  const id = Date.now();
  db.subjects.push({ id, name });
  db.questions = db.questions || [];
  // save to bin automatically for admin convenience
  saveToBin();
  newSubjectInput.value = '';
  renderAllAdminLists();
}

async function editSubject(id){
  const s = db.subjects.find(x => x.id === id);
  if(!s) return;
  const newName = prompt('Edit subject name', s.name);
  if(!newName) return;
  s.name = newName.trim();
  await saveToBin();
  renderAllAdminLists();
}

async function deleteSubject(id){
  if(!confirm('Delete subject and its questions?')) return;
  db.subjects = db.subjects.filter(s => s.id !== id);
  db.questions = (db.questions||[]).filter(q => q.subjectId !== id);
  await saveToBin();
  renderAllAdminLists();
}

function renderSubjectsTable(){
  subjectsTbody.innerHTML = '';
  subjectSelectForQuestions.innerHTML = '';
  db.subjects.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const editBtn = document.createElement('button'); editBtn.className='muted'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> editSubject(s.id);
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteSubject(s.id);
    td.appendChild(editBtn); td.appendChild(delBtn);
    subjectsTbody.appendChild(tr);

    const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name;
    subjectSelectForQuestions.appendChild(opt);
  });
}

/* ============================
   Admin: Questions CRUD
   ============================ */
function handleAddQuestion(){
  const subjId = parseInt(subjectSelectForQuestions.value);
  if(!subjId) return alert('Select subject first');
  const text = qText.value.trim(), A=qA.value.trim(), B=qB.value.trim(), C=qC.value.trim(), D=qD.value.trim(), ans=qAnswer.value;
  if(!text || !A || !B || !C || !D) return alert('Fill question and all options');
  db.questions = db.questions || [];
  if(editQuestionIndex){
    // update existing
    const q = db.questions.find(x => x.id === editQuestionIndex);
    if(!q) return;
    q.question = text; q.options = [A,B,C,D]; q.answer = ['A','B','C','D'].indexOf(ans) >= 0 ? ans : ans;
    editQuestionIndex = null;
    document.getElementById('qFormTitle').textContent = 'Add New Question';
    btnCancelEdit.style.display = 'none';
  } else {
    const id = Date.now();
    db.questions.push({ id, subjectId:subjId, question:text, options:[A,B,C,D], answer: ['A','B','C','D'].indexOf(ans) >=0 ? ['A','B','C','D'].indexOf(ans) : 0 });
  }
  saveToBin();
  clearQuestionForm();
  renderQuestionsFor(subjId);
}

function renderQuestionsFor(subjectId){
  questionsTbody.innerHTML = '';
  (db.questions || []).filter(q => q.subjectId === parseInt(subjectId)).forEach((q, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${q.question}</td><td>${q.options[q.answer]||''}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const editBtn = document.createElement('button'); editBtn.className='muted'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> startEditQuestion(q.id);
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteQuestion(q.id);
    td.appendChild(editBtn); td.appendChild(delBtn);
    questionsTbody.appendChild(tr);
  });
}

function startEditQuestion(qid){
  const q = (db.questions||[]).find(x=>x.id===qid);
  if(!q) return;
  editQuestionIndex = qid;
  document.getElementById('qFormTitle').textContent = 'Edit Question';
  qText.value = q.question; qA.value = q.options[0]||''; qB.value = q.options[1]||''; qC.value = q.options[2]||''; qD.value = q.options[3]||'';
  qAnswer.value = ['A','B','C','D'][q.answer] || 'A';
  btnCancelEdit.style.display = 'inline-block';
}

async function deleteQuestion(qid){
  if(!confirm('Delete this question?')) return;
  db.questions = (db.questions||[]).filter(x => x.id !== qid);
  await saveToBin();
  renderAllAdminLists();
}

function cancelQuestionEdit(){
  editQuestionIndex = null;
  document.getElementById('qFormTitle').textContent = 'Add New Question';
  btnCancelEdit.style.display = 'none';
  clearQuestionForm();
}

function clearQuestionForm(){ qText.value=''; qA.value=''; qB.value=''; qC.value=''; qD.value=''; qAnswer.value='A'; }

/* ============================
   Admin: Students CRUD (full)
   ============================ */
function handleAddStudent(){
  const username = stuUsername.value.trim();
  const name = stuFullName.value.trim();
  const cls = stuClass.value.trim();
  const pass = stuPassword.value;
  if(!username || !name || !pass) return alert('Fill username, full name and password');
  // new or edit?
  if(editStudentId){
    // update
    const s = db.students.find(x => x.id === editStudentId);
    if(!s) return;
    s.username = username; s.name = name; s.class = cls; s.password = pass;
    editStudentId = null; btnCancelStudentEdit.style.display='none';
  } else {
    if(db.students.find(x => x.username === username)) return alert('Username already exists');
    db.students.push({ id: Date.now(), username, name, class: cls, password: pass });
  }
  saveToBin();
  clearStudentForm();
  renderStudents();
}

function renderStudents(){
  studentsTbody.innerHTML = '';
  (db.students || []).forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.username}</td><td>${s.name}</td><td>${s.class||''}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const editBtn = document.createElement('button'); editBtn.className='muted'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> startEditStudent(s.id);
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteStudent(s.id);
    td.appendChild(editBtn); td.appendChild(delBtn);
    studentsTbody.appendChild(tr);
  });
}

function startEditStudent(id){
  const s = db.students.find(x => x.id === id); if(!s) return;
  editStudentId = id; stuUsername.value = s.username; stuFullName.value = s.name; stuClass.value = s.class || ''; stuPassword.value = s.password;
  btnCancelStudentEdit.style.display='inline-block';
}

async function deleteStudent(id){
  if(!confirm('Delete this student?')) return;
  db.students = (db.students||[]).filter(s=>s.id!==id);
  await saveToBin();
  renderAllAdminLists();
}

function cancelStudentEdit(){
  editStudentId = null; clearStudentForm(); btnCancelStudentEdit.style.display='none';
}
function clearStudentForm(){ stuUsername.value=''; stuFullName.value=''; stuClass.value=''; stuPassword.value=''; }

/* Export students CSV */
function exportStudentsCSV(){
  if(!db.students?.length) return alert('No students');
  let csv = 'username,fullName,class\n';
  db.students.forEach(s=> csv += `${s.username},"${s.name}",${s.class||''}\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='students.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

/* ============================
   Admin: Results view (read-only)
   ============================ */
function renderResults(){
  resultsTbody.innerHTML = '';
  (db.scores || []).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.student}</td><td>${r.subject}</td><td>${r.score}</td><td>${r.date||''}</td>`;
    resultsTbody.appendChild(tr);
  });
}

/* ============================
   Student UI & Exam flow
   ============================ */
function showAdmin(){
  loginCard.classList.add('hidden'); adminCard.classList.remove('hidden');
  renderAllAdminLists();
}
function showStudent(){
  loginCard.classList.add('hidden'); studentCard.classList.remove('hidden');
  studentNameDisplay.textContent = currentUser.name;
  populateStudentSubjects();
}

function renderAllAdminLists(){
  renderSubjectsTable(); renderStudents(); renderResults(); populateStudentSubjects();
  // render questions for first subject if exists
  subjectSelectForQuestions.value = db.subjects[0]?.id || '';
  renderQuestionsFor(subjectSelectForQuestions.value);
}

function populateStudentSubjects(){
  studentSubjectSelect.innerHTML = '';
  (db.subjects||[]).forEach(s => {
    const opt = document.createElement('option'); opt.value=s.id; opt.textContent = s.name; studentSubjectSelect.appendChild(opt);
  });
}

/* Start exam */
function startExam(subjectId, durationSec){
  // subjectId might be string from select
  const sid = parseInt(subjectId);
  const qs = (db.questions || []).filter(q => q.subjectId === sid);
  if(!qs.length) return alert('No questions for this subject');
  // prepare UI
  examTitle.textContent = db.subjects.find(s=>s.id===sid)?.name || 'Exam';
  examForm.innerHTML=''; examCard.classList.remove('hidden');
  qs.forEach((q, i) => {
    const div = document.createElement('div'); div.className='question';
    div.innerHTML = `<p><strong>Q${i+1}.</strong> ${q.question}</p>
      <label><input type="radio" name="q${i}" value="0"> ${q.options[0]||''}</label><br>
      <label><input type="radio" name="q${i}" value="1"> ${q.options[1]||''}</label><br>
      <label><input type="radio" name="q${i}" value="2"> ${q.options[2]||''}</label><br>
      <label><input type="radio" name="q${i}" value="3"> ${q.options[3]||''}</label><br>`;
    examForm.appendChild(div);
  });
  // timer
  let timeLeft = durationSec || 60;
  examTimer.textContent = formatTime(timeLeft);
  clearInterval(window._examTimer);
  window._examTimer = setInterval(() => {
    timeLeft--; examTimer.textContent = formatTime(timeLeft);
    if(timeLeft <= 0){ clearInterval(window._examTimer); finalizeExam(sid); }
  },1000);
}

/* Format mm:ss */
function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

/* Finalize exam (auto or manual submit) */
function finalizeExam(subjectId){
  clearInterval(window._examTimer);
  // compute score against questions for the subject
  const qs = (db.questions||[]).filter(q => q.subjectId === parseInt(subjectId));
  let correct = 0;
  qs.forEach((q,i) => {
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    if(sel && parseInt(sel.value) === q.answer) correct++;
  });
  // record
  db.scores = db.scores || [];
  const subjName = db.subjects.find(s=>s.id===parseInt(subjectId))?.name || '';
  db.scores.push({ student: currentUser.username, studentId: currentUser.id, subject: subjName, score: correct, total: qs.length, date: new Date().toLocaleString() });
  saveToBin();
  examCard.classList.add('hidden');
  alert('Exam submitted. Your score has been recorded (visible to admin only).');
  renderResults();
}

/* ============================
   Utility
   ============================ */
function renderQuestionsFor(subjectId){
  if(!subjectId) { questionsTbody.innerHTML=''; return; }
  renderQuestionsForImpl(parseInt(subjectId));
}
function renderQuestionsForImpl(subjectId){
  questionsTbody.innerHTML = '';
  (db.questions || []).filter(q => q.subjectId === subjectId).forEach((q, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${q.question}</td><td>${q.options[q.answer]||''}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const editBtn = document.createElement('button'); editBtn.className='muted'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> { startEditQuestion(q.id); };
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> { deleteQuestion(q.id); };
    td.appendChild(editBtn); td.appendChild(delBtn);
    questionsTbody.appendChild(tr);
  });
}

/* Start editing a question: populate form */
function startEditQuestion(qid){
  const q = (db.questions||[]).find(x=>x.id===qid); if(!q) return;
  editQuestionIndex = qid;
  document.getElementById('qFormTitle').textContent = 'Edit Question';
  qText.value = q.question; qA.value = q.options[0]||''; qB.value = q.options[1]||''; qC.value = q.options[2]||''; qD.value = q.options[3]||'';
  qAnswer.value = ['A','B','C','D'][q.answer] || 'A';
  btnCancelEdit.style.display = 'inline-block';
  // ensure the subject select is set to the question's subject
  subjectSelectForQuestions.value = q.subjectId;
}

/* ============================
   Render everything (helper)
   ============================ */
function renderAllAdminLists(){
  renderSubjectsTable();
  renderStudents();
  renderResults();
  // ensure question list shown for selected subject
  const selVal = subjectSelectForQuestions.value || (db.subjects[0] && db.subjects[0].id);
  if(selVal) renderQuestionsFor(selVal);
  populateStudentSubjects();
}

/* Expose global helper */
function renderAllAdminListsWrapper(){ renderAllAdminLists(); }

/* ============================
   Start
   ============================ */
/* init already called at top */

</script>
</body>
</html>
