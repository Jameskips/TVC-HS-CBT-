<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TVC High School | Enterprise CBT</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #334155; --muted: #64748b; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* NAVIGATION TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: var(--muted); border-radius: 8px; transition: 0.2s; }
        .tab.active { background: var(--accent); color: white; }

        /* CARDS */
        .card { background: var(--card); border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* FORM ELEMENTS */
        .input-group { position: relative; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box; transition: 0.2s; outline: none; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .eye { position: absolute; right: 12px; top: 12px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--accent); }

        button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--accent); color: white; width: 100%; }
        .btn-outline { background: #f1f5f9; color: var(--text); }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 11px; color: var(--muted); text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .scroll { max-height: 400px; overflow-y: auto; }

        /* EXAM STYLES */
        .exam-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .opt { padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .opt.selected { border-color: var(--accent); background: #eff6ff; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0; font-size:24px; color:var(--primary)">TVC HIGH SCHOOL PORTAL</h1>
        <div id="statusBadge" class="hidden" style="background:#dcfce7; color:#166534; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:bold;">CONNECTED</div>
    </div>

    <div id="authPanel" style="max-width:400px; margin: 40px auto;">
        <div id="loginForm" class="card">
            <h2 style="margin-top:0">Sign In</h2>
            <input id="lUser" placeholder="Username" style="margin-bottom:10px">
            <input id="lClass" placeholder="Class (e.g. JSS1)" style="margin-bottom:10px">
            <div class="input-group">
                <input id="lPass" type="password" placeholder="Password">
                <span class="eye" onclick="viewPass('lPass')">SHOW</span>
            </div>
            <button onclick="handleLogin()" class="btn-primary">Enter Portal</button>
            <p style="text-align:center; font-size:13px; margin-top:20px">New Student? <a href="#" onclick="showReg(true)">Register Here</a></p>
        </div>

        <div id="regForm" class="card hidden">
            <h2 style="margin-top:0">Create Account</h2>
            <input id="rName" placeholder="Full Name" style="margin-bottom:10px">
            <input id="rUser" placeholder="Username" style="margin-bottom:10px">
            <input id="rClass" placeholder="Class (e.g. JSS1)" style="margin-bottom:10px">
            <div class="input-group">
                <input id="rPass" type="password" placeholder="Password">
                <span class="eye" onclick="viewPass('rPass')">SHOW</span>
            </div>
            <input id="rCode" type="password" placeholder="Access Code (TVC2026)" style="margin-bottom:15px">
            <button onclick="handleReg()" class="btn-primary">Register Now</button>
            <p style="text-align:center; font-size:13px; margin-top:15px"><a href="#" onclick="showReg(false)">Back to Login</a></p>
        </div>
    </div>

    <div id="adminPanel" class="hidden">
        <div class="tabs">
            <div class="tab active" onclick="switchTab(event, 'stuTab')">Students</div>
            <div class="tab" onclick="switchTab(event, 'subTab')">Subjects & Bulk</div>
            <div class="tab" onclick="switchTab(event, 'resTab')">Results</div>
            <button onclick="location.reload()" class="btn-danger" style="margin-left:auto; padding:5px 15px">Logout</button>
        </div>

        <div id="stuTab" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <h3 style="margin:0">Student Database</h3>
                    <span id="stuCount" style="font-weight:bold; color:var(--accent)">0 Students</span>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:15px">
                    <input id="stuSearch" placeholder="Search by name..." onkeyup="filterStudents()" style="flex:2">
                    <select id="clsFilter" onchange="filterStudents()" style="flex:1">
                        <option value="">All Classes</option>
                        <option value="JSS1">JSS1</option><option value="JSS2">JSS2</option><option value="JSS3">JSS3</option>
                    </select>
                </div>
                <div class="scroll">
                    <table><thead><tr><th>Name</th><th>Class</th><th>Username</th><th>Action</th></tr></thead><tbody id="stuList"></tbody></table>
                </div>
            </div>
        </div>

        <div id="subTab" class="tab-content hidden">
            <div class="grid">
                <div class="card">
                    <h3>Create Subject</h3>
                    <input id="nSub" placeholder="Subject Name">
                    <input id="nCls" placeholder="Class" style="margin-top:10px">
                    <div style="display:flex; gap:10px; margin-top:10px">
                        <input id="nDur" type="number" placeholder="Mins">
                        <input id="nMrk" type="number" placeholder="Marks/Q">
                    </div>
                    <button onclick="addSubject()" class="btn-primary" style="margin-top:15px">Save Subject</button>
                </div>
                <div class="card">
                    <h3>Bulk Question Upload</h3>
                    <select id="subSel"></select>
                    <textarea id="bulkData" placeholder="Question, OptA, OptB, OptC, CorrectLetter" style="height:80px; margin-top:10px"></textarea>
                    <button onclick="processBulk()" class="btn-primary" style="margin-top:10px; background:var(--success)">Upload Questions</button>
                </div>
            </div>
            <div class="card">
                <h3>Subject Registry</h3>
                <table><thead><tr><th>Subject</th><th>Class</th><th>Status</th><th>Action</th></tr></thead><tbody id="subList"></tbody></table>
            </div>
        </div>

        <div id="resTab" class="tab-content hidden">
            <div class="card">
                <h3>Exam Performance</h3>
                <table><thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Strikes</th></tr></thead><tbody id="resList"></tbody></table>
            </div>
        </div>
    </div>

    <div id="studentPanel" class="hidden">
        <div class="card">
            <h2 id="stuWelcome"></h2>
            <div style="display:flex; gap:10px">
                <select id="availableExams" style="flex:2"></select>
                <button onclick="startExam()" class="btn-primary" style="flex:1">Start Exam</button>
            </div>
        </div>

        <div id="examInterface" class="hidden">
            <div class="exam-grid">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <h3 id="exName"></h3>
                        <h2 id="timer" style="color:var(--danger)">00:00</h2>
                    </div>
                    <hr>
                    <div id="qArea"></div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px">
                        <button onclick="changeQ(-1)" class="btn-outline">Previous</button>
                        <button onclick="changeQ(1)" id="nextBtn" class="btn-primary" style="width:auto">Next Question</button>
                        <button onclick="submitExam()" id="submitBtn" class="btn-danger hidden" style="width:auto">Final Submit</button>
                    </div>
                </div>
                <div class="card">
                    <h4>Navigator</h4>
                    <div id="navMap" style="display:grid; grid-template-columns:repeat(5,1fr); gap:5px"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const BIN = "68bc605c43b1c97be9391c1d";
const URL = `https://api.jsonbin.io/v3/b/${BIN}`;

let db = { students: [], subjects: [], questions: [], scores: [] };
let currentUser = null, activeExam = null, clock = null;

async function load() { 
    const r = await fetch(`${URL}/latest`, { headers: {"X-Master-Key": KEY} }); 
    const d = await r.json(); if(d.record) db = d.record;
    document.getElementById('statusBadge').classList.remove('hidden');
}
async function sync() { await fetch(URL, { method: "PUT", headers: {"Content-Type":"application/json", "X-Master-Key": KEY}, body: JSON.stringify(db) }); }

/* --- AUTH --- */
function showReg(val) { document.getElementById('loginForm').classList.toggle('hidden', val); document.getElementById('regForm').classList.toggle('hidden', !val); }
function viewPass(id) { const x = document.getElementById(id); x.type = x.type === 'password' ? 'text' : 'password'; }

async function handleReg() {
    if(document.getElementById('rCode').value !== "TVC2026") return alert("Invalid Access Code");
    await load();
    db.students.push({ id: Date.now().toString(36), name: document.getElementById('rName').value, username: document.getElementById('rUser').value, class: document.getElementById('rClass').value.toUpperCase(), password: document.getElementById('rPass').value });
    await sync(); alert("Registration Successful!"); showReg(false);
}

async function handleLogin() {
    const u = document.getElementById('lUser').value, p = document.getElementById('lPass').value, c = document.getElementById('lClass').value.toUpperCase();
    await load();
    if(u === "admin" && p === "admin") {
        document.getElementById('authPanel').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        renderAdmin();
    } else {
        const s = db.students.find(x => x.username === u && x.password === p && x.class === c);
        if(s) {
            currentUser = s;
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('studentPanel').classList.remove('hidden');
            document.getElementById('stuWelcome').innerText = `Welcome, ${s.name}`;
            loadStudentExams();
        } else alert("Invalid Login");
    }
}

/* --- ADMIN --- */
function switchTab(e, id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.remove('hidden');
    e.target.classList.add('active');
    renderAdmin();
}

function renderAdmin() {
    // Students
    const sl = document.getElementById('stuList'); sl.innerHTML = "";
    db.students.forEach(s => {
        sl.innerHTML += `<tr><td>${s.name}</td><td>${s.class}</td><td>${s.username}</td><td><button class="btn-danger" onclick="delStu('${s.id}')">Del</button></td></tr>`;
    });
    filterStudents();

    // Subjects
    const subL = document.getElementById('subList'); subL.innerHTML = "";
    const sel = document.getElementById('subSel'); sel.innerHTML = "";
    db.subjects.forEach(sb => {
        subL.innerHTML += `<tr><td>${sb.name}</td><td>${sb.class}</td><td>${sb.released?'Public':'Draft'}</td><td><button onclick="togSub('${sb.id}')">Toggle</button></td></tr>`;
        sel.innerHTML += `<option value="${sb.id}">${sb.name} (${sb.class})</option>`;
    });

    // Results
    const rl = document.getElementById('resList'); rl.innerHTML = "";
    db.scores.forEach(sc => {
        const st = db.students.find(x => x.id === sc.studentId);
        rl.innerHTML += `<tr><td>${st?st.name:'Deleted'}</td><td>${sc.subName}</td><td>${sc.score}</td><td>${sc.strikes}</td></tr>`;
    });
}

function filterStudents() {
    const s = document.getElementById('stuSearch').value.toLowerCase();
    const c = document.getElementById('clsFilter').value;
    const rows = document.getElementById('stuList').getElementsByTagName('tr');
    let count = 0;
    for(let r of rows) {
        const m = r.innerText.toLowerCase().includes(s) && (c==="" || r.cells[1].innerText === c);
        r.style.display = m ? "" : "none";
        if(m) count++;
    }
    document.getElementById('stuCount').innerText = `${count} Students`;
}

async function addSubject() {
    db.subjects.push({ id: Date.now().toString(36), name: document.getElementById('nSub').value, class: document.getElementById('nCls').value.toUpperCase(), duration: document.getElementById('nDur').value, marks: document.getElementById('nMrk').value, released: false });
    await sync(); renderAdmin();
}

async function processBulk() {
    const sid = document.getElementById('subSel').value;
    const lines = document.getElementById('bulkData').value.split('\n');
    lines.forEach(l => {
        const p = l.split(',');
        if(p.length >= 5) db.questions.push({ id: Math.random().toString(36), subjectId: sid, question: p[0], A: p[1], B: p[2], C: p[3], correct: p[4].trim().toUpperCase() });
    });
    await sync(); alert("Uploaded!"); document.getElementById('bulkData').value = "";
}

/* --- STUDENT EXAM --- */
function loadStudentExams() {
    const sel = document.getElementById('availableExams'); sel.innerHTML = "";
    db.subjects.filter(s => s.class === currentUser.class && s.released).forEach(s => {
        if(!db.scores.find(sc => sc.studentId === currentUser.id && sc.subjectId === s.id))
            sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
    if(!sel.innerHTML) sel.innerHTML = "<option>No Exams Available</option>";
}

function startExam() {
    const sid = document.getElementById('availableExams').value;
    const sub = db.subjects.find(s => s.id === sid);
    const qs = db.questions.filter(q => q.subjectId === sid).sort(() => 0.5 - Math.random());
    if(!qs.length) return alert("No questions found.");
    
    activeExam = { sub, qs, answers: Array(qs.length).fill(null), index: 0, timer: sub.duration * 60, strikes: 0 };
    document.getElementById('examInterface').classList.remove('hidden');
    document.getElementById('exName').innerText = sub.name;
    clock = setInterval(tick, 1000);
    renderQuestion();
}

function renderQuestion() {
    const q = activeExam.qs[activeExam.index];
    let html = `<h3>Question ${activeExam.index + 1}</h3><p>${q.question}</p>`;
    ['A','B','C'].forEach(o => {
        html += `<div class="opt ${activeExam.answers[activeExam.index]===o?'selected':''}" onclick="pick('${o}')">${o}. ${q[o]}</div>`;
    });
    document.getElementById('qArea').innerHTML = html;
    document.getElementById('nextBtn').classList.toggle('hidden', activeExam.index === activeExam.qs.length - 1);
    document.getElementById('submitBtn').classList.toggle('hidden', activeExam.index !== activeExam.qs.length - 1);
    
    const nav = document.getElementById('navMap'); nav.innerHTML = "";
    activeExam.qs.forEach((_, i) => {
        nav.innerHTML += `<div onclick="activeExam.index=${i};renderQuestion()" style="padding:5px; text-align:center; cursor:pointer; background:${activeExam.index===i?'var(--accent)':'#eee'}; color:${activeExam.index===i?'#white':'#000'}">${i+1}</div>`;
    });
}

function pick(o) { activeExam.answers[activeExam.index] = o; renderQuestion(); }
function changeQ(dir) { activeExam.index += dir; renderQuestion(); }

function tick() {
    activeExam.timer--;
    let m = Math.floor(activeExam.timer/60), s = activeExam.timer%60;
    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
    if(activeExam.timer <= 0) submitExam();
}

async function submitExam() {
    clearInterval(clock);
    let score = 0;
    activeExam.qs.forEach((q, i) => { if(activeExam.answers[i] === q.correct) score += parseInt(activeExam.sub.marks); });
    db.scores.push({ id: Date.now().toString(36), studentId: currentUser.id, subjectId: activeExam.sub.id, subName: activeExam.sub.name, score: score, strikes: activeExam.strikes });
    await sync(); alert(`Exam Finished! Score: ${score}`); location.reload();
}

document.addEventListener("visibilitychange", () => {
    if(activeExam && document.visibilityState === 'hidden') {
        activeExam.strikes++;
        alert("SECURITY WARNING: Do not leave this tab!");
        if(activeExam.strikes >= 3) submitExam();
    }
});

window.delStu = async (id) => { db.students = db.students.filter(x=>x.id!==id); await sync(); renderAdmin(); };
window.togSub = async (id) => { const s = db.subjects.find(x=>x.id===id); s.released = !s.released; await sync(); renderAdmin(); };

load();
</script>
</body>
</html>
