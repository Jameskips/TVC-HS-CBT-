<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TVC High School CBT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#eef3ff;margin:0}
.card{background:#fff;margin:20px;padding:20px;border-radius:12px}
.hidden{display:none}
button{padding:10px 16px;border:0;border-radius:8px;cursor:pointer}
.primary{background:#246bff;color:#fff}
.danger{background:#e53935;color:#fff}
.timer{color:red;font-weight:bold}
.exam-option{border:1px solid #ccc;padding:12px;margin:8px 0;border-radius:8px;cursor:pointer}
.exam-option.selected{background:#dbe7ff}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h2>Login</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button class="primary" onclick="login()">Login</button>
  <button onclick="register()">Register</button>
  <p id="loginMsg"></p>
</div>

<div class="card hidden" id="studentCard">
  <h3 id="studentName"></h3>
  <select id="subjectSelect"></select>
  <button class="primary" onclick="startExam()">Start Exam</button>
  <button onclick="logout()">Logout</button>

  <div id="examCard" class="hidden">
    <h3 id="examTitle"></h3>
    Time: <span class="timer" id="timer"></span>
    <div id="questionBox"></div>
    <button onclick="prevQ()">Prev</button>
    <button onclick="nextQ()">Next</button>
    <button class="danger" onclick="submitExam()">Submit</button>
  </div>
</div>

<script type="module">
/* ðŸ”¥ const firebaseConfig = {
  apiKey: "AIzaSyAXeQ5pOc0HUrSYK8TTABuPN0Ae02eWwYM",
  authDomain: "tvc-cbt.firebaseapp.com",
  projectId: "tvc-cbt",
  storageBucket: "tvc-cbt.firebasestorage.app",
  messagingSenderId: "527990577172",
  appId: "1:527990577172:web:0828402d6ffb1c50ef2f01"
}; ðŸ”¥ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXeQ5pOc0HUrSYK8TTABuPN0Ae02eWwYM",
  authDomain: "tvc-cbt.firebaseapp.com",
  projectId: "tvc-cbt",
};
/* ðŸ”¥ END CONFIG ðŸ”¥ */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let questions=[], answers=[], index=0, timerInt, timeLeft=0;

/* AUTH */
window.login = async () => {
  try{
    const res = await signInWithEmailAndPassword(auth,email.value,password.value);
    studentName.innerText = res.user.email;
    loginCard.classList.add("hidden");
    studentCard.classList.remove("hidden");
    loadSubjects();
  }catch(e){ loginMsg.innerText=e.message }
};

window.register = async () => {
  try{
    await createUserWithEmailAndPassword(auth,email.value,password.value);
    alert("Registered. Login now.");
  }catch(e){ alert(e.message) }
};

window.logout = ()=>location.reload();

/* LOAD SUBJECTS */
async function loadSubjects(){
  subjectSelect.innerHTML="";
  const snap = await getDocs(collection(db,"subjects"));
  snap.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.id;o.text=d.data().name;
    subjectSelect.appendChild(o);
  });
}

/* EXAM */
window.startExam = async ()=>{
  const sid=subjectSelect.value;
  const q=query(collection(db,"questions"),where("subjectId","==",sid));
  const snap=await getDocs(q);
  questions=[];answers=[];index=0;
  snap.forEach(d=>questions.push(d.data()));
  questions.sort(()=>Math.random()-0.5);
  timeLeft=questions.length*60;
  examCard.classList.remove("hidden");
  renderQ(); startTimer(); enterFullscreen();
};

function renderQ(){
  const q=questions[index];
  questionBox.innerHTML=`
  <h4>${q.question}</h4>
  ${["A","B","C"].map(o=>`
    <div class="exam-option ${answers[index]==o?"selected":""}"
    onclick="answers[${index}]='${o}';renderQ()">
    ${o}. ${q[o]}</div>`).join("")}`;
}

window.nextQ=()=>{if(index<questions.length-1){index++;renderQ()}};
window.prevQ=()=>{if(index>0){index--;renderQ()}};

function startTimer(){
  timerInt=setInterval(()=>{
    timeLeft--;
    timer.innerText=Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,"0");
    if(timeLeft<=0)submitExam();
  },1000);
}

window.submitExam = async ()=>{
  clearInterval(timerInt);
  let score=0;
  questions.forEach((q,i)=>{ if(answers[i]==q.correct) score++; });
  await addDoc(collection(db,"results"),{
    uid:auth.currentUser.uid,
    score, total:questions.length,
    date:new Date()
  });
  alert("Submitted!");
  location.reload();
};

function enterFullscreen(){
  document.documentElement.requestFullscreen?.();
}

document.addEventListener("visibilitychange",()=>{
  if(!document.hidden)return;
  alert("Do not leave exam!");
});
</script>
</body>
</html>


