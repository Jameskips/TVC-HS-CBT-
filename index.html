<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (JSONBin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Keep your original CSS here */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    button.muted { background: #ddd; }
    button.danger { background: #e74c3c; color: #fff; }
  </style>
</head>
<body>
  <header><h1>The Valued Child (TVC) High School — CBT</h1></header>
  <div class="wrap">

    <!-- LOGIN CARD (simplified) -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <input id="loginUser" placeholder="Username" />
      <input id="loginClass" placeholder="Class (e.g. JSS1)" />
      <input id="loginPass" type="password" placeholder="Password" />
      <button id="btnLogin">Login</button>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Admin Dashboard</h2>
        <button id="btnLogoutAdmin" class="muted">Logout</button>
      </div>

      <!-- SUBJECTS -->
      <div class="card">
        <h3>Subjects</h3>
        <div class="row">
          <input id="newSubjectInput" placeholder="New subject name" />
          <input id="newSubjectClassInput" placeholder="Class (e.g. JSS1)" />
          <button id="btnAddSubject">Add</button>
        </div>
        <div class="row">
          <label for="adminClassFilter" class="muted">Filter by Class:</label>
          <select id="adminClassFilter"><option value="all">All Classes</option></select>
        </div>
        <table>
          <thead><tr><th>Subject</th><th>Class</th></tr></thead>
          <tbody id="subjectsTbody"></tbody>
        </table>
      </div>

      <!-- STUDENTS & SCORES -->
      <div class="card">
        <h3>Students & Scores</h3>
        <div class="row">
          <label for="adminStudentClassFilter" class="muted">Filter by Class:</label>
          <select id="adminStudentClassFilter"><option value="all">All Classes</option></select>
        </div>

        <div class="row" style="justify-content:space-between">
          <h4>Students</h4>
          <button id="btnExportStudents" class="muted">Export Students CSV</button>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4>Add student</h4>
            <input id="stuUsername" placeholder="Username" />
            <input id="stuFullName" placeholder="Full name" />
            <input id="stuClass" placeholder="Class (e.g. JSS1)" />
            <input id="stuPassword" placeholder="Password" />
            <button id="btnAddStudent">Add Student</button>
          </div>
          <div>
            <h4>Registered students</h4>
            <table>
              <thead><tr><th>Username</th><th>Full Name</th><th>Class</th></tr></thead>
              <tbody id="studentsTbody"></tbody>
            </table>
          </div>
        </div>

        <h3 style="margin-top:12px">Results</h3>
        <div class="row" style="justify-content:space-between">
          <button id="btnResetScores" class="danger">Reset All Scores</button>
          <button id="btnExportResults" class="muted">Export Results CSV</button>
        </div>
        <table>
          <thead id="resultsThead"></thead>
          <tbody id="resultsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- STUDENT DASHBOARD (placeholder) -->
    <div id="studentCard" class="card hidden">
      <h2>Student Panel</h2>
      <button id="btnLogoutStudent" class="muted">Logout</button>
    </div>
  </div>

<script>
/* ============================
   Demo database
============================ */
let db = {
  subjects: [
    {id:1, name:"Mathematics", class:"JSS1"},
    {id:2, name:"English Language", class:"JSS2"}
  ],
  students: [],
  scores: []
};

/* ============================
   Add Subject
============================ */
document.getElementById("btnAddSubject").onclick = () => {
  const name = newSubjectInput.value.trim();
  const cls = newSubjectClassInput.value.trim();
  if(!name || !cls) return alert("Enter subject name and class");
  db.subjects.push({ id: Date.now(), name, class: cls });
  newSubjectInput.value = ""; newSubjectClassInput.value = "";
  renderSubjects();
};

/* ============================
   Render Subjects (with filter)
============================ */
function renderSubjects(){
  subjectsTbody.innerHTML = "";
  const filter = adminClassFilter.value;
  const classes = [...new Set(db.subjects.map(s=>s.class))];
  adminClassFilter.innerHTML = `<option value="all">All Classes</option>`;
  classes.forEach(c=>{
    adminClassFilter.innerHTML += `<option value="${c}" ${filter===c?"selected":""}>${c}</option>`;
  });
  db.subjects.filter(s=>filter==="all"||s.class===filter).forEach(s=>{
    subjectsTbody.innerHTML += `<tr><td>${s.name}</td><td>${s.class}</td></tr>`;
  });
}
adminClassFilter.onchange = renderSubjects;

/* ============================
   Add Student
============================ */
document.getElementById("btnAddStudent").onclick = () => {
  db.students.push({ id: Date.now(), username: stuUsername.value, name: stuFullName.value, class: stuClass.value });
  stuUsername.value = stuFullName.value = stuClass.value = stuPassword.value = "";
  renderStudents();
};

/* ============================
   Render Students (with filter)
============================ */
function renderStudents(){
  studentsTbody.innerHTML = "";
  const filter = adminStudentClassFilter.value;
  const classes = [...new Set(db.students.map(s=>s.class))];
  adminStudentClassFilter.innerHTML = `<option value="all">All Classes</option>`;
  classes.forEach(c=>{
    adminStudentClassFilter.innerHTML += `<option value="${c}" ${filter===c?"selected":""}>${c}</option>`;
  });
  db.students.filter(s=>filter==="all"||s.class===filter).forEach(s=>{
    studentsTbody.innerHTML += `<tr><td>${s.username}</td><td>${s.name}</td><td>${s.class}</td></tr>`;
  });
}
adminStudentClassFilter.onchange = ()=>{ renderStudents(); renderResults(); };

/* ============================
   Export Students CSV
============================ */
function exportStudentsCSV(){
  const filter = adminStudentClassFilter.value;
  const list = db.students.filter(s=>filter==="all"||s.class===filter);
  if(!list.length) return alert("No students");
  let csv="username,fullName,class\n";
  list.forEach(s=> csv+=`${s.username},"${s.name}",${s.class}\n`);
  downloadCSV(csv, filter==="all"?"students_all.csv":`students_${filter}.csv`);
}
document.getElementById("btnExportStudents").onclick=exportStudentsCSV;

/* ============================
   Export Results CSV (with Total)
============================ */
function exportResultsCSV(){
  const filter = adminStudentClassFilter.value;
  const scoresFiltered = db.scores.filter(sc=>{
    if(filter==="all") return true;
    const st=db.students.find(s=>s.id==sc.studentId);
    return st&&st.class===filter;
  });
  if(!scoresFiltered.length) return alert("No results");
  const students={}, subjects={};
  scoresFiltered.forEach(sc=>{
    const st=db.students.find(s=>s.id==sc.studentId);
    if(st){ students[st.id]={name:st.name,class:st.class}; subjects[sc.subjectId]=sc.subject; }
  });
  const sids=Object.keys(students), subids=Object.keys(subjects);
  let csv="Student,Class"; subids.forEach(sid=>csv+=`,`+subjects[sid]); csv+=",Total\n";
  sids.forEach(sid=>{
    const st=students[sid]; let total=0, row=`"${st.name}",${st.class}`;
    subids.forEach(subid=>{
      const sc=scoresFiltered.find(x=>x.studentId==sid&&x.subjectId==subid);
      const val=sc?sc.score:"N/A"; if(sc) total+=parseFloat(sc.score);
      row+=`,`+val;
    });
    row+=`,`+total; csv+=row+"\n";
  });
  downloadCSV(csv, filter==="all"?"results_all.csv":`results_${filter}.csv`);
}
document.getElementById("btnExportResults").onclick=exportResultsCSV;

/* ============================
   Render Results (with Total)
============================ */
function renderResults(){
  resultsThead.innerHTML=""; resultsTbody.innerHTML="";
  const filter=adminStudentClassFilter.value;
  const scoresFiltered=db.scores.filter(sc=>{
    if(filter==="all") return true;
    const st=db.students.find(s=>s.id==sc.studentId);
    return st&&st.class===filter;
  });
  if(!scoresFiltered.length){ resultsThead.innerHTML="<tr><th>No results</th></tr>"; return; }
  const students={}, subjects={};
  scoresFiltered.forEach(sc=>{ students[sc.studentId]=sc.studentName; subjects[sc.subjectId]=sc.subject; });
  const sids=Object.keys(students), subids=Object.keys(subjects);
  let head="<tr><th>Student</th>"; subids.forEach(id=>head+=`<th>${subjects[id]}</th>`); head+="<th>Total</th></tr>";
  resultsThead.innerHTML=head;
  sids.forEach(sid=>{
    let total=0, row=`<tr><td>${students[sid]}</td>`;
    subids.forEach(subid=>{
      const sc=scoresFiltered.find(x=>x.studentId==sid&&x.subjectId==subid);
      const val=sc?sc.score:"N/A"; if(sc) total+=parseFloat(sc.score);
      row+=`<td>${val}</td>`;
    });
    row+=`<td>${total}</td></tr>`; resultsTbody.innerHTML+=row;
  });
}

/* ============================
   CSV Download Helper
============================ */
function downloadCSV(content, filename){
  const blob=new Blob([content],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
</script>
</body>
</html>
