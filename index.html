<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (Complete)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      color:#222; 
      background: #c3e0ff;
      background: linear-gradient(135deg, #c3e0ff 0%, #d8f0ff 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: radial-gradient(circle at top left, rgba(255,255,255,0.2) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .wrap { 
      max-width:1100px; 
      margin: 18px auto; 
      flex-grow: 1; 
      padding: 0 10px;
    }
    header h1 { 
      margin: 4px 0 18px; 
      font-size:24px; 
      color:#1a237e; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
      font-weight: bold;
    }
    .card { 
      background:#fff; 
      border:1px solid #e6e9ee; 
      border-radius:16px; 
      padding:20px; 
      margin-bottom:20px; 
      box-shadow:0 6px 20px rgba(0,0,0,0.08); 
      transition: box-shadow 0.3s ease;
    }
    .card:hover { box-shadow:0 8-px 24px rgba(0,0,0,0.12); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    input, select, textarea, button { font-family: inherit; font-size:15px; }
    input, select, textarea { 
      padding:12px; 
      border:1px solid #dfe6ef; 
      border-radius:10px; 
      background: #fdfefe;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus { 
      border-color: #246bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(36, 107, 255, 0.1);
    }
    button { 
      padding:12px 20px; 
      border-radius:10px; 
      cursor:pointer; 
      border:0; 
      font-weight: 600; 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    button.primary { background:#246bff; color:#fff; transition: background-color 0.2s; }
    button.primary:hover { background:#1e5be0; }
    button.muted { background:#f0f3f8; color:#222; transition: background-color 0.2s; }
    button.muted:hover { background:#e5e8ec; }
    button.danger { background:#e53935; color:#fff; transition: background-color 0.2s; }
    button.danger:hover { background:#c62828; }
    button.small { padding:8px 16px; font-size:14px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:14px; border:1px solid #eef2f6; text-align:left; vertical-align:middle; }
    th { background:#fafcff; }
    .muted { color:#666; font-size:14px; }
    .hidden { display:none !important; }
    .timer { font-weight:700; color:#e53935; font-size: 1.1em; }
    .exam-option { 
      padding:16px; 
      border:1px solid #d9e2ef; 
      border-radius:10px; 
      cursor:pointer; 
      background:#fdfefe; 
      transition: box-shadow 0.2s, transform 0.2s; 
    }
    .exam-option:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .exam-option.selected { 
      background:#e8f0ff; 
      outline:3px solid rgba(36,107,255,0.12); 
      border-color: #246bff; 
      box-shadow: 0 2px 8px rgba(36, 107, 255, 0.1);
      transform: none;
    }
    .qkeys { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .qkey { 
      width:44px; 
      height:44px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      border:1px solid #d9e3f5; 
      border-radius:10px; 
      cursor:pointer; 
      user-select:none; 
      background:#fff; 
      font-weight:600;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .qkey:hover { background: #f0f3f8; }
    .qkey.active { background:#246bff; color:#fff; border-color:#246bff; }
    .qkey.answered { background:#eaf3ff; color:#0b57ff; border-color:#cfe3ff; }

    /* Accordion CSS */
    .accordion details {
        background:#fff;
        border:1px solid #e6e9ee;
        border-radius:16px;
        margin-bottom:20px;
        box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }
    .accordion summary {
        padding:20px;
        font-size:18px;
        font-weight:bold;
        cursor:pointer;
        user-select:none;
        outline:none;
    }
    .accordion summary::-webkit-details-marker { display:none; }
    .accordion .accordion-content {
        padding:20px;
        border-top:1px solid #e6e9ee;
    }

    /* Print-specific styles */
    @media print {
        body { background: none; color: #000; font-size: 12pt; }
        .wrap, .card { box-shadow: none; border: none; padding: 0; margin: 0; }
        header, .accordion, #studentCard, #loginCard, .row button, .row select, #btnCloseAnswerSheet { display: none !important; }
        #answerSheetCard { display: block !important; }
        #answerSheetCard .row { display: flex; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>The Valued Child (TVC) High School — CBT</h1></header>

    <div id="loginCard" class="card">
      <div id="loginForm">
        <h2>Login</h2>
        <div class="row">
          <input id="loginUser" placeholder="Username" />
          <input id="loginClass" placeholder="Class (e.g. JSS1)" />
          <input id="loginPass" type="password" placeholder="Password" />
          <button id="btnLogin" class="primary">Login</button>
        </div>
        <div class="row">
          <input type="checkbox" id="showLoginPass" onchange="togglePassVisibility('loginPass', this.checked)" />
          <label for="showLoginPass" class="muted">Show password</label>
          <span style="margin: 0 10px; color:#ccc">|</span>
          <a href="#" onclick="toggleAuth(event, 'reg')" style="color:#246bff; text-decoration:none; font-weight:600;">Create Account</a>
        </div>
      </div>

      <div id="registerForm" class="hidden">
        <h2>Student Registration</h2>
        <div class="row">
          <input id="regFullName" placeholder="Full Name" />
          <input id="regUser" placeholder="Choose Username" />
          <select id="regClassSelect">
             <option value="" disabled selected>Select Your Class</option>
          </select>
          <input id="regPass" type="password" placeholder="Create Password" />
          <button id="btnRegister" class="primary">Register</button>
        </div>
        <div class="row">
           <input type="checkbox" onchange="togglePassVisibility('regPass', this.checked)" />
           <label class="muted">Show password</label>
           <span style="margin: 0 10px; color:#ccc">|</span>
           <a href="#" onclick="toggleAuth(event, 'login')" style="color:#246bff; text-decoration:none; font-weight:600;">Already have an account? Login</a>
        </div>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Admin Dashboard</h2>
        <div class="row">
          <button id="btnLogoutAdmin" class="muted">Logout</button>
        </div>
      </div>

      <div class="accordion">
        <details open>
          <summary>Subjects</summary>
          <div class="accordion-content">
            <div class="row">
              <input id="newSubjectInput" placeholder="Subject name" />
              <input id="newSubjectClassInput" placeholder="Class" />
              <input id="newSubjectDuration" type="number" min="1" placeholder="Mins" style="width:100px" />
              <input id="newSubjectMarks" type="number" min="1" placeholder="Marks/Q" style="width:100px" />
              <button id="btnAddSubject" class="primary">Add Subject</button>
            </div>
            <div class="row">
                <label class="muted">Filter by class:</label>
                <select id="subjectClassFilter" onchange="renderSubjects()"></select>
            </div>
            <table>
              <thead><tr><th>Subject</th><th>Class</th><th>Mins</th><th>Marks/Q</th><th>Actions</th></tr></thead>
              <tbody id="subjectsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Questions</summary>
          <div class="accordion-content">
            <div class="row">
              <select id="questionSubjectSelect" style="min-width:260px"></select>
            </div>
            <div class="row" style="flex-direction:column">
              <textarea id="questionText" rows="2" placeholder="Question text" style="width:100%"></textarea>
            </div>
            <div class="row">
              <input id="optionA" placeholder="Option A" />
              <input id="optionB" placeholder="Option B" />
              <input id="optionC" placeholder="Option C" />
              <select id="correctOption"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
              <button id="btnAddQuestion" class="primary">Add Question</button>
            </div>
            <div class="row">
              <select id="questionClassFilter" onchange="refreshQuestionFilterSubjects(); renderQuestions();"></select>
              <select id="questionFilterSubjectSelect" onchange="renderQuestions()"></select>
            </div>
            <table>
              <thead><tr><th>#</th><th>Question</th><th>Ans</th><th>Actions</th></tr></thead>
              <tbody id="questionsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Students</summary>
          <div class="accordion-content">
            <div class="row">
              <input id="stuUsername" placeholder="Username" />
              <input id="stuFullName" placeholder="Full name" />
              <input id="stuClass" placeholder="Class" />
              <input id="stuPassword" type="password" placeholder="Password" />
              <button id="btnAddStudent" class="primary">Add Student</button>
            </div>
            <div class="row">
                <input type="checkbox" onchange="togglePassVisibility('stuPassword', this.checked)" />
                <label class="muted">Show password</label>
                <select id="studentClassFilter" onchange="renderStudents()" style="margin-left:20px"></select>
            </div>
            <table>
              <thead><tr><th>User</th><th>Name</th><th>Class</th><th>Actions</th></tr></thead>
              <tbody id="studentsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Results</summary>
          <div class="accordion-content">
            <div class="row">
              <label class="muted">Filter by class:</label>
              <select id="adminStudentClassFilter" onchange="renderResults()"></select>
            </div>
            <table>
              <thead id="resultsThead"></thead>
              <tbody id="resultsTbody"></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <div id="answerSheetCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2 id="answerSheetHeader">Answer Sheet</h2>
        <button id="btnCloseAnswerSheet" class="muted">Close</button>
      </div>
      <div id="answerSheetContent"></div>
    </div>

    <div id="studentCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2 id="studentHeader">Student Panel</h2>
        <button id="btnLogoutStudent" class="muted">Logout</button>
      </div>

      <div id="subjectPickerCard" class="card">
        <h3>Select Subject</h3>
        <div class="row">
          <select id="studentSubjectDropdown" style="min-width:260px"></select>
          <button id="btnStartExam" class="primary">Start Exam</button>
        </div>
      </div>

      <div id="examCard" class="card hidden">
        <div class="row" style="justify-content:space-between">
          <h3 id="examSubjectTitle"></h3>
          <div>Time left: <span id="examTimer" class="timer">--:--</span></div>
        </div>
        <div id="examQuestionBox" class="card"></div>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="btnPrevQ" class="muted">Previous</button>
            <button id="btnNextQ" class="primary">Next</button>
            <button id="btnSubmitExam" class="danger hidden">Submit Exam</button>
          </div>
          <div id="examProgress" class="muted"></div>
        </div>
        <div id="questionKeys" class="qkeys"></div>
      </div>
    </div>
  </div>

<script>
const MASTER_KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const BIN_ID = "68bc605c43b1c97be9391c1d";
const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

let db = { subjects: [], questions: [], students: [], scores: [] };
let currentUser = null;
let examState = null;
let examInterval = null;

/* Data Management */
async function loadDB(){
  try {
    const res = await fetch(`${URL}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
    const data = await res.json();
    if (data.record) db = data.record;
  } catch(e){ console.error(e); }
}

async function saveDB(){
  await fetch(URL, { 
    method: "PUT", 
    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
    body: JSON.stringify(db)
  });
}

async function commit(){ await saveDB(); renderAllAdmin(); refreshRegClassList(); }

function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*999).toString(36); }
function togglePassVisibility(id, checked){ document.getElementById(id).type = checked ? "text" : "password"; }

/* Authentication */
function toggleAuth(e, type) {
  if(e) e.preventDefault();
  document.getElementById("loginForm").classList.toggle("hidden", type === 'reg');
  document.getElementById("registerForm").classList.toggle("hidden", type === 'login');
  if(type === 'reg') refreshRegClassList();
}

function refreshRegClassList() {
    const sel = document.getElementById("regClassSelect");
    const classes = [...new Set(db.subjects.map(s => s.class))].sort();
    sel.innerHTML = `<option value="" disabled selected>Select Your Class</option>`;
    classes.forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
}

document.getElementById("btnRegister").onclick = async () => {
  const name = document.getElementById("regFullName").value.trim();
  const user = document.getElementById("regUser").value.trim();
  const cls = document.getElementById("regClassSelect").value;
  const pass = document.getElementById("regPass").value.trim();
  if(!name || !user || !cls || !pass) return alert("Fill all fields.");
  if(db.students.some(s => s.username === user)) return alert("Username taken.");
  db.students.push({ id: uid(), username: user, name: name, class: cls, password: pass });
  await commit();
  alert("Registration Success! Please Login.");
  toggleAuth(null, 'login');
};

document.getElementById("btnLogin").onclick = async () => {
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();
  const c = document.getElementById("loginClass").value.trim();
  await loadDB();
  if(u === "admin" && p === "admin"){
    currentUser = { role: "admin" };
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("adminCard").classList.remove("hidden");
    renderAllAdmin();
    return;
  }
  const s = db.students.find(x => x.username === u && x.password === p && x.class === c);
  if(!s) return alert("Invalid credentials.");
  currentUser = { ...s, role: "student" };
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("studentCard").classList.remove("hidden");
  document.getElementById("studentHeader").innerText = `Welcome, ${s.name} (${s.class})`;
  prepareStudentDropdown();
};

/* Admin Functions */
function renderAllAdmin(){
  refreshClassFilters();
  refreshQuestionAddSubjects();
  renderSubjects();
  renderStudents();
  renderResults();
}

function refreshClassFilters(){
  const classes = [...new Set(db.subjects.map(s => s.class))].sort();
  ["subjectClassFilter", "questionClassFilter", "studentClassFilter", "adminStudentClassFilter"].forEach(id => {
    const sel = document.getElementById(id);
    const prev = sel.value;
    sel.innerHTML = `<option value="" disabled selected>-- Class --</option><option value="all">All</option>`;
    classes.forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
    if(prev) sel.value = prev;
  });
}

function renderSubjects(){
  const f = document.getElementById("subjectClassFilter").value;
  const tbody = document.getElementById("subjectsTbody");
  tbody.innerHTML = "";
  db.subjects.filter(s => f === "all" || s.class === f).forEach(s => {
    tbody.insertAdjacentHTML("beforeend", `<tr><td>${s.name}</td><td>${s.class}</td><td>${s.duration}</td><td>${s.marksPerQuestion}</td><td>
      <button class="small" onclick="editSubject('${s.id}')">Edit</button>
      <button class="small danger" onclick="deleteSubject('${s.id}')">Del</button>
    </td></tr>`);
  });
}

async function editSubject(id){
  const s = db.subjects.find(x => x.id === id);
  const n = prompt("Subject Name", s.name);
  if(n) s.name = n;
  await commit();
}

async function deleteSubject(id){
  if(confirm("Delete Subject and all Questions?")){
    db.subjects = db.subjects.filter(s => s.id !== id);
    db.questions = db.questions.filter(q => q.subjectId !== id);
    await commit();
  }
}

function renderStudents(){
  const f = document.getElementById("studentClassFilter").value;
  const tbody = document.getElementById("studentsTbody");
  tbody.innerHTML = "";
  db.students.filter(s => f === "all" || s.class === f).forEach(s => {
    tbody.insertAdjacentHTML("beforeend", `<tr><td>${s.username}</td><td>${s.name}</td><td>${s.class}</td><td>
      <button class="small" onclick="editStudent('${s.id}')">Edit</button>
      <button class="small danger" onclick="deleteStudent('${s.id}')">Del</button>
    </td></tr>`);
  });
}

async function editStudent(id){
  const s = db.students.find(x => x.id === id);
  const n = prompt("Full Name", s.name);
  const c = prompt("Class", s.class);
  const p = prompt("Password", s.password);
  if(n) s.name = n; if(c) s.class = c; if(p) s.password = p;
  await commit();
}

async function deleteStudent(id){
  if(confirm("Delete student?")){ db.students = db.students.filter(s => s.id !== id); await commit(); }
}

function renderResults(){
  const f = document.getElementById("adminStudentClassFilter").value;
  const tbody = document.getElementById("resultsTbody");
  const thead = document.getElementById("resultsThead");
  tbody.innerHTML = ""; 
  if(!f) return;
  thead.innerHTML = "<tr><th>Student</th><th>Subject</th><th>Score</th><th>Action</th></tr>";
  db.scores.filter(sc => {
    const s = db.students.find(st => st.id === sc.studentId);
    return f === "all" || (s && s.class === f);
  }).forEach(sc => {
    const s = db.students.find(st => st.id === sc.studentId);
    tbody.insertAdjacentHTML("beforeend", `<tr><td>${s?s.name:'?'}</td><td>${sc.subject}</td><td>${sc.score}/${sc.totalMarks}</td><td>
      <button class="small muted" onclick="showStudentAnswers('${sc.studentId}', '${sc.subjectId}')">View</button>
    </td></tr>`);
  });
}

function showStudentAnswers(sid, subid) {
  const sc = db.scores.find(x => x.studentId == sid && x.subjectId == subid);
  const st = db.students.find(x => x.id == sid);
  const qs = db.questions.filter(x => x.subjectId == subid);
  let html = `<h3>${st.name} - ${sc.subject}</h3>`;
  qs.forEach((q, i) => {
    const ans = sc.answers[i] || 'No Answer';
    const color = ans === q.correct ? 'green' : 'red';
    html += `<p><strong>Q${i+1}:</strong> ${q.question}<br><span style="color:${color}">Student: ${ans}</span> (Correct: ${q.correct})</p>`;
  });
  document.getElementById("answerSheetContent").innerHTML = html;
  document.getElementById("adminCard").classList.add("hidden");
  document.getElementById("answerSheetCard").classList.remove("hidden");
}

/* Exam Engine */
function prepareStudentDropdown(){
  const sel = document.getElementById("studentSubjectDropdown");
  sel.innerHTML = `<option value="">-- Select Subject --</option>`;
  db.subjects.filter(s => s.class === currentUser.class).forEach(s => {
    const done = db.scores.some(sc => sc.studentId === currentUser.id && sc.subjectId === s.id);
    sel.insertAdjacentHTML("beforeend", `<option value="${s.id}" ${done?'disabled':''}>${s.name} ${done?'(Done)':''}</option>`);
  });
}

document.getElementById("btnStartExam").onclick = () => {
  const sid = document.getElementById("studentSubjectDropdown").value;
  const subj = db.subjects.find(s => s.id === sid);
  const qs = db.questions.filter(q => q.subjectId === sid);
  if(!qs.length) return alert("No questions found.");
  examState = { subjectId: sid, questions: qs, answers: Array(qs.length).fill(null), index: 0, durationSec: subj.duration * 60, marksPerQ: subj.marksPerQuestion };
  document.getElementById("subjectPickerCard").classList.add("hidden");
  document.getElementById("examCard").classList.remove("hidden");
  document.getElementById("examSubjectTitle").innerText = subj.name;
  renderExamQuestion();
  startTimer();
};

function renderExamQuestion(){
  const i = examState.index;
  const q = examState.questions[i];
  const ans = examState.answers[i];
  document.getElementById("examQuestionBox").innerHTML = `
    <h4>Question ${i+1} of ${examState.questions.length}</h4>
    <h3>${q.question}</h3>
    <div style="display:grid; gap:10px">
      <div class="exam-option ${ans==='A'?'selected':''}" onclick="studentSelect('A')">A. ${q.A}</div>
      <div class="exam-option ${ans==='B'?'selected':''}" onclick="studentSelect('B')">B. ${q.B}</div>
      <div class="exam-option ${ans==='C'?'selected':''}" onclick="studentSelect('C')">C. ${q.C}</div>
    </div>`;
  document.getElementById("btnPrevQ").disabled = (i === 0);
  const isLast = i === examState.questions.length - 1;
  document.getElementById("btnNextQ").classList.toggle("hidden", isLast);
  document.getElementById("btnSubmitExam").classList.toggle("hidden", !isLast);
  document.getElementById("examProgress").innerText = `${i+1} / ${examState.questions.length}`;
  renderKeypad();
}

function studentSelect(letter){ examState.answers[examState.index] = letter; renderExamQuestion(); }
function examJump(i){ examState.index = i; renderExamQuestion(); }

/* FIX: Navigation Button Handlers */
document.getElementById("btnNextQ").onclick = () => { if(examState.index < examState.questions.length - 1) { examState.index++; renderExamQuestion(); } };
document.getElementById("btnPrevQ").onclick = () => { if(examState.index > 0) { examState.index--; renderExamQuestion(); } };

function renderKeypad(){
  const div = document.getElementById("questionKeys");
  div.innerHTML = "";
  examState.questions.forEach((_, i) => {
    const cls = `qkey ${examState.index===i?'active':''} ${examState.answers[i]?'answered':''}`;
    div.insertAdjacentHTML("beforeend", `<div class="${cls}" onclick="examJump(${i})">${i+1}</div>`);
  });
}

function startTimer(){
  clearInterval(examInterval);
  examInterval = setInterval(() => {
    examState.durationSec--;
    const m = Math.floor(examState.durationSec/60).toString().padStart(2, '0');
    const s = (examState.durationSec%60).toString().padStart(2, '0');
    document.getElementById("examTimer").innerText = `${m}:${s}`;
    if(examState.durationSec <= 0) finalizeExam();
  }, 1000);
}

document.getElementById("btnSubmitExam").onclick = () => { if(confirm("Submit?")) finalizeExam(); };

async function finalizeExam(){
  clearInterval(examInterval);
  let score = 0;
  examState.questions.forEach((q, i) => { if(examState.answers[i] === q.correct) score += Number(examState.marksPerQ); });
  db.scores.push({ studentId: currentUser.id, subjectId: examState.subjectId, subject: document.getElementById("examSubjectTitle").innerText, score, totalMarks: examState.questions.length * examState.marksPerQ, answers: examState.answers });
  await commit();
  document.getElementById("examCard").classList.add("hidden");
  document.getElementById("subjectPickerCard").classList.remove("hidden");
  prepareStudentDropdown();
  alert("Submitted Successfully.");
}

/* Helpers and Initialization */
document.getElementById("btnAddSubject").onclick = () => {
  const n = document.getElementById("newSubjectInput").value, c = document.getElementById("newSubjectClassInput").value, d = document.getElementById("newSubjectDuration").value, m = document.getElementById("newSubjectMarks").value;
  if(n && c && d && m) { db.subjects.push({id: uid(), name: n, class: c, duration: d, marksPerQuestion: m}); commit(); }
};

document.getElementById("btnAddQuestion").onclick = () => {
  const sid = document.getElementById("questionSubjectSelect").value, txt = document.getElementById("questionText").value;
  const a = document.getElementById("optionA").value, b = document.getElementById("optionB").value, c = document.getElementById("optionC").value, cor = document.getElementById("correctOption").value;
  if(sid && txt && a && b && c) { db.questions.push({id: uid(), subjectId: sid, question: txt, A: a, B: b, C: c, correct: cor}); commit(); }
};

document.getElementById("btnAddStudent").onclick = () => {
  const u = document.getElementById("stuUsername").value, n = document.getElementById("stuFullName").value, c = document.getElementById("stuClass").value, p = document.getElementById("stuPassword").value;
  if(u && n && c && p) { db.students.push({id: uid(), username: u, name: n, class: c, password: p}); commit(); }
};

function refreshQuestionAddSubjects(){
  const sel = document.getElementById("questionSubjectSelect");
  sel.innerHTML = `<option value="" disabled selected>-- Select Subject --</option>`;
  db.subjects.forEach(s => sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name} (${s.class})</option>`));
}

function refreshQuestionFilterSubjects() {
    const classFilter = document.getElementById("questionClassFilter").value;
    const subjectFilter = document.getElementById("questionFilterSubjectSelect");
    subjectFilter.innerHTML = `<option value="" disabled selected>-- Select Subject --</option><option value="all">All</option>`;
    db.subjects.filter(s => classFilter === "all" || s.class === classFilter).forEach(s => {
        subjectFilter.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.name}</option>`);
    });
}

document.getElementById("btnLogoutAdmin").onclick = () => location.reload();
document.getElementById("btnLogoutStudent").onclick = () => location.reload();
document.getElementById("btnCloseAnswerSheet").onclick = () => {
    document.getElementById("answerSheetCard").classList.add("hidden");
    document.getElementById("adminCard").classList.remove("hidden");
};

(async function init(){ await loadDB(); refreshRegClassList(); renderAllAdmin(); })();

window.editSubject = editSubject; window.deleteSubject = deleteSubject; window.editStudent = editStudent; window.deleteStudent = deleteStudent;
window.studentSelect = studentSelect; window.examJump = examJump; window.showStudentAnswers = showStudentAnswers;
</script>
</body>
</html>
