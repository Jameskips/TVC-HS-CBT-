<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (JSONBin)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Your original CSS is unchanged */
  </style>
</head>
<body>
  <header><h1>The Valued Child (TVC) High School — CBT</h1></header>
  <div class="wrap">

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row" style="gap:8px">
        <input id="loginUser" placeholder="Username (admin or student username)" />
        <input id="loginClass" placeholder="Class (e.g. JSS1)" />
        <div class="password-container">
          <input id="loginPass" placeholder="Password" type="password" />
          <span class="password-toggle" onclick="togglePassword()">  </span>
        </div>
        <button id="btnLogin">Login</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Admin Dashboard</h2>
        <div class="row">
          <button id="btnSaveBin" class="muted">Save to JSONBin</button>
          <button id="btnReloadBin" class="muted">Reload from JSONBin</button>
          <button id="btnLogoutAdmin" class="muted">Logout</button>
        </div>
      </div>

      <!-- SUBJECTS MANAGEMENT -->
      <div class="card accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('subjects')">
          <h3>Subjects</h3>
          <span class="icon">&#9660;</span>
        </div>
        <div id="subjectsAccordion" class="accordion-content hidden">
          <div class="row">
            <input id="newSubjectInput" placeholder="New subject name" />
            <input id="newSubjectClassInput" placeholder="Class (e.g. JSS1)" />
            <button id="btnAddSubject">Add</button>
          </div>
          <div>
            <h4>Settings</h4>
            <div class="row">
              <div class="row">
                <div class="muted">Default duration (min):</div>
                <input id="subjectDurationInput" type="number" value="1" style="width:120px" />
                <button id="btnSetDuration" class="muted">Set</button>
              </div>
              <div class="row">
                <div class="muted">Default mark:</div>
                <input id="subjectMarkInput" type="number" value="1" style="width:120px" />
                <button id="btnSetMark" class="muted">Set</button>
              </div>
            </div>
          </div>
          <table>
            <thead>
              <tr><th>Subject</th><th>Class</th><th style="width:160px">Actions</th></tr>
            </thead>
            <tbody id="subjectsTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- QUESTIONS MANAGEMENT -->
      <div class="card accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('questions')">
          <h3>Questions (selected subject)</h3>
          <span class="icon">&#9660;</span>
        </div>
        <div id="questionsAccordion" class="accordion-content hidden">
          <div class="row">
            <select id="subjectSelectForQuestions"></select>
            <button id="btnLoadQuestions" class="muted">Load</button>
          </div>
          <div style="margin-top:10px">
            <h4 id="qFormTitle">Add New Question</h4>
            <textarea id="qText" placeholder="Question text"></textarea>
            <div class="row">
              <input id="qA" placeholder="Option A" />
              <input id="qB" placeholder="Option B" />
              <input id="qC" placeholder="Option C" />
              <input id="qMark" type="number" placeholder="Mark per question" style="display:none"/>
            </div>
            <div class="row">
              <select id="qAnswer">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
              <button id="btnAddQuestion">Add Question</button>
              <button id="btnCancelEdit" class="muted" style="display:none">Cancel Edit</button>
            </div>
          </div>
          <h4 style="margin-top:12px">Existing Questions</h4>
          <table>
            <thead><tr><th>#</th><th>Question</th><th>Answer</th><th>Mark</th><th style="width:200px">Actions</th></tr></thead>
            <tbody id="questionsTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- (Students & Scores section remains unchanged) -->
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="studentCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Student Panel — <span id="studentNameDisplay"></span></h2>
        <div class="row"><button id="btnLogoutStudent" class="muted">Logout</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Available Subjects</h3>
        <select id="studentSubjectSelect"></select>
        <div class="row" style="margin-top:8px">
          <div class="muted">Exam duration (minutes)</div>
          <input id="examDurationInput" type="number" readonly style="width:120px" />
          <button id="btnStartExam">Start Exam</button>
        </div>
      </div>

      <!-- Exam interface unchanged -->
      <div id="examCard" class="card hidden">
        <!-- ... existing exam UI ... -->
      </div>
    </div>

    <div id="status" class="muted" style="margin-top:8px"></div>
  </div>

<script>
/* ============================
   CONFIG
============================ */
const BIN_ID = "";
const API_KEY = "";

/* ============================
   Local fallback db
============================ */
let db = {
  subjects: [
    {id:1,name:"Mathematics", class:"JSS1", duration: 1, defaultMark: 1},
    {id:2,name:"English Language", class:"JSS2", duration: 1, defaultMark: 1}
  ],
  questions: [],
  students: [],
  scores: []
};

/* ============================
   Admin: Add Subject
============================ */
function handleAddSubject(){
  const name = newSubjectInput.value.trim();
  const cls = newSubjectClassInput.value.trim();
  if(!name || !cls) return alert('Enter subject name and class');
  const id = Date.now();
  db.subjects.push({ id, name, class: cls, duration: 1, defaultMark: 1 });
  db.questions = db.questions || [];
  saveToBin();
  newSubjectInput.value = '';
  newSubjectClassInput.value = '';
  renderAllAdminLists();
}

function renderSubjectsTable(){
  subjectsTbody.innerHTML = '';
  subjectSelectForQuestions.innerHTML = '';
  db.subjects.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.class}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const editBtn = document.createElement('button'); editBtn.className='muted'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> editSubject(s.id);
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteSubject(s.id);
    td.appendChild(editBtn); td.appendChild(delBtn);
    subjectsTbody.appendChild(tr);

    const opt = document.createElement('option'); 
    opt.value = s.id; 
    opt.textContent = `${s.name} (${s.class})`;
    subjectSelectForQuestions.appendChild(opt);
  });
}

/* ============================
   Student subjects filtering
============================ */
function populateStudentSubjects(){
  studentSubjectSelect.innerHTML = '';
  (db.subjects||[]).filter(s => s.class === currentUser.class).forEach(s => {
    const opt = document.createElement('option'); 
    opt.value=s.id; 
    opt.textContent = s.name; 
    studentSubjectSelect.appendChild(opt);
  });
  const selectedSubject = db.subjects.find(s => s.id == studentSubjectSelect.value);
  if(selectedSubject) {
      examDurationInput.value = selectedSubject.duration;
  }
}

/* ============================
   Questions CRUD
============================ */
function handleAddQuestion(){
  const subjId = parseInt(subjectSelectForQuestions.value);
  if(!subjId) return alert('Select subject first');
  const text = qText.value.trim(), A=qA.value.trim(), B=qB.value.trim(), C=qC.value.trim();
  const ans=qAnswer.value;
  if(!text || !A || !B || !C) return alert('Fill question and all options');

  const selectedSubject = db.subjects.find(s => s.id === subjId);
  const mark = selectedSubject ? selectedSubject.defaultMark : 1;

  db.questions = db.questions || [];
  const id = Date.now();
  db.questions.push({ id, subjectId:subjId, question:text, options:[A,B,C], answer: ['A','B','C'].indexOf(ans), scoreValue: mark });
  saveToBin();
  clearQuestionForm();
  renderQuestionsFor(subjId);
}

function renderQuestionsFor(subjectId){
  questionsTbody.innerHTML = '';
  (db.questions || []).filter(q => q.subjectId === parseInt(subjectId)).forEach((q, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${q.question}</td><td>${q.options[q.answer]||''}</td><td>${q.scoreValue || 1}</td><td></td>`;
    const td = tr.querySelector('td:last-child');
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteQuestion(q.id);
    td.appendChild(delBtn);
    questionsTbody.appendChild(tr);
  });
}

function clearQuestionForm(){ qText.value=''; qA.value=''; qB.value=''; qC.value=''; qAnswer.value='A'; }

/* ============================
   (Other code remains unchanged)
============================ */
</script>
</body>
</html>
