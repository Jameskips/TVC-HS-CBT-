<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School â€” Ultimate Enterprise CBT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #334155; --muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* HEADER */
    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 30px; }
    .logo { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
    .badge { padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 600; background: #dcfce7; color: #166534; }

    /* LAYOUT */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
    .card { background: var(--card); border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; background: #fff; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--primary); }
    .card-body { padding: 20px; }

    /* FORM ELEMENTS */
    .input-group { position: relative; margin-bottom: 15px; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box; transition: 0.2s; outline: none; }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .toggle-btn { position: absolute; right: 12px; top: 12px; font-size: 11px; font-weight: 800; color: var(--accent); cursor: pointer; text-transform: uppercase; }
    
    button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }

    /* TABLES */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; font-size: 11px; color: var(--muted); text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
    td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
    .scrollable { max-height: 350px; overflow-y: auto; }

    /* MODALS */
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:white; width:90%; max-width:650px; padding:30px; border-radius:16px; max-height:80vh; overflow-y:auto; }

    .hidden { display: none; }
    .count-chip { background: #eff6ff; color: var(--accent); padding: 2px 8px; border-radius: 6px; font-size: 12px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">TVC <span style="color:var(--accent)">Enterprise</span></div>
    <div id="adminTag" class="badge hidden">ADMIN PANEL ACTIVE</div>
  </div>

  <div id="authBox" style="max-width: 420px; margin: 40px auto;">
    <div id="loginView" class="card">
        <div class="card-header">Portal Login</div>
        <div class="card-body">
            <input id="lUser" placeholder="Username" style="margin-bottom:12px">
            <input id="lClass" placeholder="Class (e.g. JSS1)" style="margin-bottom:12px">
            <div class="input-group">
                <input id="lPass" type="password" placeholder="Password">
                <span class="toggle-btn" onclick="togglePass('lPass')">Show</span>
            </div>
            <button onclick="doLogin()" class="btn-primary" style="width:100%">Sign In</button>
            <p style="text-align:center; font-size:13px; margin-top:20px; color:var(--muted)">New? <a href="#" onclick="toggleAuth(true)">Register Student</a></p>
        </div>
    </div>

    <div id="regView" class="card hidden">
        <div class="card-header">Student Registration</div>
        <div class="card-body">
            <input id="rName" placeholder="Full Name" style="margin-bottom:12px">
            <input id="rUser" placeholder="Username" style="margin-bottom:12px">
            <input id="rClass" placeholder="Class (e.g. JSS1)" style="margin-bottom:12px">
            <div class="input-group">
                <input id="rPass" type="password" placeholder="Password">
                <span class="toggle-btn" onclick="togglePass('rPass')">Show</span>
            </div>
            <input id="rCode" type="password" placeholder="Access Code (TVC2026)" style="margin-bottom:15px">
            <button onclick="doRegister()" class="btn-primary" style="width:100%">Create Account</button>
            <p style="text-align:center; font-size:13px; margin-top:15px"><a href="#" onclick="toggleAuth(false)">Back to Login</a></p>
        </div>
    </div>
  </div>

  <div id="adminPanel" class="hidden">
    <div class="card">
        <div class="card-header">
            <span>Student Management</span>
            <span id="stuCount" class="count-chip">0 Students</span>
        </div>
        <div class="card-body">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="stuSearch" placeholder="Search by name..." onkeyup="runStuFilters()" style="flex:2">
                <select id="classFilter" onchange="runStuFilters()" style="flex:1">
                    <option value="">All Classes</option>
                    <option value="JSS1">JSS1</option><option value="JSS2">JSS2</option><option value="JSS3">JSS3</option>
                    <option value="SS1">SS1</option><option value="SS2">SS2</option><option value="SS3">SS3</option>
                </select>
            </div>
            <div class="scrollable">
                <table>
                    <thead><tr><th>Name</th><th>Class</th><th>Username</th><th>Action</th></tr></thead>
                    <tbody id="studentList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="card-header">Create Subject</div>
            <div class="card-body">
                <input id="nSub" placeholder="Subject Name" style="margin-bottom:10px">
                <input id="nCls" placeholder="Class" style="margin-bottom:10px">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input id="nDur" type="number" placeholder="Mins">
                    <input id="nMrk" type="number" placeholder="Marks">
                </div>
                <button onclick="addSubject()" class="btn-accent" style="width:100%">Save Subject</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Questions: Bulk & Copy</div>
            <div class="card-body">
                <select id="subSel" style="margin-bottom:10px"></select>
                <textarea id="bulkData" placeholder="Format: Question, OptA, OptB, OptC, CorrectLetter" style="height:80px; margin-bottom:10px; font-family:monospace; font-size:12px;"></textarea>
                <button onclick="processBulk()" class="btn-success" style="width:100%; margin-bottom:10px;">Process Bulk Upload</button>
                <button onclick="openCopyModal()" class="btn-primary" style="width:100%">Copy From Other Bank</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Global Subject Registry</div>
        <div class="card-body scrollable">
            <table>
                <thead><tr><th>Subject</th><th>Class</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="subList"></tbody>
            </table>
        </div>
    </div>

    <button onclick="location.reload()" class="btn-danger" style="margin-top:20px">Logout Admin</button>
  </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-content">
        <h2 id="preTitle" style="margin-top:0"></h2>
        <div id="preBody" class="scrollable" style="border-top:1px solid #eee; padding-top:15px;"></div>
        <button onclick="closeModal('previewModal')" class="btn-danger" style="width:100%; margin-top:20px">Close Preview</button>
    </div>
</div>

<div id="copyModal" class="modal">
    <div class="modal-content">
        <h3>Copy Question Bank</h3>
        <label style="font-size:12px">From (Source):</label>
        <select id="copyFrom" style="margin-bottom:15px"></select>
        <label style="font-size:12px">To (Destination):</label>
        <select id="copyTo" style="margin-bottom:20px"></select>
        <button onclick="doCopyQuestions()" class="btn-accent" style="width:100%">Execute Copy</button>
        <button onclick="closeModal('copyModal')" class="btn-danger" style="width:100%; margin-top:10px; background:none;">Cancel</button>
    </div>
</div>

<script>
const KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const BIN = "68bc605c43b1c97be9391c1d";
const URL = `https://api.jsonbin.io/v3/b/${BIN}`;

let db = { students: [], subjects: [], questions: [], scores: [] };

async function load() { 
    try {
        const r = await fetch(`${URL}/latest`, { headers: {"X-Master-Key": KEY} }); 
        const d = await r.json(); if(d.record) db = d.record; 
    } catch(e) { console.error("Cloud Error"); }
}
async function sync() { await fetch(URL, { method: "PUT", headers: {"Content-Type":"application/json", "X-Master-Key": KEY}, body: JSON.stringify(db) }); }

function toggleAuth(reg) { document.getElementById('loginView').classList.toggle('hidden', reg); document.getElementById('regView').classList.toggle('hidden', !reg); }
function togglePass(id) { const x = document.getElementById(id); x.type = x.type === "password" ? "text" : "password"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

/* --- ACTIONS --- */
async function doRegister() {
    if(document.getElementById('rCode').value !== "TVC2026") return alert("Wrong Code");
    await load();
    db.students.push({ 
        id: "STU-"+Math.random().toString(36).substr(2,4).toUpperCase(),
        name: document.getElementById('rName').value, 
        username: document.getElementById('rUser').value, 
        class: document.getElementById('rClass').value.toUpperCase(), 
        password: document.getElementById('rPass').value 
    });
    await sync(); alert("Student Registered!"); toggleAuth(false);
}

async function doLogin() {
    const u = document.getElementById('lUser').value, p = document.getElementById('lPass').value, c = document.getElementById('lClass').value.toUpperCase();
    await load();
    if(u === "admin" && p === "admin") {
        document.getElementById('authBox').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminTag').classList.remove('hidden');
        renderAdmin();
    } else {
        const s = db.students.find(x => x.username === u && x.password === p && x.class === c);
        if(s) alert("Welcome student: " + s.name); else alert("Login failed.");
    }
}

function runStuFilters() {
    const n = document.getElementById('stuSearch').value.toLowerCase();
    const c = document.getElementById('classFilter').value.toUpperCase();
    const rows = document.getElementById('studentList').getElementsByTagName('tr');
    let count = 0;
    for(let r of rows) {
        const match = r.innerText.toLowerCase().includes(n) && (c==="" || r.cells[1].innerText === c);
        r.style.display = match ? "" : "none";
        if(match) count++;
    }
    document.getElementById('stuCount').innerText = `${count} Students`;
}

function renderAdmin() {
    // Render Student Table
    const sl = document.getElementById('studentList'); sl.innerHTML = "";
    db.students.forEach(s => {
        sl.innerHTML += `<tr><td>${s.name}</td><td><b>${s.class}</b></td><td>${s.username}</td><td><button class="btn-danger" onclick="delStu('${s.id}')">Delete</button></td></tr>`;
    });
    runStuFilters();

    // Render Subjects & Selectors
    const subL = document.getElementById('subList'); subL.innerHTML = "";
    const sel = document.getElementById('subSel'); sel.innerHTML = "";
    const cf = document.getElementById('copyFrom'); cf.innerHTML = "";
    const ct = document.getElementById('copyTo'); ct.innerHTML = "";

    db.subjects.forEach(sb => {
        subL.innerHTML += `<tr><td>${sb.name}</td><td>${sb.class}</td><td><span style="color:${sb.released?'var(--success)':'var(--danger)'}">${sb.released?'Public':'Draft'}</span></td>
        <td><button onclick="openPreview('${sb.id}')">View</button> <button onclick="togRel('${sb.id}')" style="background:#eee">Toggle</button> <button class="btn-danger" onclick="delSub('${sb.id}')">X</button></td></tr>`;
        const opt = `<option value="${sb.id}">${sb.name} (${sb.class})</option>`;
        sel.innerHTML += opt; cf.innerHTML += opt; ct.innerHTML += opt;
    });
}

async function addSubject() {
    db.subjects.push({ id: Date.now().toString(36), name: document.getElementById('nSub').value, class: document.getElementById('nCls').value.toUpperCase(), duration: document.getElementById('nDur').value, marks: document.getElementById('nMrk').value, released: false });
    await sync(); renderAdmin();
    ['nSub','nCls','nDur','nMrk'].forEach(i => document.getElementById(i).value="");
}

async function processBulk() {
    const sid = document.getElementById('subSel').value;
    const raw = document.getElementById('bulkData').value;
    if(!sid || !raw) return alert("Select subject and paste data");
    const lines = raw.split("\n");
    let c = 0;
    lines.forEach(l => {
        const p = l.split(",");
        if(p.length >= 5) {
            db.questions.push({ id: Date.now().toString(36)+c, subjectId: sid, question: p[0].trim(), A: p[1].trim(), B: p[2].trim(), C: p[3].trim(), correct: p[4].trim().toUpperCase() });
            c++;
        }
    });
    await sync(); document.getElementById('bulkData').value = ""; alert(`Imported ${c} questions!`);
}

function openPreview(sid) {
    const s = db.subjects.find(x => x.id === sid), qs = db.questions.filter(q => q.subjectId === sid);
    document.getElementById('preTitle').innerText = `${s.name} Preview`;
    document.getElementById('preBody').innerHTML = qs.map((q,i) => `<div style="margin-bottom:15px"><b>Q${i+1}:</b> ${q.question}<br><small>A: ${q.A} | B: ${q.B} | C: ${q.C} | Correct: <b>${q.correct}</b></small></div>`).join("");
    document.getElementById('previewModal').style.display = "flex";
}

function openCopyModal() { document.getElementById('copyModal').style.display = "flex"; }

async function doCopyQuestions() {
    const from = document.getElementById('copyFrom').value, to = document.getElementById('copyTo').value;
    if(from === to) return alert("Choose different subjects");
    const sourceQs = db.questions.filter(q => q.subjectId === from);
    sourceQs.forEach(q => db.questions.push({ ...q, id: Date.now().toString(36)+Math.random(), subjectId: to }));
    await sync(); alert(`Copied ${sourceQs.length} questions!`); closeModal('copyModal');
}

window.delStu = async (id) => { if(confirm("Delete Student?")) { db.students = db.students.filter(x => x.id !== id); await sync(); renderAdmin(); }};
window.delSub = async (id) => { if(confirm("Delete Subject & Questions?")) { db.subjects = db.subjects.filter(x => x.id !== id); db.questions = db.questions.filter(q => q.subjectId !== id); await sync(); renderAdmin(); }};
window.togRel = async (id) => { const s = db.subjects.find(x=>x.id===id); s.released = !s.released; await sync(); renderAdmin(); };

load();
</script>
</body>
</html>
