<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TVC High School CBT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1,h2 { text-align: center; }
    .hidden { display: none; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    button { padding: 8px 14px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; background: #007bff; color: white; }
    button:hover { background: #0056b3; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
    .question { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>The Valued Child (TVC) High School</h1>
    <h2>Computer Based Test (CBT) System</h2>

    <!-- Login -->
    <div id="loginPage">
      <h3>Login</h3>
      <input type="text" id="loginName" placeholder="Enter Name">
      <input type="password" id="loginPassword" placeholder="Enter Password">
      <button onclick="login()">Login</button>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden">
      <h3>Admin Dashboard</h3>
      <button onclick="showSection('addSubject')">Add Subject</button>
      <button onclick="showSection('addQuestion')">Add Question</button>
      <button onclick="showSection('viewScores')">View Scores</button>
      <button onclick="logout()">Logout</button>

      <div id="addSubject" class="hidden">
        <h4>Add Subject</h4>
        <input type="text" id="subjectName" placeholder="Subject name">
        <button onclick="addSubject()">Save Subject</button>
      </div>

      <div id="addQuestion" class="hidden">
        <h4>Add Question</h4>
        <select id="questionSubject"></select>
        <textarea id="questionText" placeholder="Enter question"></textarea>
        <input type="text" id="optA" placeholder="Option A">
        <input type="text" id="optB" placeholder="Option B">
        <input type="text" id="optC" placeholder="Option C">
        <input type="text" id="optD" placeholder="Option D">
        <input type="text" id="correctAns" placeholder="Correct Answer (A/B/C/D)">
        <button onclick="addQuestion()">Save Question</button>
      </div>

      <div id="viewScores" class="hidden">
        <h4>Scores</h4>
        <ul id="scoresList"></ul>
      </div>
    </div>

    <!-- Student Exam Page -->
    <div id="examPage" class="hidden">
      <h3>Exam</h3>
      <p><b>Subject:</b> <span id="examSubject"></span></p>
      <p><b>Time Left:</b> <span id="timer">00:00</span></p>
      <div id="questionsContainer"></div>
      <button onclick="submitExam()">Submit Exam</button>
    </div>
  </div>

<script>
  // ====== CONFIG (PUT YOUR DETAILS HERE) ======
  const binId = "68b36d5743b1c97be9315a46";   // paste your bin ID
  const apiKey = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy"; // paste your API key
  const binUrl = `https://api.jsonbin.io/v3/b/${binId}`;

  // ====== Local Data ======
  let data = {
    users: [
      {name: "Admin", password: "admin123", role: "admin"},
      {name: "John Doe", password: "1234", role: "student"}
    ],
    subjects: ["Mathematics"],
    questions: [
      {subject: "Mathematics", text: "2 + 2 = ?", options: ["A) 3","B) 4","C) 5","D) 6"], answer: "B"}
    ],
    scores: []
  };

  // ====== JSONBin Load & Save ======
  async function loadData() {
    try {
      const res = await fetch(binUrl, { headers: {"X-Master-Key": apiKey}});
      if (!res.ok) return; // skip if bin empty
      const json = await res.json();
      data = json.record;
      console.log("Data loaded:", data);
    } catch (e) { console.error("Load error:", e); }
  }

  async function saveData() {
    try {
      await fetch(binUrl, {
        method: "PUT",
        headers: {"Content-Type": "application/json", "X-Master-Key": apiKey},
        body: JSON.stringify(data)
      });
      console.log("Data saved!");
    } catch (e) { console.error("Save error:", e); }
  }

  // ====== Login ======
  function login() {
    const name = document.getElementById("loginName").value.trim();
    const pass = document.getElementById("loginPassword").value.trim();
    const user = data.users.find(u => u.name === name && u.password === pass);
    if (!user) { alert("Invalid login"); return; }

    document.getElementById("loginPage").classList.add("hidden");
    if (user.role === "admin") {
      document.getElementById("adminPage").classList.remove("hidden");
      refreshSubjects();
      viewScores();
    } else {
      startExam(user);
    }
  }

  function logout() {
    document.getElementById("adminPage").classList.add("hidden");
    document.getElementById("examPage").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
  }

  // ====== Admin Functions ======
  function showSection(id) {
    ["addSubject","addQuestion","viewScores"].forEach(sec =>
      document.getElementById(sec).classList.add("hidden")
    );
    document.getElementById(id).classList.remove("hidden");
  }

  function addSubject() {
    const s = document.getElementById("subjectName").value.trim();
    if (!s) return alert("Enter subject");
    data.subjects.push(s);
    document.getElementById("subjectName").value = "";
    refreshSubjects();
    saveData();
    alert("Subject added!");
  }

  function refreshSubjects() {
    const sel = document.getElementById("questionSubject");
    sel.innerHTML = "";
    data.subjects.forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub; opt.textContent = sub;
      sel.appendChild(opt);
    });
  }

  function addQuestion() {
    const sub = document.getElementById("questionSubject").value;
    const q = document.getElementById("questionText").value;
    const a = document.getElementById("optA").value;
    const b = document.getElementById("optB").value;
    const c = document.getElementById("optC").value;
    const d = document.getElementById("optD").value;
    const ans = document.getElementById("correctAns").value.toUpperCase();
    if (!q || !a || !b || !c || !d || !["A","B","C","D"].includes(ans)) {
      alert("Fill all fields correctly!"); return;
    }
    data.questions.push({subject: sub, text: q, options: [`A) ${a}`,`B) ${b}`,`C) ${c}`,`D) ${d}`], answer: ans});
    saveData();
    alert("Question added!");
  }

  function viewScores() {
    const list = document.getElementById("scoresList");
    list.innerHTML = "";
    data.scores.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.name} - ${s.subject}: ${s.score}%`;
      list.appendChild(li);
    });
  }

  // ====== Student Exam ======
  let currentUser, examTimer;
  function startExam(user) {
    currentUser = user;
    document.getElementById("examPage").classList.remove("hidden");
    document.getElementById("examSubject").textContent = data.subjects[0] || "General";
    renderQuestions();
    startTimer(2); // 2 minutes demo
  }

  function renderQuestions() {
    const container = document.getElementById("questionsContainer");
    container.innerHTML = "";
    const questions = data.questions.filter(q => q.subject === data.subjects[0]);
    questions.forEach((q,i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `<p>${i+1}. ${q.text}</p>`;
      q.options.forEach(opt => {
        const letter = opt[0];
        div.innerHTML += `<label><input type="radio" name="q${i}" value="${letter}"> ${opt}</label><br>`;
      });
      container.appendChild(div);
    });
  }

  function submitExam() {
    clearInterval(examTimer);
    const questions = data.questions.filter(q => q.subject === data.subjects[0]);
    let score = 0;
    questions.forEach((q,i) => {
      const ans = document.querySelector(`input[name="q${i}"]:checked`);
      if (ans && ans.value === q.answer) score++;
    });
    const percent = Math.round((score/questions.length)*100);
    data.scores.push({name: currentUser.name, subject: data.subjects[0], score: percent});
    saveData();
    alert("Exam submitted! Your result has been recorded.");
    logout();
  }

  function startTimer(minutes) {
    let time = minutes*60;
    examTimer = setInterval(() => {
      let m = Math.floor(time/60), s = time%60;
      document.getElementById("timer").textContent = `${m}:${s<10?'0':''}${s}`;
      time--;
      if (time < 0) { clearInterval(examTimer); submitExam(); }
    },1000);
  }

  // ====== Initialize ======
  loadData();
</script>
</body>
</html>
