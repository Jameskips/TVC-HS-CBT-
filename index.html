<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School â€” CBT Master Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --primary: #1a237e; --accent: #246bff; --bg: #f4f7fe; --text: #2c3e50; --danger: #e53935; --success: #2e7d32; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; color: var(--text); background: var(--bg); }
    .wrap { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
    
    /* PRINT STYLES */
    @media print {
        body * { visibility: hidden; }
        #printArea, #printArea * { visibility: visible; }
        #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; }
        .no-print { display: none !important; }
    }

    header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e0e6ed; margin-bottom: 30px; }
    header h1 { color: var(--primary); margin: 0; font-size: 28px; }

    .card { background: #fff; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #eef2f6; }
    .row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
    
    input, select, textarea { padding: 12px; border-radius: 8px; border: 1px solid #dcdfe6; font-size: 15px; width: 100%; box-sizing: border-box; }
    button { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
    button.primary { background: var(--accent); color: white; }
    button.danger { background: var(--danger); color: white; }
    button.success { background: var(--success); color: white; }
    button.muted { background: #f0f2f5; color: #4b5563; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { text-align: left; background: #f8fafc; padding: 12px; border-bottom: 2px solid #edf2f7; }
    td { padding: 12px; border-bottom: 1px solid #edf2f7; }

    /* EXAM INTERFACE */
    .exam-header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; }
    .option-card { padding: 15px; border: 2px solid #edf2f7; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
    .option-card.selected { border-color: var(--accent); background: #eef5ff; }
    .grid-nav { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-top: 20px; }
    .nav-btn { height: 35px; display: flex; align-items: center; justify-content: center; border: 1px solid #dcdfe6; border-radius: 6px; cursor: pointer; }
    .nav-btn.active { background: var(--accent); color: white; }
    .nav-btn.answered { border-color: var(--accent); color: var(--accent); background: #f0f7ff; }

    /* REPORT SLIP STYLING */
    #printArea { background: white; border: 2px solid #222; border-radius: 0; display: none; }
    .slip-head { text-align: center; border-bottom: 2px double #222; padding-bottom: 10px; margin-bottom: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="wrap no-print">
  <header><h1>TVC High School CBT</h1></header>

  <div id="authBox" class="card" style="max-width: 400px; margin: 0 auto;">
    <div id="loginView">
      <h3>Staff/Student Login</h3>
      <input id="lUser" placeholder="Username" style="margin-bottom:12px">
      <input id="lClass" placeholder="Class (e.g. JSS1)" style="margin-bottom:12px">
      <input id="lPass" type="password" placeholder="Password" style="margin-bottom:20px">
      <button onclick="doLogin()" class="primary" style="width:100%">Login to Portal</button>
      <p style="text-align:center; font-size:13px; margin-top:10px"><a href="#" onclick="toggleAuth(true)">Register Student</a></p>
    </div>
    <div id="regView" class="hidden">
      <h3>Student Registration</h3>
      <input id="rName" placeholder="Full Name" style="margin-bottom:12px">
      <input id="rUser" placeholder="Username" style="margin-bottom:12px">
      <input id="rClass" placeholder="Class" style="margin-bottom:12px">
      <input id="rPass" type="password" placeholder="Password" style="margin-bottom:12px">
      <input id="rCode" type="password" placeholder="Access Code" style="margin-bottom:15px">
      <button onclick="doRegister()" class="primary" style="width:100%">Create Account</button>
      <p style="text-align:center; font-size:13px; margin-top:10px"><a href="#" onclick="toggleAuth(false)">Back</a></p>
    </div>
  </div>

  <div id="adminPanel" class="hidden">
    <div class="row" style="justify-content: space-between;">
        <h2>Administration</h2>
        <button onclick="location.reload()" class="muted">Logout</button>
    </div>

    <div class="card">
        <h3>1. Manage Subjects</h3>
        <div class="row">
            <input id="nSub" placeholder="Subject" style="flex:2">
            <input id="nCls" placeholder="Class" style="flex:1">
            <input id="nDur" type="number" placeholder="Mins" style="flex:1">
            <input id="nMrk" type="number" placeholder="Marks/Q" style="flex:1">
            <button onclick="addSubject()" class="primary">Add</button>
        </div>
        <table id="subTable"><thead><tr><th>Subject</th><th>Class</th><th>Mins</th><th>Visibility</th><th>Action</th></tr></thead><tbody id="subList"></tbody></table>
    </div>

    <div class="card">
        <h3>2. Question Bank</h3>
        <select id="subSel" onchange="renderQList(this.value)" style="margin-bottom:15px"></select>
        <textarea id="qTxt" placeholder="Type question here..." style="height:60px; margin-bottom:10px;"></textarea>
        <div class="row">
            <input id="oA" placeholder="Option A">
            <input id="oB" placeholder="Option B">
            <input id="oC" placeholder="Option C">
            <select id="cor" style="width:80px"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
            <button onclick="addQ()" class="primary">Save</button>
        </div>
        <div id="qList" style="margin-top:15px; max-height:150px; overflow-y:auto; border:1px solid #eee;"></div>
    </div>

    <div class="card">
        <h3>3. Examination Results</h3>
        <input type="text" onkeyup="searchRes()" id="sKey" placeholder="Search by name or subject..." style="margin-bottom:15px;">
        <table id="resTable"><thead><tr><th>Name</th><th>Subject</th><th>Score</th><th>Strikes</th><th>Print</th><th>Del</th></tr></thead><tbody id="resList"></tbody></table>
    </div>
  </div>

  <div id="studentPanel" class="hidden">
    <div class="card">
        <h2 id="welcome"></h2>
        <div class="row">
            <select id="stuSubSel" style="flex:1"></select>
            <button onclick="startExam()" class="primary">Start Exam</button>
            <button onclick="location.reload()" class="muted">Logout</button>
        </div>
    </div>
    <div id="examView" class="hidden">
        <div class="exam-header"><div id="exTitle"></div><div id="timer">00:00</div></div>
        <div class="card" style="border-radius:0 0 12px 12px">
            <div id="qBox"></div>
            <div class="row" style="justify-content:space-between; margin-top:20px">
                <button onclick="move(-1)" class="muted">Back</button>
                <button id="nextBtn" onclick="move(1)" class="primary">Next</button>
                <button id="finBtn" onclick="finish()" class="danger hidden">Submit</button>
            </div>
            <div id="navGrid" class="grid-nav"></div>
        </div>
    </div>
  </div>
</div>

<div id="printArea">
    <div class="slip-head">
        <h1 style="margin:0; color:#1a237e">TVC HIGH SCHOOL</h1>
        <p style="margin:5px 0">Official CBT Examination Result Slip</p>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:30px">
        <div>
            <p><strong>Student Name:</strong> <span id="pName"></span></p>
            <p><strong>Class:</strong> <span id="pClass"></span></p>
        </div>
        <div style="text-align:right">
            <p><strong>Subject:</strong> <span id="pSub"></span></p>
            <p><strong>Date:</strong> <span id="pDate"></span></p>
        </div>
    </div>
    <div style="text-align:center; padding:30px; border:2px solid #eee; margin-bottom:20px">
        <h2 style="margin:0; color:#555">FINAL SCORE</h2>
        <h1 style="font-size:60px; margin:10px 0" id="pScore"></h1>
        <p><strong>Remarks:</strong> <span id="pRemark"></span></p>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:50px">
        <div style="border-top:1px solid #000; width:150px; text-align:center">Exam Officer</div>
        <div style="border-top:1px solid #000; width:150px; text-align:center">Principal's Signature</div>
    </div>
</div>

<script>
const KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const BIN = "68bc605c43b1c97be9391c1d";
const URL = `https://api.jsonbin.io/v3/b/${BIN}`;

let db = { subjects: [], questions: [], students: [], scores: [] };
let user = null, ex = null, timer = null;

async function load() { const r = await fetch(`${URL}/latest`, { headers: {"X-Master-Key": KEY} }); const d = await r.json(); if(d.record) db = d.record; }
async function sync() { await fetch(URL, { method: "PUT", headers: {"Content-Type":"application/json", "X-Master-Key": KEY}, body: JSON.stringify(db) }); }
function toggleAuth(r) { document.getElementById('loginView').classList.toggle('hidden', r); document.getElementById('regView').classList.toggle('hidden', !r); }

async function doRegister() {
    if(document.getElementById('rCode').value !== "TVC2026") return alert("Wrong Access Code");
    await load();
    db.students.push({ id: Date.now().toString(36), name: document.getElementById('rName').value, username: document.getElementById('rUser').value, class: document.getElementById('rClass').value.toUpperCase(), password: document.getElementById('rPass').value });
    await sync(); alert("Success!"); toggleAuth(false);
}

async function doLogin() {
    const u = document.getElementById('lUser').value, p = document.getElementById('lPass').value, c = document.getElementById('lClass').value.toUpperCase();
    await load();
    if(u === "admin" && p === "admin") {
        user = { role: 'admin' }; document.getElementById('authBox').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); renderAdmin(); return;
    }
    const s = db.students.find(x => x.username === u && x.password === p && x.class === c);
    if(s) {
        user = s; document.getElementById('authBox').classList.add('hidden'); document.getElementById('studentPanel').classList.remove('hidden');
        document.getElementById('welcome').textContent = `Student: ${s.name}`; renderStuPanel();
    } else alert("Invalid Login");
}

/* ADMIN */
async function addSubject() {
    const n = document.getElementById('nSub'), c = document.getElementById('nCls'), d = document.getElementById('nDur'), m = document.getElementById('nMrk');
    db.subjects.push({ id: Date.now().toString(36), name: n.value, class: c.value.toUpperCase(), duration: d.value, marks: m.value, released: false });
    await sync(); renderAdmin(); [n,c,d,m].forEach(i=>i.value="");
}

async function addQ() {
    const sid = document.getElementById('subSel').value, t = document.getElementById('qTxt'), a = document.getElementById('oA'), b = document.getElementById('oB'), c = document.getElementById('oC'), cor = document.getElementById('cor');
    db.questions.push({ id: Date.now().toString(36), subjectId: sid, question: t.value, A: a.value, B: b.value, C: c.value, correct: cor.value });
    await sync(); renderQList(sid); [t,a,b,c].forEach(i=>i.value="");
}

function renderAdmin() {
    const sl = document.getElementById('subList'); sl.innerHTML = "";
    const ss = document.getElementById('subSel'); ss.innerHTML = "";
    db.subjects.forEach(s => {
        sl.innerHTML += `<tr><td>${s.name}</td><td>${s.class}</td><td>${s.duration}m</td><td><button class="${s.released?'success':'muted'}" onclick="togRel('${s.id}')">${s.released?'Public':'Private'}</button></td><td><button onclick="delSub('${s.id}')" class="danger">X</button></td></tr>`;
        ss.innerHTML += `<option value="${s.id}">${s.name} (${s.class})</option>`;
    });
    renderRes();
}

function renderRes() {
    const rl = document.getElementById('resList'); rl.innerHTML = "";
    db.scores.forEach(s => {
        const st = db.students.find(x => x.id === s.studentId);
        if(st) rl.innerHTML += `<tr><td>${st.name}</td><td>${s.subName}</td><td>${s.score}/${s.total}</td><td>${s.strikes}</td><td><button onclick="printRes('${s.id}')" class="success">Print</button></td><td><button onclick="delRes('${s.id}')" class="danger">X</button></td></tr>`;
    });
}

window.togRel = async (id) => { const s = db.subjects.find(x=>x.id===id); s.released = !s.released; await sync(); renderAdmin(); };
window.delSub = async (id) => { if(confirm("Delete?")) { db.subjects = db.subjects.filter(x=>x.id!==id); await sync(); renderAdmin(); }};
window.delRes = async (id) => { if(confirm("Delete result?")) { db.scores = db.scores.filter(x=>x.id!==id); await sync(); renderAdmin(); }};

function printRes(id) {
    const s = db.scores.find(x => x.id === id), st = db.students.find(x => x.id === s.studentId);
    document.getElementById('pName').innerText = st.name;
    document.getElementById('pClass').innerText = st.class;
    document.getElementById('pSub').innerText = s.subName;
    document.getElementById('pDate').innerText = new Date().toLocaleDateString();
    document.getElementById('pScore').innerText = `${s.score} / ${s.total}`;
    const perc = (s.score / s.total) * 100;
    document.getElementById('pRemark').innerText = perc >= 50 ? "PASS" : "FAIL";
    document.getElementById('printArea').style.display = 'block';
    window.print();
    document.getElementById('printArea').style.display = 'none';
}

/* EXAM */
function renderStuPanel() {
    const sel = document.getElementById('stuSubSel'); sel.innerHTML = "";
    db.subjects.filter(s => s.class === user.class).forEach(s => {
        const done = db.scores.find(sc => sc.studentId === user.id && sc.subjectId === s.id);
        sel.innerHTML += `<option value="${s.id}" ${done?'disabled':''}>${s.name} ${done?'(Done)':''}</option>`;
    });
}

function startExam() {
    const sid = document.getElementById('stuSubSel').value, sub = db.subjects.find(s=>s.id===sid), qs = db.questions.filter(q=>q.subjectId===sid);
    if(!qs.length) return alert("No questions.");
    const shuff = [...qs].sort(() => Math.random() - 0.5);
    ex = { sub, qs: shuff, ans: Array(shuff.length).fill(null), idx: 0, time: sub.duration * 60, strikes: 0 };
    document.getElementById('examView').classList.remove('hidden'); document.getElementById('exTitle').textContent = sub.name;
    timer = setInterval(() => {
        ex.time--; 
        const m = Math.floor(ex.time/60), s = ex.time%60;
        document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if(ex.time <= 0) finish();
    }, 1000);
    drawQ();
}

function drawQ() {
    const q = ex.qs[ex.idx];
    document.getElementById('qBox').innerHTML = `<p><strong>Question ${ex.idx+1}:</strong> ${q.question}</p>` + 
    ['A','B','C'].map(o => `<div class="option-card ${ex.ans[ex.idx]===o?'selected':''}" onclick="pick('${o}')">${o}. ${q[o]}</div>`).join("");
    document.getElementById('finBtn').classList.toggle('hidden', ex.idx !== ex.qs.length-1);
    const g = document.getElementById('navGrid'); g.innerHTML = "";
    ex.qs.forEach((_,i) => g.innerHTML += `<div class="nav-btn ${ex.idx===i?'active':''} ${ex.ans[i]?'answered':''}" onclick="ex.idx=${i};drawQ()">${i+1}</div>`);
}

window.pick = (o) => { ex.ans[ex.idx] = o; drawQ(); };
window.move = (d) => { if(ex.qs[ex.idx+d]) { ex.idx += d; drawQ(); } };

async function finish() {
    clearInterval(timer);
    let sc = 0; ex.qs.forEach((q,i) => { if(ex.ans[i]===q.correct) sc += Number(ex.sub.marks); });
    db.scores.push({ id: Date.now().toString(36), studentId: user.id, subjectId: ex.sub.id, subName: ex.sub.name, score: sc, total: ex.qs.length * ex.sub.marks, strikes: ex.strikes, ans: ex.ans, qs: ex.qs });
    await sync(); alert("Exam Finished!"); location.reload();
}

document.addEventListener("visibilitychange", () => { if(ex && document.visibilityState==='hidden') { ex.strikes++; alert("No tab switching!"); if(ex.strikes >= 3) finish(); } });

load();
</script>
</body>
</html>
