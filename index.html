<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (Final)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#246bff; --soft-blue:#eaf3ff; --muted:#6c7a89; --danger:#e53935;
      --success:#2e9a4a; --card-bg:#fff; --surface:#f4f7fb; --table-hover:#f6f9ff;
    }
    body{font-family:Inter, Roboto, Arial, sans-serif; margin:0; background:var(--surface); color:#111;}
    .wrap{max-width:1200px; margin:18px auto; padding:0 16px 60px;}
    /* Header */
    .app-header{background:var(--blue); color:#fff; padding:12px 20px; border-radius:8px; display:flex; align-items:center; gap:16px;}
    .logo{height:48px; width:auto; border-radius:6px; background:#fff; padding:4px;}
    .site-title{font-size:18px; font-weight:700;}
    .site-sub{font-size:13px; color:rgba(255,255,255,0.9);}
    /* Cards & layout */
    .card{background:var(--card-bg); border-radius:10px; padding:14px; margin-bottom:14px; box-shadow:0 6px 18px rgba(10,20,40,0.04);}
    h2,h3{margin:6px 0;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .muted{color:var(--muted); font-size:13px;}
    input, select, textarea{padding:8px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; background:white;}
    textarea{min-height:56px;}
    button{border:0; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600;}
    button.primary{background:var(--blue); color:white;}
    button.muted{background:#f0f3f8; color:#222;}
    button.danger{background:var(--danger); color:white;}
    button.small{padding:6px 8px; font-size:13px; border-radius:6px;}
    /* Tabs */
    .tabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;}
    .tab-btn{background:white; border:1px solid #e5ecff; padding:8px 12px; border-radius:999px; color:var(--muted); cursor:pointer;}
    .tab-btn.active{background:var(--blue); color:white; border-color:var(--blue);}
    /* Tables */
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{padding:10px; border-bottom:1px solid #f1f5f9; text-align:left; vertical-align:middle;}
    thead th{background:#fbfdff; font-weight:700;}
    tbody tr:hover{background:var(--table-hover);}
    .actions button{margin-right:6px;}
    /* Exam */
    .timer{font-weight:700; color:var(--danger);}
    .exam-option{padding:12px; border-radius:8px; border:1px solid #e6eefc; background:white; cursor:pointer;}
    .exam-option.selected{background:var(--soft-blue); outline:3px solid rgba(36,107,255,0.12);}
    .qkeys{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;}
    .qkey{width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid #e6eefc; background:white; cursor:pointer;}
    .qkey.active{background:var(--blue); color:white; border-color:var(--blue);}
    .qkey.answered{background:#ecf9f0; color:var(--success); border-color:#cfead4;}
    /* Filters area */
    .filters-row{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;}
    .filters-right{margin-left:auto; display:flex; gap:8px; align-items:center;}
    /* Footer */
    footer{margin-top:20px; text-align:center; color:var(--muted); font-size:13px; padding:10px;}
    /* Responsive improvements */
    @media (max-width:900px){
      .filters-right{width:100%; justify-content:flex-end;}
    }
    @media (max-width:700px){
      .row{flex-direction:column; align-items:stretch;}
      input, select, textarea, button{width:100%;}
      .app-header{flex-direction:column; align-items:flex-start; gap:8px;}
      .qkey{width:36px; height:36px;}
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <header class="app-header card">
      <img src="logo.png" alt="School Logo" class="logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">The Valued Child (TVC) High School — CBT</div>
        <div class="site-sub">Computer Based Testing Portal</div>
      </div>
    </header>

    <!-- LOGIN (first) -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row" style="margin-top:8px;">
        <input id="loginUser" placeholder="Username (admin or student)" />
        <input id="loginClass" placeholder="Class (students only, e.g. JSS1)" />
        <input id="loginPass" type="password" placeholder="Password" />
        <button id="btnLogin" class="primary">Login</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="muted">Admin: <strong>admin / admin</strong></div>
        <div class="muted" style="margin-left:12px;">Student demo: <strong>stud1 / 1234 / JSS1</strong></div>
      </div>
      <p id="loginMsg" class="muted" style="margin-top:8px;"></p>
    </div>

    <!-- ADMIN -->
    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:12px; align-items:center;">
          <h2 style="margin:0;">Admin Dashboard</h2>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnSaveLS" class="muted small">Save (local)</button>
          <button id="btnClearLS" class="muted small">Clear Data</button>
          <button id="btnLogoutAdmin" class="muted small">Logout</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Admin tabs">
        <button class="tab-btn active" data-tab="tab-subjects">Subjects</button>
        <button class="tab-btn" data-tab="tab-questions">Questions</button>
        <button class="tab-btn" data-tab="tab-students">Students</button>
        <button class="tab-btn" data-tab="tab-results">Results</button>
      </div>

      <!-- SUBJECTS TAB -->
      <section id="tab-subjects" class="tab-content">
        <div class="card" style="position:relative;">
          <div class="filters-row">
            <label class="muted">Select Class:</label>
            <select id="subjectsClassFilter"></select>

            <div class="filters-right">
              <button id="resetSubjectsFilter" class="muted small">Reset Filters</button>
              <button id="deleteAllSubjectsInClass" class="danger small">Delete All Subjects in Class</button>
            </div>
          </div>

          <h3>Manage Subjects</h3>
          <div style="margin-top:8px;" class="row">
            <input id="newSubjectInput" placeholder="Subject name (e.g. Mathematics)" />
            <input id="newSubjectDuration" type="number" min="1" placeholder="Duration (mins)" style="width:160px;" />
            <input id="newSubjectMarks" type="number" min="1" placeholder="Marks per question" style="width:160px;" />
            <input id="newSubjectClassInput" placeholder="Class (e.g. JSS1)" style="width:160px;" />
            <button id="btnAddSubject" class="primary">Add Subject</button>
          </div>

          <table style="margin-top:12px;">
            <thead><tr><th>Subject</th><th>Class</th><th>Duration</th><th>Marks / Q</th><th>Actions</th></tr></thead>
            <tbody id="subjectsTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- QUESTIONS TAB -->
      <section id="tab-questions" class="tab-content hidden">
        <div class="card" style="position:relative;">
          <div class="filters-row">
            <label class="muted">Class:</label>
            <select id="questionsClassFilter"></select>
            <label class="muted">Subject:</label>
            <select id="questionsSubjectFilter"></select>

            <div class="filters-right">
              <button id="resetQuestionsFilter" class="muted small">Reset Filters</button>
              <button id="deleteAllQuestionsInSubject" class="danger small">Delete All Questions in Subject</button>
            </div>
          </div>

          <h3>Manage Questions (A / B / C only)</h3>
          <div style="margin-top:8px;">
            <textarea id="questionText" placeholder="Question text"></textarea>
          </div>
          <div class="row" style="margin-top:8px;">
            <input id="optionA" placeholder="Option A" />
            <input id="optionB" placeholder="Option B" />
            <input id="optionC" placeholder="Option C" />
          </div>
          <div class="row" style="margin-top:8px;">
            <label class="muted">Correct:</label>
            <select id="correctOption"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
            <button id="btnAddQuestion" class="primary">Add Question</button>
            <div class="muted" style="margin-left:12px;">(Selected Subject remains after adding)</div>
          </div>

          <table style="margin-top:12px;">
            <thead><tr><th>#</th><th>Question</th><th>Subject</th><th>Correct</th><th>Actions</th></tr></thead>
            <tbody id="questionsTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- STUDENTS TAB -->
      <section id="tab-students" class="tab-content hidden">
        <div class="card" style="position:relative;">
          <div class="filters-row">
            <label class="muted">Select Class:</label>
            <select id="studentsClassFilter"></select>

            <div class="filters-right">
              <button id="resetStudentsFilter" class="muted small">Reset Filters</button>
            </div>
          </div>

          <h3>Manage Students</h3>
          <div class="row" style="margin-top:8px;">
            <input id="stuUsername" placeholder="Username" />
            <input id="stuFullName" placeholder="Full name" />
            <input id="stuClass" placeholder="Class (e.g. JSS1)" style="width:160px;" />
            <input id="stuPassword" placeholder="Password" style="width:160px;" />
            <button id="btnAddStudent" class="primary">Add Student</button>
          </div>

          <table style="margin-top:12px;">
            <thead><tr><th>Username</th><th>Full name</th><th>Class</th><th>Actions</th></tr></thead>
            <tbody id="studentsTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- RESULTS TAB -->
      <section id="tab-results" class="tab-content hidden">
        <div class="card" style="position:relative;">
          <div class="filters-row">
            <label class="muted">Select Class:</label>
            <select id="resultsClassFilter"></select>

            <div class="filters-right">
              <button id="resetResultsFilter" class="muted small">Reset Filters</button>
              <button id="btnExportStudents" class="muted small">Export Students CSV</button>
              <button id="btnExportResults" class="muted small">Export Results CSV</button>
            </div>
          </div>

          <h3>Results</h3>
          <table style="margin-top:12px;">
            <thead id="resultsThead"></thead>
            <tbody id="resultsTbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- STUDENT PANEL -->
    <div id="studentCard" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 id="studentHeader">Student Panel</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnLogoutStudent" class="muted small">Logout</button>
        </div>
      </div>

      <div class="card">
        <h3>Take Exam</h3>
        <div class="row" style="margin-top:8px;">
          <label class="muted">Class (locked):</label>
          <input id="studentClassDisplay" disabled style="width:160px;" />
          <label class="muted">Select Subject:</label>
          <select id="studentSubjectDropdown" style="min-width:220px;"></select>
          <button id="btnStartExam" class="primary">Start Exam</button>
        </div>
        <p class="muted" style="margin-top:8px;">Completed subjects are disabled. After submitting an exam you will only see a confirmation (scores are admin-only).</p>
      </div>

      <div id="examCard" class="card hidden">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h3 id="examSubjectTitle"></h3>
          <div class="muted">Time left: <span id="examTimer" class="timer">--:--</span></div>
        </div>

        <div id="examQuestionBox" class="card" style="margin-top:12px; padding:12px;"></div>

        <div class="row" style="justify-content:space-between; align-items:center; margin-top:8px;">
          <div class="row">
            <button id="btnPrevQ" class="muted small">Previous</button>
            <button id="btnNextQ" class="primary small">Next</button>
            <button id="btnSubmitExam" class="danger small hidden">Submit</button>
          </div>
          <div id="examProgress" class="muted"></div>
        </div>

        <div id="questionKeys" class="qkeys" style="margin-top:12px;"></div>
        <p id="examMsg" class="muted"></p>
      </div>
    </div>

    <footer>© 2025 The Valued Child (TVC) High School — Powered by CBT System</footer>
  </div>

<script>
/* =========================
   Storage keys and helpers
   ========================= */
const DB_KEY = "tvc_cbt_db_v_final";
const ADMIN_FILTERS_KEY = "tvc_admin_filters_v1";
const EXAM_SAVE_KEY = "tvc_exam_progress_v1";

function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){ const raw = localStorage.getItem(DB_KEY); if(raw) db = JSON.parse(raw); }
function saveAdminFilters(){ localStorage.setItem(ADMIN_FILTERS_KEY, JSON.stringify(adminFilters)); }
function loadAdminFilters(){ const raw = localStorage.getItem(ADMIN_FILTERS_KEY); if(raw) adminFilters = JSON.parse(raw); }
function saveExamProgress(obj){ localStorage.setItem(EXAM_SAVE_KEY, JSON.stringify(obj)); }
function loadExamProgress(){ const raw = localStorage.getItem(EXAM_SAVE_KEY); return raw ? JSON.parse(raw) : null; }
function clearExamProgress(){ localStorage.removeItem(EXAM_SAVE_KEY); }

/* utility */
function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*9999).toString(36); }
function escapeHtml(s){ if(s == null) return ""; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'"}[m])); }
function downloadCSV(content, filename){ const blob = new Blob([content], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

/* =========================
   In-memory DB (persisted)
   Structure:
   subjects: {id,name,class,duration,marksPerQuestion}
   questions: {id,subjectId,question,A,B,C,correct}
   students: {id,username,name,class,password}
   scores: {studentId,subjectId,subject,score,totalMarks}
   ========================= */
let db = { subjects: [], questions: [], students: [], scores: [] };
loadDB();

/* =========================
   Admin filters persisted (sticky)
   subjectsClass, questionsClass, questionsSubject, studentsClass, resultsClass
   ========================= */
let adminFilters = { subjectsClass: "", questionsClass: "", questionsSubject: "", studentsClass: "", resultsClass: "" };
loadAdminFilters();

/* =========================
   Exam state (for current student session)
   examState structure saved to EXAM_SAVE_KEY:
   { studentId, subjectId, subjectName, subjectClass, durationSec, index, questions, answers, totalMarks, savedAt }
   ========================= */
let examState = null;
let examInterval = null;

/* =========================
   Seed demo data if empty
   ========================= */
(function seedDemo(){
  if(db.subjects.length || db.questions.length || db.students.length) return;
  const subId = uid();
  db.subjects.push({ id: subId, name: "Mathematics", class: "JSS1", duration: 5, marksPerQuestion: 1 });
  db.subjects.push({ id: uid(), name: "English Language", class: "JSS1", duration: 5, marksPerQuestion: 1 });
  db.questions.push({ id: uid(), subjectId: subId, question: "What is 2 + 2?", A: "3", B: "4", C: "5", correct: "B" });
  db.questions.push({ id: uid(), subjectId: subId, question: "What is 3 + 1?", A: "4", B: "3", C: "5", correct: "A" });
  db.students.push({ id: uid(), username: "stud1", name: "John Doe", class: "JSS1", password: "1234" });
  saveDB();
})();

/* =========================
   UI element refs
   ========================= */
const loginCard = document.getElementById('loginCard');
const adminCard = document.getElementById('adminCard');
const studentCard = document.getElementById('studentCard');

const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginClass = document.getElementById('loginClass');
const loginMsg = document.getElementById('loginMsg');

const btnLogin = document.getElementById('btnLogin');
const btnLogoutAdmin = document.getElementById('btnLogoutAdmin');
const btnLogoutStudent = document.getElementById('btnLogoutStudent');
const btnSaveLS = document.getElementById('btnSaveLS');
const btnClearLS = document.getElementById('btnClearLS');

/* Admin elements */
const tabButtons = document.querySelectorAll('.tab-btn');
const subjectsClassFilter = document.getElementById('subjectsClassFilter');
const studentsClassFilter = document.getElementById('studentsClassFilter');
const questionsClassFilter = document.getElementById('questionsClassFilter');
const questionsSubjectFilter = document.getElementById('questionsSubjectFilter');
const resultsClassFilter = document.getElementById('resultsClassFilter');

const resetSubjectsFilter = document.getElementById('resetSubjectsFilter');
const resetQuestionsFilter = document.getElementById('resetQuestionsFilter');
const resetStudentsFilter = document.getElementById('resetStudentsFilter');
const resetResultsFilter = document.getElementById('resetResultsFilter');

const deleteAllSubjectsInClass = document.getElementById('deleteAllSubjectsInClass');
const deleteAllQuestionsInSubject = document.getElementById('deleteAllQuestionsInSubject');

/* Subjects add */
const newSubjectInput = document.getElementById('newSubjectInput');
const newSubjectClassInput = document.getElementById('newSubjectClassInput');
const newSubjectDuration = document.getElementById('newSubjectDuration');
const newSubjectMarks = document.getElementById('newSubjectMarks');
const btnAddSubject = document.getElementById('btnAddSubject');
const subjectsTbody = document.getElementById('subjectsTbody');

/* Questions add */
const questionText = document.getElementById('questionText');
const optionA = document.getElementById('optionA');
const optionB = document.getElementById('optionB');
const optionC = document.getElementById('optionC');
const correctOption = document.getElementById('correctOption');
const btnAddQuestion = document.getElementById('btnAddQuestion');
const questionsTbody = document.getElementById('questionsTbody');

/* Students add */
const stuUsername = document.getElementById('stuUsername');
const stuFullName = document.getElementById('stuFullName');
const stuClass = document.getElementById('stuClass');
const stuPassword = document.getElementById('stuPassword');
const btnAddStudent = document.getElementById('btnAddStudent');
const studentsTbody = document.getElementById('studentsTbody');

/* Results */
const resultsThead = document.getElementById('resultsThead');
const resultsTbody = document.getElementById('resultsTbody');
const btnExportStudents = document.getElementById('btnExportStudents');
const btnExportResults = document.getElementById('btnExportResults');

/* Student panel */
const studentHeader = document.getElementById('studentHeader');
const studentClassDisplay = document.getElementById('studentClassDisplay');
const studentSubjectDropdown = document.getElementById('studentSubjectDropdown');
const btnStartExam = document.getElementById('btnStartExam');
const examCard = document.getElementById('examCard');
const examSubjectTitle = document.getElementById('examSubjectTitle');
const examTimerEl = document.getElementById('examTimer');
const examQuestionBox = document.getElementById('examQuestionBox');
const btnPrevQ = document.getElementById('btnPrevQ');
const btnNextQ = document.getElementById('btnNextQ');
const btnSubmitExam = document.getElementById('btnSubmitExam');
const questionKeys = document.getElementById('questionKeys');
const examProgress = document.getElementById('examProgress');
const examMsg = document.getElementById('examMsg');

/* =========================
   Tab switching (Admin)
   ========================= */
tabButtons.forEach(btn => btn.addEventListener('click', () => {
  tabButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
  document.getElementById(btn.dataset.tab).classList.remove('hidden');
}));

/* =========================
   Load / render helpers
   ========================= */
function getUniqueClasses(){
  // collect classes from subjects and students
  const classes = new Set();
  db.subjects.forEach(s => classes.add(s.class));
  db.students.forEach(s => classes.add(s.class));
  return Array.from(classes).sort();
}
function populateClassFilters(){
  const classes = getUniqueClasses();
  // subjectsClassFilter
  const fill = (sel, requireEmpty) => {
    const prev = sel.value || "";
    sel.innerHTML = '<option value="">-- select class --</option>';
    classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.appendChild(opt); });
    // restore saved filter if any
    let key = "";
    if(sel === subjectsClassFilter) key = adminFilters.subjectsClass;
    if(sel === questionsClassFilter) key = adminFilters.questionsClass;
    if(sel === studentsClassFilter) key = adminFilters.studentsClass;
    if(sel === resultsClassFilter) key = adminFilters.resultsClass;
    if(key) sel.value = key;
    if(prev && !sel.value) { /* if previous existed but not in classes, leave empty */ }
  };
  fill(subjectsClassFilter);
  fill(questionsClassFilter);
  fill(studentsClassFilter);
  fill(resultsClassFilter);
}

/* ================
   SUBJECTS TAB
   ================ */
function renderSubjectsTable(){
  subjectsTbody.innerHTML = "";
  const cls = adminFilters.subjectsClass;
  if(!cls){ subjectsTbody.innerHTML = '<tr><td colspan="5" class="muted">Please select a class to view subjects.</td></tr>'; return; }
  const subs = db.subjects.filter(s => s.class === cls);
  if(!subs.length){ subjectsTbody.innerHTML = '<tr><td colspan="5" class="muted">No subjects for this class yet.</td></tr>'; return; }
  subs.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.name)}</td>
                    <td>${escapeHtml(s.class)}</td>
                    <td>${s.duration}</td>
                    <td>${s.marksPerQuestion}</td>
                    <td class="actions">
                      <button class="small" onclick="editSubject('${s.id}')">Edit</button>
                      <button class="small danger" onclick="deleteSubject('${s.id}')">Delete</button>
                    </td>`;
    subjectsTbody.appendChild(tr);
  });
}

/* Add subject */
btnAddSubject.addEventListener('click', () => {
  const name = newSubjectInput.value.trim();
  const cls = newSubjectClassInput.value.trim();
  const dur = parseInt(newSubjectDuration.value, 10);
  const marks = parseFloat(newSubjectMarks.value);
  if(!name || !cls || isNaN(dur) || isNaN(marks) || dur <= 0 || marks <= 0) return alert("Please enter subject name, class, duration (mins) and marks per question.");
  db.subjects.push({ id: uid(), name, class: cls, duration: dur, marksPerQuestion: marks });
  newSubjectInput.value = ""; newSubjectClassInput.value = ""; newSubjectDuration.value = ""; newSubjectMarks.value = "";
  saveDB();
  populateClassFilters();
  // if admin had selected this class, keep it
  if(adminFilters.subjectsClass === cls) renderSubjectsTable();
  else { adminFilters.subjectsClass = cls; saveAdminFilters(); subjectsClassFilter.value = cls; renderSubjectsTable(); }
});

/* Subject edit/delete */
window.editSubject = function(id){
  const s = db.subjects.find(x => x.id == id); if(!s) return alert("Subject not found");
  const name = prompt("Subject name:", s.name);
  const cls = prompt("Class:", s.class);
  const dur = prompt("Duration (mins):", s.duration);
  const marks = prompt("Marks per question:", s.marksPerQuestion);
  if(name !== null && name.trim()) s.name = name.trim();
  if(cls !== null && cls.trim()) s.class = cls.trim();
  const dnum = parseInt(dur,10); if(!isNaN(dnum) && dnum>0) s.duration = dnum;
  const mnum = parseFloat(marks); if(!isNaN(mnum) && mnum>0) s.marksPerQuestion = mnum;
  saveDB(); populateClassFilters(); renderSubjectsTable(); renderQuestionSubjects(); prepareStudentSubjectDropdown(); refreshResultsFilters(); renderResults();
};

window.deleteSubject = function(id){
  if(!confirm("Delete this subject and its questions?")) return;
  db.questions = db.questions.filter(q => q.subjectId != id);
  db.subjects = db.subjects.filter(s => s.id != id);
  saveDB(); populateClassFilters(); renderSubjectsTable(); renderQuestionSubjects(); prepareStudentSubjectDropdown(); refreshResultsFilters(); renderResults();
};

/* Delete all subjects in class (bulk) */
deleteAllSubjectsInClass.addEventListener('click', () => {
  const cls = adminFilters.subjectsClass;
  if(!cls) return alert("Select a class first.");
  if(!confirm(`Delete ALL subjects in ${cls}? This will also delete related questions. Continue?`)) return;
  const subjectIds = db.subjects.filter(s => s.class === cls).map(s => s.id);
  db.questions = db.questions.filter(q => !subjectIds.includes(q.subjectId));
  db.subjects = db.subjects.filter(s => s.class !== cls);
  saveDB(); populateClassFilters(); renderSubjectsTable(); renderQuestionSubjects(); prepareStudentSubjectDropdown(); refreshResultsFilters(); renderResults();
});

/* Reset filter (subjects) */
resetSubjectsFilter.addEventListener('click', () => {
  adminFilters.subjectsClass = "";
  saveAdminFilters();
  subjectsClassFilter.value = "";
  renderSubjectsTable();
});

/* subjectsClassFilter onchange (required) */
subjectsClassFilter.addEventListener('change', () => {
  adminFilters.subjectsClass = subjectsClassFilter.value;
  saveAdminFilters();
  renderSubjectsTable();
});

/* =========================
   QUESTIONS TAB
   Must select class first, then subject
   ========================= */
function renderQuestionSubjects(){
  // fill questionsSubjectFilter based on questionsClassFilter
  const cls = adminFilters.questionsClass;
  questionsSubjectFilter.innerHTML = '<option value="">-- select subject --</option>';
  if(!cls) return;
  const subs = db.subjects.filter(s => s.class === cls);
  subs.forEach(s => {
    const opt = document.createElement('option'); opt.value = s.id; opt.text = `${s.name} (${s.class}) — ${s.duration}m • ${s.marksPerQuestion} mark(s)`; questionsSubjectFilter.appendChild(opt);
  });
  if(adminFilters.questionsSubject) questionsSubjectFilter.value = adminFilters.questionsSubject;
}

/* render questions table, filtered by class -> subject */
function renderQuestionsTable(){
  questionsTbody.innerHTML = "";
  const cls = adminFilters.questionsClass;
  const subjId = adminFilters.questionsSubject;
  if(!cls){ questionsTbody.innerHTML = '<tr><td colspan="5" class="muted">Please select a Class first.</td></tr>'; return; }
  if(!subjId){ questionsTbody.innerHTML = '<tr><td colspan="5" class="muted">Please select a Subject from that class to view questions.</td></tr>'; return; }
  const qs = db.questions.filter(q => q.subjectId === subjId);
  if(!qs.length){ questionsTbody.innerHTML = '<tr><td colspan="5" class="muted">No questions for this subject yet.</td></tr>'; return; }
  let i=1;
  qs.forEach(q => {
    const subj = db.subjects.find(s => s.id == q.subjectId);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i++}</td>
                    <td>${escapeHtml(q.question)}</td>
                    <td>${subj ? escapeHtml(subj.name + ' ('+subj.class+')') : '-'}</td>
                    <td>${q.correct}</td>
                    <td class="actions">
                      <button class="small" onclick="editQuestion('${q.id}')">Edit</button>
                      <button class="small danger" onclick="deleteQuestion('${q.id}')">Delete</button>
                    </td>`;
    questionsTbody.appendChild(tr);
  });
}

/* Add question (requires class & subject selected) */
btnAddQuestion.addEventListener('click', () => {
  const cls = adminFilters.questionsClass;
  const subjId = adminFilters.questionsSubject;
  const text = questionText.value.trim();
  const A = optionA.value.trim();
  const B = optionB.value.trim();
  const C = optionC.value.trim();
  const correct = correctOption.value;
  if(!cls) return alert("Select a Class first.");
  if(!subjId) return alert("Select a Subject first.");
  if(!text || !A || !B || !C) return alert("Fill question and options A, B, C.");
  db.questions.push({ id: uid(), subjectId: subjId, question: text, A, B, C, correct });
  questionText.value = ""; optionA.value = ""; optionB.value = ""; optionC.value = "";
  saveDB(); renderQuestionsTable(); // keep subject selected intentionally
});

/* edit / delete question */
window.editQuestion = function(id){
  const q = db.questions.find(x => x.id == id); if(!q) return alert("Question not found");
  const text = prompt("Question text:", q.question);
  const A = prompt("Option A:", q.A);
  const B = prompt("Option B:", q.B);
  const C = prompt("Option C:", q.C);
  const correct = prompt("Correct (A/B/C):", q.correct);
  if(text !== null && text.trim()) q.question = text.trim();
  if(A !== null) q.A = A;
  if(B !== null) q.B = B;
  if(C !== null) q.C = C;
  if(correct !== null && ['A','B','C'].includes(correct.toUpperCase())) q.correct = correct.toUpperCase();
  saveDB(); renderQuestionsTable();
};

window.deleteQuestion = function(id){
  if(!confirm("Delete this question?")) return;
  db.questions = db.questions.filter(q => q.id != id);
  saveDB(); renderQuestionsTable();
};

/* Delete all questions in subject */
deleteAllQuestionsInSubject.addEventListener('click', () => {
  const cls = adminFilters.questionsClass;
  const subjId = adminFilters.questionsSubject;
  if(!cls || !subjId) return alert("Select class and subject first.");
  const subj = db.subjects.find(s => s.id == subjId);
  if(!confirm(`Delete all questions in ${subj.name} (${subj.class})? This cannot be undone.`)) return;
  db.questions = db.questions.filter(q => q.subjectId != subjId);
  saveDB(); renderQuestionsTable();
});

/* Reset questions filter */
resetQuestionsFilter.addEventListener('click', () => {
  adminFilters.questionsClass = ""; adminFilters.questionsSubject = "";
  saveAdminFilters(); questionsClassFilter.value = ""; questionsSubjectFilter.innerHTML = '<option value="">-- select subject --</option>';
  renderQuestionsTable();
});

/* questionsClassFilter change */
questionsClassFilter.addEventListener('change', () => {
  adminFilters.questionsClass = questionsClassFilter.value;
  adminFilters.questionsSubject = ""; // require subject selection again
  saveAdminFilters();
  renderQuestionSubjects();
  renderQuestionsTable();
});

/* questionsSubjectFilter change */
questionsSubjectFilter.addEventListener('change', () => {
  adminFilters.questionsSubject = questionsSubjectFilter.value;
  saveAdminFilters();
  renderQuestionsTable();
});

/* =========================
   STUDENTS TAB
   Must select class first
   ========================= */
function renderStudentsTable(){
  studentsTbody.innerHTML = "";
  const cls = adminFilters.studentsClass;
  if(!cls){ studentsTbody.innerHTML = '<tr><td colspan="4" class="muted">Please select a class to view students.</td></tr>'; return; }
  const list = db.students.filter(s => s.class === cls);
  if(!list.length){ studentsTbody.innerHTML = '<tr><td colspan="4" class="muted">No students for this class yet.</td></tr>'; return; }
  list.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.username)}</td>
                    <td>${escapeHtml(s.name)}</td>
                    <td>${escapeHtml(s.class)}</td>
                    <td class="actions">
                      <button class="small" onclick="editStudent('${s.id}')">Edit</button>
                      <button class="small danger" onclick="deleteStudent('${s.id}')">Delete</button>
                    </td>`;
    studentsTbody.appendChild(tr);
  });
}

/* add student */
btnAddStudent.addEventListener('click', () => {
  const username = stuUsername.value.trim();
  const name = stuFullName.value.trim();
  const cls = stuClass.value.trim();
  const pwd = stuPassword.value.trim();
  if(!username || !name || !cls || !pwd) return alert("Fill all student fields.");
  if(db.students.some(s => s.username === username)) return alert("Username already exists.");
  db.students.push({ id: uid(), username, name, class: cls, password: pwd });
  stuUsername.value = ""; stuFullName.value = ""; stuClass.value = ""; stuPassword.value = "";
  saveDB(); populateClassFilters(); renderStudentsTable(); refreshResultsFilters(); renderResults(); prepareStudentSubjectDropdown();
});

/* edit/delete student */
window.editStudent = function(id){
  const s = db.students.find(x => x.id == id); if(!s) return alert("Student not found");
  const name = prompt("Full name:", s.name);
  const cls = prompt("Class:", s.class);
  const pwd = prompt("Password (leave blank to keep):", "");
  if(name !== null && name.trim()) s.name = name.trim();
  if(cls !== null && cls.trim()) s.class = cls.trim();
  if(pwd !== null && pwd.trim()) s.password = pwd;
  saveDB(); populateClassFilters(); renderStudentsTable(); refreshResultsFilters(); renderResults();
};

window.deleteStudent = function(id){
  if(!confirm("Delete student and their scores?")) return;
  db.students = db.students.filter(s => s.id != id);
  db.scores = db.scores.filter(sc => sc.studentId != id);
  saveDB(); populateClassFilters(); renderStudentsTable(); refreshResultsFilters(); renderResults();
};

/* Reset students filter */
resetStudentsFilter.addEventListener('click', () => {
  adminFilters.studentsClass = "";
  saveAdminFilters(); studentsClassFilter.value = ""; renderStudentsTable();
});

/* studentsClassFilter change */
studentsClassFilter.addEventListener('change', () => {
  adminFilters.studentsClass = studentsClassFilter.value;
  saveAdminFilters(); renderStudentsTable();
});

/* =========================
   RESULTS (admin)
   Requires selecting class
   ========================= */
function refreshResultsFilters(){
  const classes = getUniqueClasses();
  const sel = resultsClassFilter;
  const prev = sel.value;
  sel.innerHTML = '<option value="">-- select class --</option>';
  classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.appendChild(opt); });
  if(adminFilters.resultsClass) sel.value = adminFilters.resultsClass;
}
function renderResults(){
  resultsThead.innerHTML = ""; resultsTbody.innerHTML = "";
  const cls = adminFilters.resultsClass;
  if(!cls){ resultsThead.innerHTML = '<tr><th class="muted">Select a class to view results</th></tr>'; return; }
  // filter scores to class
  const studentsInClass = db.students.filter(s => s.class === cls).map(s => s.id);
  const scoresFiltered = db.scores.filter(sc => studentsInClass.includes(sc.studentId));
  if(!scoresFiltered.length){ resultsThead.innerHTML = `<tr><th>No results for ${cls}</th></tr>`; return; }
  const studentsMap = {}, subjectsMap = {};
  scoresFiltered.forEach(sc => {
    const st = db.students.find(s => s.id == sc.studentId);
    if(st) studentsMap[st.id] = { name: st.name, class: st.class };
    subjectsMap[sc.subjectId] = sc.subject;
  });
  const sids = Object.keys(studentsMap), subids = Object.keys(subjectsMap);
  // header
  let head = "<tr><th>Student</th><th>Class</th>";
  subids.forEach(id => head += `<th>${escapeHtml(subjectsMap[id])}</th>`);
  head += "<th>Total</th><th>Percentage</th></tr>";
  resultsThead.innerHTML = head;
  // rows
  sids.forEach(sid => {
    const st = studentsMap[sid];
    let row = `<tr><td>${escapeHtml(st.name)}</td><td>${escapeHtml(st.class)}</td>`;
    let total = 0, maxTotal = 0;
    subids.forEach(subid => {
      const sc = scoresFiltered.find(x => x.studentId == sid && x.subjectId == subid);
      if(sc){ row += `<td>${sc.score} / ${sc.totalMarks}</td>`; total += Number(sc.score); maxTotal += Number(sc.totalMarks); }
      else row += `<td>N/A</td>`;
    });
    const pct = maxTotal ? (total / maxTotal * 100) : 0;
    row += `<td>${total}</td><td>${pct.toFixed(2)}%</td></tr>`;
    resultsTbody.insertAdjacentHTML('beforeend', row);
  });
}

/* export CSV */
btnExportStudents.addEventListener('click', () => {
  if(!db.students.length) return alert("No students.");
  let csv = "username,fullName,class\n";
  db.students.forEach(s => csv += `${s.username},"${s.name}",${s.class}\n`);
  downloadCSV(csv, "students_all.csv");
});

btnExportResults.addEventListener('click', () => {
  const cls = adminFilters.resultsClass;
  if(!cls) return alert("Select a class to export results.");
  const studentsInClass = db.students.filter(s => s.class === cls).map(s => s.id);
  const scoresFiltered = db.scores.filter(sc => studentsInClass.includes(sc.studentId));
  if(!scoresFiltered.length) return alert("No results for selected class.");
  const studentsMap = {}, subjectsMap = {};
  scoresFiltered.forEach(sc => {
    const st = db.students.find(s => s.id == sc.studentId);
    if(st) studentsMap[st.id] = { name: st.name, class: st.class };
    subjectsMap[sc.subjectId] = sc.subject;
  });
  const sids = Object.keys(studentsMap), subids = Object.keys(subjectsMap);
  let csv = "Student,Class";
  subids.forEach(id => csv += `,${subjectsMap[id]}`);
  csv += ",Total,Percentage\n";
  sids.forEach(sid => {
    const st = studentsMap[sid];
    let total = 0, maxTotal = 0;
    let line = `"${st.name}",${st.class}`;
    subids.forEach(subid => {
      const sc = scoresFiltered.find(x => x.studentId == sid && x.subjectId == subid);
      if(sc){ line += `,${sc.score}/${sc.totalMarks}`; total += Number(sc.score); maxTotal += Number(sc.totalMarks); }
      else line += ",N/A";
    });
    const pct = maxTotal ? (total / maxTotal * 100) : 0;
    line += `,${total},${pct.toFixed(2)}%\n`;
    csv += line;
  });
  downloadCSV(csv, `results_${cls}.csv`);
});

/* reset results filter */
resetResultsFilter.addEventListener('click', () => {
  adminFilters.resultsClass = ""; saveAdminFilters(); resultsClassFilter.value = ""; renderResults();
});
resultsClassFilter.addEventListener('change', () => { adminFilters.resultsClass = resultsClassFilter.value; saveAdminFilters(); renderResults(); });

/* refresh results filters list */
function refreshResultsFilters(){ const classes = getUniqueClasses(); resultsClassFilter.innerHTML = '<option value="">-- select class --</option>'; classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; resultsClassFilter.appendChild(opt); }); if(adminFilters.resultsClass) resultsClassFilter.value = adminFilters.resultsClass; }

/* =========================
   STUDENT PANEL
   Student login shows class (disabled) and subjects only for that class
   ========================= */
let currentUser = null;

btnLogin.addEventListener('click', () => {
  const username = loginUser.value.trim();
  const password = loginPass.value.trim();
  const cls = loginClass.value.trim();
  if(username === "admin" && password === "admin"){
    currentUser = { role: "admin", username: "admin" };
    loginCard.classList.add('hidden'); adminCard.classList.remove('hidden');
    // populate filters and restore saved adminFilters
    populateClassFilters(); // populates filters with existing classes
    // restore adminFilters selections
    subjectsClassFilter.value = adminFilters.subjectsClass || "";
    questionsClassFilter.value = adminFilters.questionsClass || "";
    studentsClassFilter.value = adminFilters.studentsClass || "";
    questionsSubjectFilter.value = adminFilters.questionsSubject || "";
    resultsClassFilter.value = adminFilters.resultsClass || "";
    renderSubjectsTable(); renderQuestionSubjects(); renderQuestionsTable(); renderStudentsTable(); refreshResultsFilters(); renderResults();
    loginMsg.textContent = "";
    return;
  }
  // student login
  const stud = db.students.find(s => s.username === username && s.password === password && s.class === cls);
  if(!stud){ loginMsg.textContent = "Invalid username, password, or class."; return; }
  currentUser = { role: "student", ...stud };
  loginCard.classList.add('hidden'); studentCard.classList.remove('hidden');
  studentHeader.textContent = `Student Panel — ${stud.name} (${stud.class})`;
  studentClassDisplay.value = stud.class;
  prepareStudentSubjectDropdown();
  loginMsg.textContent = "";
  // check for saved exam progress and offer resume if matches this student
  const saved = loadExamProgress();
  if(saved && saved.studentId === stud.id){
    if(confirm(`Resume your ${saved.subjectName} (${saved.subjectClass}) exam from last session?`)){
      examState = saved; startExamUIFromSaved();
    } else {
      // clear saved if they don't want to resume
      clearExamProgress();
    }
  }
});

/* logout */
btnLogoutAdmin.addEventListener('click', () => {
  currentUser = null; adminCard.classList.add('hidden'); loginCard.classList.remove('hidden');
});
btnLogoutStudent.addEventListener('click', () => {
  if(confirm("Logout? Any in-progress exam will be saved for resume.")) {
    currentUser = null; stopExamTimer(); studentCard.classList.add('hidden'); examCard.classList.add('hidden'); loginCard.classList.remove('hidden');
  }
});

/* Save/clear local */
btnSaveLS.addEventListener('click', () => { saveDB(); alert("Saved to localStorage."); });
btnClearLS.addEventListener('click', () => {
  if(!confirm("This will remove ALL saved data (DB, filters, exam progress). Continue?")) return;
  localStorage.removeItem(DB_KEY); localStorage.removeItem(ADMIN_FILTERS_KEY); localStorage.removeItem(EXAM_SAVE_KEY);
  db = { subjects: [], questions: [], students: [], scores: [] };
  adminFilters = { subjectsClass: "", questionsClass: "", questionsSubject: "", studentsClass: "", resultsClass: "" };
  saveDB(); saveAdminFilters(); alert("Cleared. Refreshing page."); location.reload();
});

/* prepare student subject dropdown (only class-specific) */
function prepareStudentSubjectDropdown(){
  studentSubjectDropdown.innerHTML = '<option value="">-- select subject --</option>';
  if(!currentUser) return;
  const subs = db.subjects.filter(s => s.class === currentUser.class);
  subs.forEach(s => {
    const done = db.scores.some(sc => sc.studentId == currentUser.id && sc.subjectId == s.id);
    const opt = document.createElement('option'); opt.value = s.id; opt.text = `${s.name} (${s.duration}m) ${done ? '— Completed' : ''}`; if(done) opt.disabled = true;
    studentSubjectDropdown.appendChild(opt);
  });
}

/* =========================
   EXAM FLOW WITH AUTOSAVE + RESUME + NAV WARNING
   autosave triggers whenever student selects an option or navigates
   ========================= */
function startExam(subjectId){
  const subj = db.subjects.find(s => s.id == subjectId);
  if(!subj) return alert("Subject not found.");
  const qlist = db.questions.filter(q => q.subjectId === subjectId);
  if(!qlist.length) return alert("No questions for this subject yet.");
  examState = {
    studentId: currentUser.id,
    subjectId: subj.id,
    subjectName: subj.name,
    subjectClass: subj.class,
    durationSec: subj.duration * 60,
    index: 0,
    questions: qlist,
    answers: Array(qlist.length).fill(null),
    totalMarks: qlist.length * (Number(subj.marksPerQuestion) || 1),
    savedAt: Date.now()
  };
  // show UI
  examCard.classList.remove('hidden');
  examSubjectTitle.textContent = `${subj.name} — ${subj.class}`;
  renderExamQuestion();
  renderExamKeys();
  startExamTimer();
  // autosave initial state
  saveExamProgress();
  // navigation warning enabled
  window.addEventListener('beforeunload', beforeUnloadGuard);
}

function startExamUIFromSaved(){
  if(!examState) return;
  examCard.classList.remove('hidden');
  examSubjectTitle.textContent = `${examState.subjectName} — ${examState.subjectClass}`;
  renderExamQuestion();
  renderExamKeys();
  startExamTimer();
  window.addEventListener('beforeunload', beforeUnloadGuard);
}

/* render single question */
function renderExamQuestion(){
  if(!examState) return;
  const i = examState.index;
  const q = examState.questions[i];
  const a = examState.answers[i];
  examQuestionBox.innerHTML = `<div class="muted">Question ${i+1} of ${examState.questions.length}</div>
    <h3 style="margin:8px 0">${escapeHtml(q.question)}</h3>
    <div style="display:grid;gap:10px">
      <div id="optA" class="exam-option ${a==='A'?'selected':''}" onclick="studentChoose('A')"><strong>A.</strong> ${escapeHtml(q.A)}</div>
      <div id="optB" class="exam-option ${a==='B'?'selected':''}" onclick="studentChoose('B')"><strong>B.</strong> ${escapeHtml(q.B)}</div>
      <div id="optC" class="exam-option ${a==='C'?'selected':''}" onclick="studentChoose('C')"><strong>C.</strong> ${escapeHtml(q.C)}</div>
    </div>`;
  btnPrevQ.disabled = (i === 0);
  const last = (i === examState.questions.length - 1);
  btnNextQ.classList.toggle('hidden', last);
  btnSubmitExam.classList.toggle('hidden', !last);
  examProgress.textContent = `Q ${i+1} / ${examState.questions.length}`;
  renderExamKeys();
}

/* choose answer (autosave immediately) */
window.studentChoose = function(letter){
  if(!examState) return;
  examState.answers[examState.index] = letter;
  examState.savedAt = Date.now();
  renderExamQuestion();
  renderExamKeys();
  saveExamProgress();
};

/* navigation */
btnPrevQ.addEventListener('click', () => {
  if(!examState) return;
  if(examState.index > 0) { examState.index--; examState.savedAt = Date.now(); renderExamQuestion(); saveExamProgress(); }
});
btnNextQ.addEventListener('click', () => {
  if(!examState) return;
  if(examState.index < examState.questions.length - 1) { examState.index++; examState.savedAt = Date.now(); renderExamQuestion(); saveExamProgress(); }
});

/* question keys */
function renderExamKeys(){
  questionKeys.innerHTML = "";
  if(!examState) return;
  for(let i=0;i<examState.questions.length;i++){
    const div = document.createElement('div');
    div.className = 'qkey' + (i === examState.index ? ' active' : '') + (examState.answers[i] ? ' answered' : '');
    div.textContent = i+1;
    div.addEventListener('click', () => { examState.index = i; examState.savedAt = Date.now(); renderExamQuestion(); saveExamProgress(); });
    questionKeys.appendChild(div);
  }
}

/* autosave: write examState to localStorage */
function saveExamProgress(){
  if(!examState) return;
  const toSave = Object.assign({}, examState); toSave.savedAt = Date.now();
  saveExamProgressToStorage(toSave);
}

/* helper for saving into storage */
function saveExamProgressToStorage(obj){
  try{ localStorage.setItem(EXAM_SAVE_KEY, JSON.stringify(obj)); } catch(e){ console.error("Error saving exam progress", e); }
}

/* stop timer */
function stopExamTimer(){ if(examInterval){ clearInterval(examInterval); examInterval = null; } }

/* start timer */
function startExamTimer(){
  stopExamTimer();
  updateTimerLabel();
  examInterval = setInterval(() => {
    if(!examState) { stopExamTimer(); return; }
    examState.durationSec--;
    updateTimerLabel();
    // autosave on timer tick occasionally (but we already save on actions)
    if(examState.durationSec % 10 === 0) { saveExamProgress(); }
    if(examState.durationSec <= 0) {
      stopExamTimer();
      examMsg.textContent = "Time is up — auto-submitting...";
      setTimeout(() => finalizeExam(true), 800);
    }
  }, 1000);
}

function updateTimerLabel(){
  if(!examState){ examTimerEl.textContent = "--:--"; return; }
  const s = Math.max(0, examState.durationSec);
  const mm = Math.floor(s/60).toString().padStart(2,"0");
  const ss = Math.floor(s%60).toString().padStart(2,"0");
  examTimerEl.textContent = `${mm}:${ss}`;
}

/* load & clear exam progress helpers */
function loadSavedExam(){
  return loadExamProgress();
}
function saveExamProgress(){ if(!examState) return; examState.savedAt = Date.now(); saveExamProgressToStorage(examState); }
function clearSavedExam(){ clearExamProgress(); }

/* beforeunload guard */
function beforeUnloadGuard(e){
  if(examState){
    e.preventDefault();
    e.returnValue = "You have an unfinished exam. Are you sure you want to leave?";
    return e.returnValue;
  }
}

/* Submit with confirmation and finalization */
btnSubmitExam.addEventListener('click', () => {
  if(!examState) return;
  const unanswered = examState.answers.reduce((acc,a,i)=> a?acc:acc.concat(i+1), []);
  let msg = "Are you sure you want to submit your answers?";
  if(unanswered.length) msg = `You left ${unanswered.length} unanswered (questions: ${unanswered.join(", ")}). Submit anyway?`;
  if(!confirm(msg)) return;
  finalizeExam(false);
});

/* finalize exam: compute score, save to db.scores, clear saved progress, hide UI */
function finalizeExam(isAuto){
  if(!examState) return;
  const subj = db.subjects.find(s => s.id == examState.subjectId);
  const marksPerQ = subj ? (Number(subj.marksPerQuestion) || 1) : 1;
  let score = 0, totalMarks = 0;
  examState.questions.forEach((q, idx) => {
    totalMarks += marksPerQ;
    if(examState.answers[idx] && examState.answers[idx] === q.correct) score += marksPerQ;
  });
  // record result (students do NOT see score)
  db.scores.push({ studentId: currentUser.id, subjectId: examState.subjectId, subject: examState.subjectName, score, totalMarks });
  saveDB();
  // cleanup
  stopExamTimer();
  clearSavedExam();
  window.removeEventListener('beforeunload', beforeUnloadGuard);
  examState = null;
  examCard.classList.add('hidden');
  prepareStudentSubjectDropdown(); renderResults();
  alert("Your exam has been submitted successfully. The administrator will view your score.");
}

/* =========================
   Admin filters persistence on load
   ========================= */
function initAdminFiltersUI(){
  // populate class lists
  populateClassFilters();
  // restore question subjects select for selected class
  if(adminFilters.questionsClass) {
    questionsClassFilter.value = adminFilters.questionsClass;
    renderQuestionSubjects();
  }
  // restore other selects
  if(adminFilters.questionsSubject) questionsSubjectFilter.value = adminFilters.questionsSubject;
  if(adminFilters.subjectsClass) subjectsClassFilter.value = adminFilters.subjectsClass;
  if(adminFilters.studentsClass) studentsClassFilter.value = adminFilters.studentsClass;
  if(adminFilters.resultsClass) resultsClassFilter.value = adminFilters.resultsClass;
}

/* on page load render admin UI based on filters */
function renderAllAdmin(){
  populateClassFilters();
  renderSubjectsTable();
  renderQuestionSubjects();
  renderQuestionsTable();
  renderStudentsTable();
  refreshResultsFilters();
  renderResults();
}

/* load admin filters from localStorage variables (already loaded into adminFilters) */

/* Reset filters: generic */
resetSubjectsFilter.addEventListener('click', () => { adminFilters.subjectsClass = ""; saveAdminFilters(); subjectsClassFilter.value = ""; renderSubjectsTable(); });
resetQuestionsFilter.addEventListener('click', () => { adminFilters.questionsClass = ""; adminFilters.questionsSubject = ""; saveAdminFilters(); questionsClassFilter.value = ""; questionsSubjectFilter.innerHTML = '<option value="">-- select subject --</option>'; renderQuestionsTable(); });
resetStudentsFilter.addEventListener('click', () => { adminFilters.studentsClass = ""; saveAdminFilters(); studentsClassFilter.value = ""; renderStudentsTable(); });
resetResultsFilter.addEventListener('click', () => { adminFilters.resultsClass = ""; saveAdminFilters(); resultsClassFilter.value = ""; renderResults(); });

/* wire up class filters to change & persist */
subjectsClassFilter.addEventListener('change', () => { adminFilters.subjectsClass = subjectsClassFilter.value; saveAdminFilters(); renderSubjectsTable(); });
questionsClassFilter.addEventListener('change', () => { adminFilters.questionsClass = questionsClassFilter.value; adminFilters.questionsSubject = ""; saveAdminFilters(); renderQuestionSubjects(); renderQuestionsTable(); });
questionsSubjectFilter.addEventListener('change', () => { adminFilters.questionsSubject = questionsSubjectFilter.value; saveAdminFilters(); renderQuestionsTable(); });
studentsClassFilter.addEventListener('change', () => { adminFilters.studentsClass = studentsClassFilter.value; saveAdminFilters(); renderStudentsTable(); });
resultsClassFilter.addEventListener('change', () => { adminFilters.resultsClass = resultsClassFilter.value; saveAdminFilters(); renderResults(); });

/* Save admin filters at start */
saveAdminFilters();

/* =========================
   Helpers invoked at startup
   ========================= */
function populateClassFilters(){
  const classes = getUniqueClasses();
  // subject filter selectors (subjectsClassFilter already exists)
  const setOptions = (sel, savedKeyVal) => {
    const prev = sel.value;
    sel.innerHTML = '<option value="">-- select class --</option>';
    classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.appendChild(opt); });
    if(savedKeyVal) sel.value = savedKeyVal;
  };
  setOptions(subjectsClassFilter, adminFilters.subjectsClass);
  setOptions(questionsClassFilter, adminFilters.questionsClass);
  setOptions(studentsClassFilter, adminFilters.studentsClass);
  setOptions(resultsClassFilter, adminFilters.resultsClass);
  // if questionsClassFilter saved, render subject options
  renderQuestionSubjects();
}

/* initial render for admin at load if logged in */
if(!currentUser && document.readyState === "complete"){
  // nothing; admin will load on login
}

/* =========================
   On startup, attach last saved admin filter values if any
   ========================= */
initAdminFiltersUI();

/* render initial tables (if admin opens later) */
renderAllAdmin();

/* Expose some functions used inline */
window.editSubject = window.editSubject;
window.deleteSubject = window.deleteSubject;
window.editQuestion = window.editQuestion;
window.deleteQuestion = window.deleteQuestion;
window.editStudent = window.editStudent;
window.deleteStudent = window.deleteStudent;

/* =========================
   Load saved exam progress helper
   ========================= */
function saveAdminFiltersToStorage(){ saveAdminFilters(); }
function loadAdminFiltersFromStorage(){ loadAdminFilters(); }
function loadExamProgress(){ const raw = localStorage.getItem(EXAM_SAVE_KEY); return raw ? JSON.parse(raw) : null; }
function clearExamProgress(){ localStorage.removeItem(EXAM_SAVE_KEY); }

/* Make sure adminFilters is saved initially */
saveAdminFilters();

</script>
</body>
</html>
