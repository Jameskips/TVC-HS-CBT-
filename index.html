<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TVC High School CBT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }
    input, select { padding: 6px; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>TVC High School CBT</h1>

  <!-- Login -->
  <div id="loginScreen" class="card">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden card">
    <h2>Admin Panel</h2>
    <button onclick="showSection('subjects')">Manage Subjects</button>
    <button onclick="showSection('questions')">Manage Questions</button>
    <button onclick="showSection('scores')">View Scores</button>
    <button onclick="logout()">Logout</button>

    <div id="subjects" class="hidden">
      <h3>Subjects</h3>
      <input type="text" id="newSubject" placeholder="New Subject">
      <button onclick="addSubject()">Add</button>
      <ul id="subjectList"></ul>
    </div>

    <div id="questions" class="hidden">
      <h3>Questions</h3>
      <select id="qSubject"></select><br>
      <textarea id="qText" placeholder="Question"></textarea><br>
      <input type="text" id="opt1" placeholder="Option 1"><br>
      <input type="text" id="opt2" placeholder="Option 2"><br>
      <input type="text" id="opt3" placeholder="Option 3"><br>
      <input type="text" id="opt4" placeholder="Option 4"><br>
      <input type="number" id="qAnswer" placeholder="Correct Option (1-4)"><br>
      <button onclick="addQuestion()">Add Question</button>
      <ul id="questionList"></ul>
    </div>

    <div id="scores" class="hidden">
      <h3>Scores</h3>
      <ul id="scoreList"></ul>
    </div>
  </div>

  <!-- Student Panel -->
  <div id="studentPanel" class="hidden card">
    <h2>Take Exam</h2>
    <select id="examSubject"></select>
    <button onclick="startExam()">Start Exam</button>
    <div id="examArea"></div>
    <div id="timer"></div>
  </div>

<script>
const BIN_ID = "68b38b2fd0ea881f406c6764";  // ⬅️ Replace
const API_KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy"; // ⬅️ Replace
const ADMIN_USER = "admin";
const ADMIN_PASS = "1234"; // Changeable

let currentUser = null;
let db = { subjects: [], questions: [], scores: [] };

// ===== JSONBin Helpers =====
async function fetchData() {
  const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  });
  const data = await res.json();
  db = data.record;
}

async function updateData() {
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify(db)
  });
}

// ===== Login =====
async function login() {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;

  if (u === ADMIN_USER && p === ADMIN_PASS) {
    currentUser = "admin";
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    await fetchData();
    renderSubjects();
    renderQuestions();
    renderScores();
  } else {
    currentUser = u;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("studentPanel").classList.remove("hidden");
    await fetchData();
    renderExamSubjects();
  }
}

function logout() {
  location.reload();
}

// ===== Subjects =====
async function addSubject() {
  const s = document.getElementById("newSubject").value.trim();
  if (!s) return;
  db.subjects.push({ id: Date.now(), name: s });
  await updateData();
  renderSubjects();
  renderExamSubjects();
  document.getElementById("newSubject").value = "";
}

function renderSubjects() {
  const ul = document.getElementById("subjectList");
  ul.innerHTML = "";
  db.subjects.forEach(sub => {
    const li = document.createElement("li");
    li.textContent = sub.name;
    ul.appendChild(li);
  });
  const sel = document.getElementById("qSubject");
  sel.innerHTML = "";
  db.subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub.id;
    opt.textContent = sub.name;
    sel.appendChild(opt);
  });
}

function renderExamSubjects() {
  const sel = document.getElementById("examSubject");
  sel.innerHTML = "";
  db.subjects.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub.id;
    opt.textContent = sub.name;
    sel.appendChild(opt);
  });
}

// ===== Questions =====
async function addQuestion() {
  const q = {
    id: Date.now(),
    subjectId: parseInt(document.getElementById("qSubject").value),
    question: document.getElementById("qText").value,
    options: [
      document.getElementById("opt1").value,
      document.getElementById("opt2").value,
      document.getElementById("opt3").value,
      document.getElementById("opt4").value
    ],
    answer: parseInt(document.getElementById("qAnswer").value) - 1
  };
  db.questions.push(q);
  await updateData();
  renderQuestions();
}

function renderQuestions() {
  const ul = document.getElementById("questionList");
  ul.innerHTML = "";
  db.questions.forEach(q => {
    const li = document.createElement("li");
    const subj = db.subjects.find(s => s.id === q.subjectId)?.name || "";
    li.textContent = subj + ": " + q.question;
    ul.appendChild(li);
  });
}

// ===== Scores =====
function renderScores() {
  const ul = document.getElementById("scoreList");
  ul.innerHTML = "";
  db.scores.forEach(s => {
    const li = document.createElement("li");
    li.textContent = s.student + " - " + s.subject + ": " + s.score;
    ul.appendChild(li);
  });
}

// ===== Exam =====
let examQ = [], examIndex = 0, score = 0, timer;

function startExam() {
  const subjId = parseInt(document.getElementById("examSubject").value);
  examQ = db.questions.filter(q => q.subjectId === subjId);
  if (examQ.length === 0) { alert("No questions yet."); return; }
  examIndex = 0; score = 0;
  showQuestion();
  startTimer(60); // 60 seconds
}

function showQuestion() {
  if (examIndex >= examQ.length) return finishExam();
  const q = examQ[examIndex];
  let html = `<h3>${q.question}</h3>`;
  q.options.forEach((opt, i) => {
    html += `<label><input type="radio" name="ans" value="${i}"> ${opt}</label><br>`;
  });
  html += `<button onclick="nextQ()">Next</button>`;
  document.getElementById("examArea").innerHTML = html;
}

function nextQ() {
  const ans = document.querySelector("input[name=ans]:checked");
  if (ans && parseInt(ans.value) === examQ[examIndex].answer) score++;
  examIndex++;
  if (examIndex < examQ.length) {
    showQuestion();
  } else {
    finishExam();
  }
}

async function finishExam() {
  clearInterval(timer);
  const subjId = parseInt(document.getElementById("examSubject").value);
  const subj = db.subjects.find(s => s.id === subjId)?.name;
  db.scores.push({ student: currentUser, subject: subj, score: score });
  await updateData();
  document.getElementById("examArea").innerHTML = "<h3>Exam finished. Your score is recorded.</h3>";
}

function startTimer(seconds) {
  let timeLeft = seconds;
  timer = setInterval(() => {
    document.getElementById("timer").textContent = "Time left: " + timeLeft + "s";
    if (timeLeft <= 0) {
      finishExam();
    }
    timeLeft--;
  }, 1000);
}

// ===== UI Helper =====
function showSection(id) {
  ["subjects","questions","scores"].forEach(sec => {
    document.getElementById(sec).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}
</script>
</body>
</html>
