<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVC High School — CBT (Complete)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      color:#222; 
      background: #c3e0ff;
      background: linear-gradient(135deg, #c3e0ff 0%, #d8f0ff 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: radial-gradient(circle at top left, rgba(255,255,255,0.2) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .wrap { 
      max-width:1100px; 
      margin: 18px auto; 
      flex-grow: 1; 
      padding: 0 10px;
    }
    header h1 { 
      margin: 4px 0 18px; 
      font-size:24px; 
      color:#1a237e; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
      font-weight: bold;
    }
    .card { 
      background:#fff; 
      border:1px solid #e6e9ee; 
      border-radius:16px; 
      padding:20px; 
      margin-bottom:20px; 
      box-shadow:0 6px 20px rgba(0,0,0,0.08); 
      transition: box-shadow 0.3s ease;
    }
    .card:hover { box-shadow:0 8-px 24px rgba(0,0,0,0.12); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    input, select, textarea, button { font-family: inherit; font-size:15px; }
    input, select, textarea { 
      padding:12px; 
      border:1px solid #dfe6ef; 
      border-radius:10px; 
      background: #fdfefe;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus { 
      border-color: #246bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(36, 107, 255, 0.1);
    }
    button { 
      padding:12px 20px; 
      border-radius:10px; 
      cursor:pointer; 
      border:0; 
      font-weight: 600; 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    button.primary { background:#246bff; color:#fff; transition: background-color 0.2s; }
    button.primary:hover { background:#1e5be0; }
    button.muted { background:#f0f3f8; color:#222; transition: background-color 0.2s; }
    button.muted:hover { background:#e5e8ec; }
    button.danger { background:#e53935; color:#fff; transition: background-color 0.2s; }
    button.danger:hover { background:#c62828; }
    button.small { padding:8px 16px; font-size:14px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:14px; border:1px solid #eef2f6; text-align:left; vertical-align:middle; }
    th { background:#fafcff; }
    .muted { color:#666; font-size:14px; }
    .hidden { display:none; }
    .timer { font-weight:700; color:#e53935; font-size: 1.1em; }
    .exam-option { 
      padding:16px; 
      border:1px solid #d9e2ef; 
      border-radius:10px; 
      cursor:pointer; 
      background:#fdfefe; 
      transition: box-shadow 0.2s, transform 0.2s; 
    }
    .exam-option:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .exam-option.selected { 
      background:#e8f0ff; 
      outline:3px solid rgba(36,107,255,0.12); 
      border-color: #246bff; 
      box-shadow: 0 2px 8px rgba(36, 107, 255, 0.1);
      transform: none;
    }
    .qkeys { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .qkey { 
      width:44px; 
      height:44px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      border:1px solid #d9e3f5; 
      border-radius:10px; 
      cursor:pointer; 
      user-select:none; 
      background:#fff; 
      font-weight:600;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .qkey:hover { background: #f0f3f8; }
    .qkey.active { background:#246bff; color:#fff; border-color:#246bff; }
    .qkey.answered { background:#eaf3ff; color:#0b57ff; border-color:#cfe3ff; }
    .pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#eef5ff; color:#1350d6; font-size:13px; font-weight: bold; }

    /* Accordion CSS */
    .accordion details {
        background:#fff;
        border:1px solid #e6e9ee;
        border-radius:16px;
        margin-bottom:20px;
        box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }
    .accordion summary {
        padding:20px;
        font-size:18px;
        font-weight:bold;
        cursor:pointer;
        user-select:none;
        outline:none;
    }
    .accordion summary::-webkit-details-marker { display:none; }
    .accordion .accordion-content {
        padding:20px;
        border-top:1px solid #e6e9ee;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header><h1>The Valued Child (TVC) High School — CBT</h1></header>

    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="loginUser" placeholder="Username (admin or student)" />
        <input id="loginClass" placeholder="Class (for students, e.g. JSS1)" />
        <input id="loginPass" type="password" placeholder="Password" />
        <button id="btnLogin" class="primary">Login</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </div>

    <div id="adminCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Admin Dashboard</h2>
        <div class="row">
          <button id="btnSaveLS" class="muted">Save (local)</button>
          <button id="btnClearLS" class="muted">Clear Data</button>
          <button id="btnLogoutAdmin" class="muted">Logout</button>
        </div>
      </div>

      <div class="accordion">
        <details open>
          <summary>Subjects</summary>
          <div class="accordion-content">
            <h3>Subjects — duration & marks-per-question</h3>
            <div class="row">
              <input id="newSubjectInput" placeholder="Subject name (e.g. Mathematics)" />
              <input id="newSubjectClassInput" placeholder="Class (e.g. JSS1)" />
              <input id="newSubjectDuration" type="number" min="1" placeholder="Duration (mins)" style="width:160px" />
              <input id="newSubjectMarks" type="number" min="1" placeholder="Marks per question" style="width:160px" />
              <button id="btnAddSubject" class="primary">Add Subject</button>
            </div>
            <div class="row">
                <label class="muted">Filter by class:</label>
                <select id="subjectClassFilter">
                  <option value="" disabled selected>-- Select a Class --</option>
                  <option value="all">All Classes</option>
                </select>
            </div>
            <table>
              <thead><tr><th>Subject</th><th>Class</th><th>Duration (mins)</th><th>Marks / Q</th><th>Actions</th></tr></thead>
              <tbody id="subjectsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Questions</summary>
          <div class="accordion-content">
            <h3>Questions (A / B / C only)</h3>
            <div class="row">
              <label class="muted">Subject:</label>
              <select id="questionSubjectSelect" style="min-width:260px"></select>
            </div>
            <div class="row" style="flex-direction:column">
              <textarea id="questionText" rows="2" placeholder="Question text"></textarea>
            </div>
            <div class="row">
              <input id="optionA" placeholder="Option A" />
              <input id="optionB" placeholder="Option B" />
              <input id="optionC" placeholder="Option C" />
            </div>
            <div class="row">
              <label>Correct:</label>
              <select id="correctOption"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
              <button id="btnAddQuestion" class="primary">Add Question</button>
            </div>
            <div class="row">
              <label class="muted">Filter by class:</label>
              <select id="questionClassFilter">
                <option value="" disabled selected>-- Select a Class --</option>
                <option value="all">All Classes</option>
              </select>
              <label class="muted">Filter by subject:</label>
              <select id="questionFilterSubjectSelect">
                <option value="" disabled selected>-- Select a Subject --</option>
                <option value="all">All Subjects</option>
              </select>
            </div>
            <table>
              <thead><tr><th>#</th><th>Question</th><th>Subject</th><th>Correct</th><th>Actions</th></tr></thead>
              <tbody id="questionsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Students</summary>
          <div class="accordion-content">
            <h3>Students (add / edit / delete)</h3>
            <div class="row">
              <input id="stuUsername" placeholder="Username" />
              <input id="stuFullName" placeholder="Full name" />
              <input id="stuClass" placeholder="Class (e.g. JSS1)" />
              <input id="stuPassword" placeholder="Password" />
              <button id="btnAddStudent" class="primary">Add Student</button>
            </div>
            <div class="row">
              <label class="muted">Filter by class:</label>
              <select id="studentClassFilter">
                <option value="" disabled selected>-- Select a Class --</option>
                <option value="all">All Classes</option>
              </select>
            </div>
            <table>
              <thead><tr><th>Username</th><th>Name</th><th>Class</th><th>Actions</th></tr></thead>
              <tbody id="studentsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Results</summary>
          <div class="accordion-content">
            <h3>Results (admin)</h3>
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <label class="muted">Filter by class:</label>
                <select id="adminStudentClassFilter">
                  <option value="" disabled selected>-- Select a Class --</option>
                  <option value="all">All Classes</option>
                </select>
              </div>
              <div class="row">
                <label class="muted">Reset by subject:</label>
                <select id="resetSubjectDropdown"><option value="" disabled selected>-- Select Subject --</option></select>
                <button id="btnResetSubject" class="danger">Reset All</button>
                <button id="btnExportStudents" class="muted">Export Students CSV</button>
                <button id="btnExportResults" class="muted">Export Results CSV</button>
              </div>
            </div>
            <table>
              <thead id="resultsThead"></thead>
              <tbody id="resultsTbody"></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <div id="answerSheetCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2 id="answerSheetHeader"></h2>
        <button id="btnCloseAnswerSheet" class="muted">Close</button>
      </div>
      <div id="answerSheetContent"></div>
    </div>

    <div id="studentCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2 id="studentHeader">Student Panel</h2>
        <div class="row">
          <button id="btnLogoutStudent" class="muted">Logout</button>
        </div>
      </div>

      <div class="card">
        <h3>Select Subject</h3>
        <div class="row">
          <select id="studentSubjectDropdown" style="min-width:260px"></select>
          <button id="btnStartExam" class="primary">Start Exam</button>
        </div>
        <p class="muted">Completed subjects are disabled. After submitting an exam you will only see a confirmation (score is available to admin).</p>
        <p id="studentMsg" class="muted" style="margin-top:10px"></p>
      </div>

      <div id="examCard" class="card hidden">
        <div class="row" style="justify-content:space-between">
          <h3 id="examSubjectTitle"></h3>
          <div>Time left: <span id="examTimer" class="timer">--:--</span></div>
        </div>

        <div id="examQuestionBox" class="card" style="margin-top:10px"></div>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="btnPrevQ" class="muted">Previous</button>
            <button id="btnNextQ" class="primary">Next</button>
            <button id="btnSubmitExam" class="danger hidden">Submit</button>
          </div>
          <div id="examProgress" class="muted"></div>
        </div>

        <div id="questionKeys" class="qkeys"></div>
        <p id="examMsg" class="muted"></p>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   Persistence & DB
   --------------------------- */
const JSONBIN_MASTER_KEY = "$2a$10$fWok9ba27BiXeCpOUIUYaOKx8SDCAhODlzlPkZ.6pyu3xjClAGuhy";
const JSONBIN_BIN_ID = "68bc605c43b1c97be9391c1d";
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

let db = { subjects: [], questions: [], students: [], scores: [] };

async function saveDB(){
  try {
    const response = await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": JSONBIN_MASTER_KEY
      },
      body: JSON.stringify(db)
    });
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    const data = await response.json();
    console.log("Data saved to JSONBin:", data);
  } catch(e){
    console.error("saveDB error", e);
    alert("Failed to save data online. Check console for details.");
  }
}

async function loadDB(){
  try {
    const response = await fetch(`${JSONBIN_URL}/latest`, {
      method: "GET",
      headers: {
        "X-Master-Key": JSONBIN_MASTER_KEY
      }
    });
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    const data = await response.json();
    if (data.record) {
      db = data.record;
      console.log("Data loaded from JSONBin.");
    }
  } catch(e){
    console.error("loadDB error", e);
    alert("Failed to load data online. Check console for details.");
  }
}

async function commit(){
  await saveDB();
  renderAllAdmin();
}

/* Utility */
function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*9999).toString(36); }
function escapeHtml(s){ if(s==null) return ""; return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]); }
function downloadCSV(content, filename){ const blob=new Blob([content], {type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

/* Accordion Logic */
document.querySelectorAll('.accordion details').forEach(details => {
  details.addEventListener('toggle', () => {
    if (details.open) {
      document.querySelectorAll('.accordion details').forEach(otherDetails => {
        if (otherDetails !== details && otherDetails.open) {
          otherDetails.open = false;
        }
      });
    }
  });
});

/* ---------------------------
   Login / Logout
   --------------------------- */
let currentUser = null;

document.getElementById("btnLogin").onclick = async () => {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  const cls = document.getElementById("loginClass").value.trim();

  await loadDB(); 
  
  if (username === "admin" && password === "admin") {
    currentUser = { role: "admin", username: "admin" };
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("adminCard").classList.remove("hidden");
    renderAllAdmin();
    document.getElementById("loginMsg").textContent = "";
    return;
  }

  const student = db.students.find(s => s.username === username && s.password === password && s.class === cls);
  if (!student) {
    document.getElementById("loginMsg").textContent = "Invalid username, password, or class.";
    return;
  }

  currentUser = { role: "student", ...student };
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("studentCard").classList.remove("hidden");
  document.getElementById("studentHeader").textContent = `Student Panel — ${student.name} (${student.class})`;
  prepareStudentSubjectDropdown();
  document.getElementById("loginMsg").textContent = "";
};

document.getElementById("btnLogoutAdmin").onclick = () => {
  currentUser = null;
  document.getElementById("adminCard").classList.add("hidden");
  document.getElementById("loginCard").classList.remove("hidden");
};
document.getElementById("btnLogoutStudent").onclick = () => {
  currentUser = null;
  stopExamTimer();
  document.getElementById("studentCard").classList.add("hidden");
  document.getElementById("examCard").classList.add("hidden");
  document.getElementById("loginCard").classList.remove("hidden");
};

/* Save/Clear local */
document.getElementById("btnSaveLS").onclick = () => { alert("This button is now disabled. Data is saved online."); };
document.getElementById("btnClearLS").onclick = () => {
  if (!confirm("Clear all saved data? This will clear the online data and cannot be undone.")) return;
  db = { subjects:[], questions:[], students:[], scores:[] };
  commit(); // This will save the empty DB online
  alert("Cleared.");
};

/* ---------------------------
   Admin: Subjects (duration & marks per question)
   --------------------------- */
document.getElementById("btnAddSubject").onclick = () => {
  const name = document.getElementById("newSubjectInput").value.trim();
  const cls = document.getElementById("newSubjectClassInput").value.trim();
  const dur = parseInt(document.getElementById("newSubjectDuration").value, 10);
  const marks = parseFloat(document.getElementById("newSubjectMarks").value);
  if (!name || !cls || !dur || isNaN(marks) || marks <= 0) return alert("Please enter subject, class, duration (mins) and marks per question.");
  db.subjects.push({ id: uid(), name, class: cls, duration: dur, marksPerQuestion: marks });
  document.getElementById("newSubjectInput").value = "";
  document.getElementById("newSubjectClassInput").value = "";
  document.getElementById("newSubjectDuration").value = "";
  document.getElementById("newSubjectMarks").value = "";
  commit();
};

document.getElementById("subjectClassFilter").onchange = () => renderSubjects();

function renderSubjects(){
  const tbody = document.getElementById("subjectsTbody");
  tbody.innerHTML = "";
  const filterClass = document.getElementById("subjectClassFilter").value;
  if (!filterClass) { 
    tbody.innerHTML = "<tr><td colspan='5' class='muted'>Please select a class to view subjects.</td></tr>";
    return;
  }
  const filteredSubjects = db.subjects.filter(s => filterClass === "all" || s.class === filterClass);
  if (!filteredSubjects.length) {
    tbody.innerHTML = "<tr><td colspan='5' class='muted'>No subjects found for this class.</td></tr>";
    return;
  }
  filteredSubjects.forEach(s => {
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.class)}</td>
        <td>${s.duration}</td>
        <td>${s.marksPerQuestion}</td>
        <td>
          <button class="small" onclick="editSubject('${s.id}')">Edit</button>
          <button class="small danger" onclick="deleteSubject('${s.id}')">Delete</button>
        </td>
      </tr>`);
  });
}

async function editSubject(id){
  const s = db.subjects.find(x => x.id == id);
  if (!s) return alert("Subject not found");
  const name = prompt("Subject name:", s.name);
  const cls = prompt("Class:", s.class);
  const durRaw = prompt("Duration (mins):", s.duration);
  const marksRaw = prompt("Marks per question:", s.marksPerQuestion);
  if (name !== null && name.trim()) s.name = name.trim();
  if (cls !== null && cls.trim()) s.class = cls.trim();
  const dur = parseInt(durRaw,10); if (!isNaN(dur) && dur > 0) s.duration = dur;
  const marks = parseFloat(marksRaw); if (!isNaN(marks) && marks > 0) s.marksPerQuestion = marks;
  await commit();
}

async function deleteSubject(id){
  if (!confirm("Delete subject and all its questions and scores?")) return;
  db.questions = db.questions.filter(q => q.subjectId != id);
  db.scores = db.scores.filter(sc => sc.subjectId != id);
  db.subjects = db.subjects.filter(s => s.id != id);
  await commit();
}

/* ---------------------------
   Admin: Questions (A/B/C only). Keep subject selected after add.
   --------------------------- */
function refreshQuestionAddSubjects(){
  const sel = document.getElementById("questionSubjectSelect");
  const prev = sel.value;
  sel.innerHTML = `<option value="" disabled selected>-- Select a Subject --</option>`;
  db.subjects.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.text = `${s.name} (${s.class}) — ${s.duration}m, ${s.marksPerQuestion} mark(s)`;
    sel.appendChild(opt);
  });
  if (prev) sel.value = prev;
}

document.getElementById("btnAddQuestion").onclick = () => {
  const subjectId = document.getElementById("questionSubjectSelect").value;
  const text = document.getElementById("questionText").value.trim();
  const A = document.getElementById("optionA").value.trim();
  const B = document.getElementById("optionB").value.trim();
  const C = document.getElementById("optionC").value.trim();
  const correct = document.getElementById("correctOption").value;
  if (!subjectId || !text || !A || !B || !C) return alert("Fill question and options A, B, C.");
  if (!["A","B","C"].includes(correct)) return alert("Correct must be A, B, or C.");
  db.questions.push({ id: uid(), subjectId, question: text, A, B, C, correct });
  document.getElementById("questionText").value = "";
  document.getElementById("optionA").value = "";
  document.getElementById("optionB").value = "";
  document.getElementById("optionC").value = "";
  commit();
};

document.getElementById("questionClassFilter").onchange = () => {
    refreshQuestionFilterSubjects();
    renderQuestions();
};
document.getElementById("questionFilterSubjectSelect").onchange = () => renderQuestions();

function refreshQuestionFilterSubjects() {
    const classFilter = document.getElementById("questionClassFilter").value;
    const subjectFilter = document.getElementById("questionFilterSubjectSelect");
    const prev = subjectFilter.value;
    subjectFilter.innerHTML = `<option value="" disabled selected>-- Select a Subject --</option>`;
    if (classFilter) {
      const filteredSubjects = db.subjects.filter(s => classFilter === "all" || s.class === classFilter);
      filteredSubjects.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.text = `${s.name} (${s.class})`;
          subjectFilter.appendChild(opt);
      });
      if (prev) subjectFilter.value = prev;
    }
}

function renderQuestions(){
  const tbody = document.getElementById("questionsTbody");
  tbody.innerHTML = "";
  const subjectIdFilter = document.getElementById("questionFilterSubjectSelect").value;
  const classIdFilter = document.getElementById("questionClassFilter").value;
  
  if (!classIdFilter) {
    tbody.innerHTML = "<tr><td colspan='5' class='muted'>Please select a class.</td></tr>";
    return;
  }
  if (!subjectIdFilter) {
    tbody.innerHTML = "<tr><td colspan='5' class='muted'>Please select a subject.</td></tr>";
    return;
  }

  const filteredQuestions = db.questions.filter(q => subjectIdFilter === "all" || q.subjectId === subjectIdFilter);
  if (!filteredQuestions.length) {
    tbody.innerHTML = "<tr><td colspan='5' class='muted'>No questions found for this subject.</td></tr>";
    return;
  }
  let i = 1;
  filteredQuestions.forEach(q => {
    const subj = db.subjects.find(s => s.id == q.subjectId);
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${i++}</td>
        <td>${escapeHtml(q.question)}</td>
        <td>${subj ? escapeHtml(subj.name + " (" + subj.class + ")") : "-"}</td>
        <td>${q.correct}</td>
        <td>
          <button class="small" onclick="editQuestion('${q.id}')">Edit</button>
          <button class="small danger" onclick="deleteQuestion('${q.id}')">Delete</button>
        </td>
      </tr>`);
  });
}

async function editQuestion(id){
  const q = db.questions.find(x => x.id == id);
  if (!q) return alert("Question not found");
  const text = prompt("Question text:", q.question);
  const A = prompt("Option A:", q.A);
  const B = prompt("Option B:", q.B);
  const C = prompt("Option C:", q.C);
  const correct = prompt("Correct (A/B/C):", q.correct);
  if (text !== null && text.trim()) q.question = text.trim();
  if (A !== null) q.A = A;
  if (B !== null) q.B = B;
  if (C !== null) q.C = C;
  if (correct !== null && ["A","B","C"].includes(correct.toUpperCase())) q.correct = correct.toUpperCase();
  await commit();
}

async function deleteQuestion(id){
  if (!confirm("Delete question?")) return;
  db.questions = db.questions.filter(q => q.id != id);
  await commit();
}

/* ---------------------------
   Admin: Students
   --------------------------- */
document.getElementById("btnAddStudent").onclick = () => {
  const username = document.getElementById("stuUsername").value.trim();
  const name = document.getElementById("stuFullName").value.trim();
  const cls = document.getElementById("stuClass").value.trim();
  const pwd = document.getElementById("stuPassword").value.trim();
  if (!username || !name || !cls || !pwd) return alert("Fill all student fields");
  if (db.students.some(s => s.username === username)) return alert("Username already exists");
  db.students.push({ id: uid(), username, name, class: cls, password: pwd });
  document.getElementById("stuUsername").value = "";
  document.getElementById("stuFullName").value = "";
  document.getElementById("stuClass").value = "";
  document.getElementById("stuPassword").value = "";
  commit();
};
document.getElementById("studentClassFilter").onchange = () => renderStudents();

function renderStudents(){
  const tbody = document.getElementById("studentsTbody");
  tbody.innerHTML = "";
  const filterClass = document.getElementById("studentClassFilter").value;
  if (!filterClass) {
    tbody.innerHTML = "<tr><td colspan='4' class='muted'>Please select a class to view students.</td></tr>";
    return;
  }
  const filteredStudents = db.students.filter(s => filterClass === "all" || s.class === filterClass);
  if (!filteredStudents.length) {
    tbody.innerHTML = "<tr><td colspan='4' class='muted'>No students found for this class.</td></tr>";
    return;
  }
  filteredStudents.forEach(s => {
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${escapeHtml(s.username)}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.class)}</td>
        <td>
          <button class="small" onclick="editStudent('${s.id}')">Edit</button>
          <button class="small danger" onclick="deleteStudent('${s.id}')">Delete</button>
        </td>
      </tr>`);
  });
}

async function editStudent(id){
  const s = db.students.find(x => x.id == id);
  if (!s) return alert("Student not found");
  const name = prompt("Full name:", s.name);
  const cls = prompt("Class:", s.class);
  const pwd = prompt("Password (leave blank to keep):", "");
  if (name !== null && name.trim()) s.name = name.trim();
  if (cls !== null && cls.trim()) s.class = cls.trim();
  if (pwd !== null && pwd.trim()) s.password = pwd;
  await commit();
}

async function deleteStudent(id){
  if (!confirm("Delete student and their scores?")) return;
  db.students = db.students.filter(s => s.id != id);
  db.scores = db.scores.filter(sc => sc.studentId != id);
  await commit();
}

/* ---------------------------
   Admin: Results (render & export)
   --------------------------- */
function refreshClassFilters(){
  const classes = [...new Set(db.subjects.map(s => s.class))].sort();
  const filters = ["subjectClassFilter", "questionClassFilter", "adminStudentClassFilter", "studentClassFilter"];
  filters.forEach(id => {
    const sel = document.getElementById(id);
    const curr = sel.value || "";
    sel.innerHTML = `<option value="" disabled selected>-- Select a Class --</option>`;
    sel.innerHTML += `<option value="all">All Classes</option>`;
    classes.forEach(c => {
      const opt = document.createElement("option"); opt.value = c; opt.text = c;
      if (c === curr) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}
document.getElementById("adminStudentClassFilter").onchange = renderResults;

function refreshResetSubjectDropdown() {
  const dropdown = document.getElementById("resetSubjectDropdown");
  const prev = dropdown.value;
  dropdown.innerHTML = `<option value="" disabled selected>-- Select Subject --</option>`;
  db.subjects.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.text = `${s.name} (${s.class})`;
    dropdown.appendChild(opt);
  });
  if (prev) dropdown.value = prev;
}

document.getElementById("btnResetSubject").onclick = async () => {
  const subjectId = document.getElementById("resetSubjectDropdown").value;
  if (!subjectId) return alert("Please select a subject to reset.");
  const subject = db.subjects.find(s => s.id === subjectId);
  if (!subject) return alert("Subject not found.");
  if (!confirm(`Are you sure you want to reset ALL exam results for ${subject.name} (${subject.class})? This cannot be undone.`)) return;

  const initialScoreCount = db.scores.length;
  db.scores = db.scores.filter(sc => sc.subjectId !== subjectId);
  const scoresRemoved = initialScoreCount - db.scores.length;
  await commit();
  alert(`${scoresRemoved} exam result(s) for ${subject.name} have been reset.`);
};

function renderResults(){
  const thead = document.getElementById("resultsThead");
  const tbody = document.getElementById("resultsTbody");
  thead.innerHTML = ""; tbody.innerHTML = "";
  const filter = document.getElementById("adminStudentClassFilter").value;
  
  if (!filter) {
    thead.innerHTML = "<tr><th>Please select a class to view results.</th></tr>";
    return;
  }

  const filtered = db.scores.filter(sc => {
    if (filter === "all") return true;
    const st = db.students.find(s => s.id == sc.studentId);
    return st && st.class === filter;
  });

  if (!filtered.length){ 
    thead.innerHTML = `<tr><th>No results found for ${filter === "all" ? "any class" : filter}.</th></tr>`; 
    return; 
  }

  // Build maps
  const studentsMap = {}, subjectsMap = {};
  filtered.forEach(sc => {
    const st = db.students.find(s => s.id == sc.studentId);
    if (st) studentsMap[st.id] = { name: st.name, class: st.class };
    subjectsMap[sc.subjectId] = sc.subject;
  });
  const sids = Object.keys(studentsMap), subids = Object.keys(subjectsMap);

  // Header
  let head = "<tr><th>Student</th><th>Class</th>";
  subids.forEach(id => head += `<th>${escapeHtml(subjectsMap[id])}</th>`);
  head += "<th>Total</th><th>Percentage</th></tr>";
  thead.innerHTML = head;

  // Rows
  sids.forEach(sid => {
    const st = studentsMap[sid];
    let row = `<tr><td>${escapeHtml(st.name)}</td><td>${escapeHtml(st.class)}</td>`;
    let total = 0, maxTotal = 0;
    subids.forEach(subid => {
      const sc = filtered.find(x => x.studentId == sid && x.subjectId == subid);
      if (sc) { 
        row += `<td>${sc.score} / ${sc.totalMarks} <button class="small muted" onclick="showStudentAnswers('${sc.studentId}', '${sc.subjectId}')">View</button> <button class="small danger" onclick="resetScore('${sc.studentId}', '${sc.subjectId}')">Reset</button></td>`; 
        total += Number(sc.score); 
        maxTotal += Number(sc.totalMarks); 
      }
      else row += `<td>N/A</td>`;
    });
    const pct = maxTotal ? (total / maxTotal * 100) : 0;
    row += `<td>${total}</td><td>${pct.toFixed(2)}%</td></tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

async function resetScore(studentId, subjectId) {
  if (!confirm("Are you sure you want to reset this student's result for this subject?")) return;
  db.scores = db.scores.filter(sc => !(sc.studentId === studentId && sc.subjectId === subjectId));
  await commit();
  alert("Result has been reset. The student can now re-take the exam.");
}

document.getElementById("btnExportStudents").onclick = () => {
  if (!db.students.length) return alert("No students");
  let csv = "username,fullName,class\n";
  db.students.forEach(s => csv += `${s.username},"${s.name}",${s.class}\n`);
  downloadCSV(csv, "students_all.csv");
};

document.getElementById("btnExportResults").onclick = () => {
  const filter = document.getElementById("adminStudentClassFilter").value;
  if (!filter) return alert("Please select a class filter first.");

  const filtered = db.scores.filter(sc => {
    if (filter === "all") return true;
    const st = db.students.find(s => s.id == sc.studentId);
    return st && st.class === filter;
  });

  if (!filtered.length) return alert("No results for this filter");
  // Build maps
  const studentsMap = {}, subjectsMap = {};
  filtered.forEach(sc => {
    const st = db.students.find(s => s.id == sc.studentId);
    if (st) studentsMap[st.id] = { name: st.name, class: st.class };
    subjectsMap[sc.subjectId] = sc.subject;
  });
  const sids = Object.keys(studentsMap), subids = Object.keys(subjectsMap);
  let csv = "Student,Class";
  subids.forEach(id => csv += `,${subjectsMap[id]}`);
  csv += ",Total,Percentage\n";

  sids.forEach(sid => {
    const st = studentsMap[sid];
    let total = 0, maxTotal = 0;
    let line = `"${st.name}",${st.class}`;
    subids.forEach(subid => {
      const sc = filtered.find(x => x.studentId == sid && x.subjectId == subid);
      if (sc) { line += `,${sc.score}/${sc.totalMarks}`; total += Number(sc.score); maxTotal += Number(sc.totalMarks); }
      else line += ",N/A";
    });
    const pct = maxTotal ? (total / maxTotal * 100) : 0;
    line += `,${total},${pct.toFixed(2)}%\n`;
    csv += line;
  });

  downloadCSV(csv, filter === "all" ? "results_all.csv" : `results_${filter}.csv`);
};

/* ---------------------------
   Student: subject dropdown + exam
   --------------------------- */
function prepareStudentSubjectDropdown(){
  const sel = document.getElementById("studentSubjectDropdown");
  sel.innerHTML = `<option value="">-- Select subject --</option>`;
  if (!currentUser) return;
  const subs = db.subjects.filter(s => s.class === currentUser.class);
  subs.forEach(s => {
    const done = db.scores.some(sc => sc.studentId == currentUser.id && sc.subjectId == s.id);
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.text = `${s.name} (${s.duration}m) ${done ? "— Completed": ""}`;
    if (done) opt.disabled = true;
    sel.appendChild(opt);
  });
}

/* Exam state */
let examState = null; 
let examInterval = null;

document.getElementById("btnStartExam").onclick = () => {
  const sid = document.getElementById("studentSubjectDropdown").value;
  if (!sid) return alert("Select a subject first.");
  if (db.scores.some(sc => sc.studentId == currentUser.id && sc.subjectId == sid)) return alert("You already completed this subject.");
  document.getElementById("studentMsg").textContent = ""; 
  startExam(sid);
};

function startExam(subjectId){
  const subj = db.subjects.find(s => s.id == subjectId);
  if (!subj) return alert("Subject not found");
  const questions = db.questions.filter(q => q.subjectId == subjectId);
  if (!questions.length) return alert("No questions for this subject yet.");

  examState = {
    subjectId,
    subjectName: subj.name,
    subjectClass: subj.class,
    durationSec: subj.duration * 60,
    index: 0,
    questions,
    answers: Array(questions.length).fill(null),
    totalMarks: questions.length * (Number(subj.marksPerQuestion) || 1)
  };

  // UI
  document.getElementById("examCard").classList.remove("hidden");
  document.getElementById("examSubjectTitle").textContent = `${subj.name} — ${subj.class}`;
  renderExamQuestion();
  renderExamKeys();
  startExamTimer();
  document.getElementById("examMsg").textContent = "";
}

function renderExamQuestion(){
  if (!examState) return;
  const i = examState.index;
  const q = examState.questions[i];
  const a = examState.answers[i];
  const box = document.getElementById("examQuestionBox");
  box.innerHTML = `
    <div class="muted">Question ${i+1} of ${examState.questions.length}</div>
    <h3 style="margin:8px 0">${escapeHtml(q.question)}</h3>
    <div style="display:grid;gap:10px">
      <div id="optA" class="exam-option ${a==="A"?"selected":""}" onclick="studentSelect('A')"><strong>A.</strong> ${escapeHtml(q.A)}</div>
      <div id="optB" class="exam-option ${a==="B"?"selected":""}" onclick="studentSelect('B')"><strong>B.</strong> ${escapeHtml(q.B)}</div>
      <div id="optC" class="exam-option ${a==="C"?"selected":""}" onclick="studentSelect('C')"><strong>C.</strong> ${escapeHtml(q.C)}</div>
    </div>
  `;
  document.getElementById("btnPrevQ").disabled = (i === 0);
  const last = (i === examState.questions.length - 1);
  document.getElementById("btnNextQ").classList.toggle("hidden", last);
  document.getElementById("btnSubmitExam").classList.toggle("hidden", !last);
  document.getElementById("examProgress").textContent = `Q ${i+1} / ${examState.questions.length}`;
  renderExamKeys();
}

function studentSelect(letter){
  if (!examState) return;
  examState.answers[examState.index] = letter;
  renderExamQuestion();
}

document.getElementById("btnPrevQ").onclick = () => {
  if (!examState) return;
  if (examState.index > 0) { examState.index--; renderExamQuestion(); }
};
document.getElementById("btnNextQ").onclick = () => {
  if (!examState) return;
  if (examState.index < examState.questions.length - 1) { examState.index++; renderExamQuestion(); }
};

function renderExamKeys(){
  const keysDiv = document.getElementById("questionKeys");
  if (!examState) { keysDiv.innerHTML = ""; return; }
  let html = "";
  for (let i = 0; i < examState.questions.length; i++){
    const active = i === examState.index;
    const answered = !!examState.answers[i];
    html += `<div class="qkey ${active ? "active":""} ${answered ? "answered":""}" onclick="examJump(${i})">${i+1}</div>`;
  }
  keysDiv.innerHTML = html;
}
function examJump(i){ if (!examState) return; examState.index = i; renderExamQuestion(); }

/* Timer */
function startExamTimer(){
  stopExamTimer();
  updateTimerLabel();
  examInterval = setInterval(() => {
    examState.durationSec--;
    updateTimerLabel();
    if (examState.durationSec <= 0) {
      stopExamTimer();
      document.getElementById("examMsg").textContent = "Time is up — auto-submitting...";
      setTimeout(() => finalizeExam(true), 700);
    }
  }, 1000);
}
function stopExamTimer(){ if (examInterval) clearInterval(examInterval); examInterval = null; }
function updateTimerLabel(){
  const el = document.getElementById("examTimer");
  if (!examState) { el.textContent = "--:--"; return; }
  const s = Math.max(0, examState.durationSec);
  const mm = Math.floor(s/60).toString().padStart(2,"0");
  const ss = Math.floor(s%60).toString().padStart(2,"0");
  el.textContent = `${mm}:${ss}`;
}

/* Submit (with confirmation and review unanswered) */
document.getElementById("btnSubmitExam").onclick = () => {
  if (!examState) return;
  if (!confirm("Are you sure you want to submit?")) return;
  finalizeExam(false);
};

async function finalizeExam(isAuto=false){
  if (!examState) return;
  const subj = db.subjects.find(s => s.id == examState.subjectId);
  const marksPerQ = subj ? (Number(subj.marksPerQuestion) || 1) : 1;
  let score = 0, totalMarks = 0;
  examState.questions.forEach((q, idx) => {
    totalMarks += marksPerQ;
    if (examState.answers[idx] && examState.answers[idx] === q.correct) score += marksPerQ;
  });

  db.scores.push({
    studentId: currentUser.id,
    subjectId: examState.subjectId,
    subject: examState.subjectName,
    score,
    totalMarks,
    answers: examState.answers // <-- Now saves the answers
  });
  await saveDB();

  stopExamTimer();
  examState = null;
  document.getElementById("examCard").classList.add("hidden");
  prepareStudentSubjectDropdown();
  renderResults();

  document.getElementById("studentMsg").textContent = "Your exam has been submitted successfully. The administrator will view your score.";
  alert("Your exam has been submitted successfully.");
}

/* Show detailed answer sheet */
function showStudentAnswers(studentId, subjectId) {
  const scoreData = db.scores.find(s => s.studentId === studentId && s.subjectId === subjectId);
  if (!scoreData) return alert("Score data not found.");

  const student = db.students.find(s => s.id === studentId);
  if (!student) return alert("Student not found.");

  const questions = db.questions.filter(q => q.subjectId === subjectId);
  const contentEl = document.getElementById("answerSheetContent");
  contentEl.innerHTML = ""; // Clear previous content

  let html = `
    <p><strong>Student:</strong> ${escapeHtml(student.name)} (${escapeHtml(student.class)})</p>
    <p><strong>Subject:</strong> ${escapeHtml(scoreData.subject)}</p>
    <p><strong>Score:</strong> ${scoreData.score} / ${scoreData.totalMarks}</p>
    <hr style="margin:20px 0"/>
  `;

  questions.forEach((q, index) => {
    const studentAnswer = scoreData.answers[index];
    const isCorrect = studentAnswer === q.correct;
    const resultText = isCorrect ? '<span style="color:green;font-weight:bold;">Correct</span>' : `<span style="color:red;font-weight:bold;">Incorrect</span>`;
    const studentSelection = studentAnswer ? `Your Answer: <strong>${studentAnswer}</strong>` : 'Unanswered';

    html += `
      <div style="margin-bottom: 20px;">
        <p><strong>Q${index + 1}:</strong> ${escapeHtml(q.question)}</p>
        <p>${studentSelection} (${resultText})</p>
        <p>Correct Answer: <strong>${q.correct}</strong></p>
        <p style="font-size:14px;color:#666;">A: ${escapeHtml(q.A)} | B: ${escapeHtml(q.B)} | C: ${escapeHtml(q.C)}</p>
      </div>
    `;
  });

  contentEl.innerHTML = html;
  
  // Show the new card and hide the admin dashboard
  document.getElementById("adminCard").classList.add("hidden");
  document.getElementById("answerSheetCard").classList.remove("hidden");
  document.getElementById("answerSheetHeader").textContent = `Answer Sheet for ${escapeHtml(student.name)}`;
}

document.getElementById("btnCloseAnswerSheet").onclick = () => {
  document.getElementById("answerSheetCard").classList.add("hidden");
  document.getElementById("adminCard").classList.remove("hidden");
};


/* ---------------------------
   Render / Init helpers
   --------------------------- */
function renderAllAdmin(){
  refreshClassFilters();
  refreshQuestionFilterSubjects();
  refreshQuestionAddSubjects();
  refreshResetSubjectDropdown();
  renderSubjects();
  renderQuestions();
  renderStudents();
  renderResults();
}
async function renderAllForStartup(){
  await loadDB();
  renderAllAdmin();
  prepareStudentSubjectDropdown();
}

/* initial demo data if empty (optional) */
(async function seedIfEmpty(){
  await loadDB(); 
  if (db.subjects.length || db.questions.length || db.students.length) return;
  
  const s1 = uid(); const s2 = uid();
  db.subjects.push({ id: s1, name: "Mathematics", class: "JSS1", duration: 5, marksPerQuestion: 1 });
  db.subjects.push({ id: s2, name: "English Language", class: "JSS1", duration: 5, marksPerQuestion: 1 });
  db.questions.push({ id: uid(), subjectId: s1, question: "What is 2 + 2?", A:"3", B:"4", C:"5", correct:"B" });
  db.questions.push({ id: uid(), subjectId: s1, question: "What is 3 + 1?", A:"4", B:"2", C:"5", correct:"A" });
  db.students.push({ id: uid(), username: "stud1", name: "John Doe", class: "JSS1", password: "1234" });
  db.students.push({ id: uid(), username: "stud2", name: "Jane Doe", class: "JSS1", password: "1234" });
  db.subjects.push({ id: uid(), name: "Physics", class: "SSS1", duration: 5, marksPerQuestion: 2 });
  db.subjects.push({ id: uid(), name: "Chemistry", class: "SSS1", duration: 5, marksPerQuestion: 2 });
  db.questions.push({ id: uid(), subjectId: uid(), question: "What is H2O?", A:"Water", B:"Oxygen", C:"Hydrogen", correct:"A" });
  await saveDB();
})();

renderAllForStartup();

/* expose some functions for inline handlers (used above) */
window.editSubject = editSubject;
window.deleteSubject = deleteSubject;
window.editQuestion = editQuestion;
window.deleteQuestion = deleteQuestion;
window.editStudent = editStudent;
window.deleteStudent = deleteStudent;
window.examJump = examJump;
window.studentSelect = studentSelect;
window.resetScore = resetScore;
window.showStudentAnswers = showStudentAnswers;
</script>
</body>
</html>
